<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>dss-powersim</title>
  <meta name="description" content="This is a tutorial for power simulation" />
  <meta name="generator" content="bookdown #bookdown:version# and GitBook 2.6.7" />

  <meta property="og:title" content="dss-powersim" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a tutorial for power simulation" />
  <meta name="github-repo" content="hlmshtj-dan/Simulation-Power" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="dss-powersim" />
  
  <meta name="twitter:description" content="This is a tutorial for power simulation" />
  

<meta name="author" content="" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#simulation-based-power-analysis" id="toc-simulation-based-power-analysis">Simulation-Based Power Analysis</a>
<ul>
<li><a href="#table-of-contents" id="toc-table-of-contents">Table of Contents</a></li>
<li><a href="#contributors" id="toc-contributors">Contributors</a></li>
</ul></li>
<li><a href="#part-concepts" id="toc-part-concepts">(PART) Concepts</a></li>
<li><a href="#power-analysis" id="toc-power-analysis"><span class="toc-section-number">1</span> Power Analysis</a>
<ul>
<li><a href="#canned-routines" id="toc-canned-routines"><span class="toc-section-number">1.1</span> Canned routines</a></li>
<li><a href="#step-by-step" id="toc-step-by-step"><span class="toc-section-number">1.2</span> Step by step</a></li>
</ul></li>
<li><a href="#simulation" id="toc-simulation"><span class="toc-section-number">2</span> Simulation</a>
<ul>
<li><a href="#customization" id="toc-customization"><span class="toc-section-number">2.1</span> Customization</a></li>
<li><a href="#step-by-step-1" id="toc-step-by-step-1"><span class="toc-section-number">2.2</span> Step by step</a></li>
</ul></li>
<li><a href="#part-preparation" id="toc-part-preparation">(PART) Preparation</a></li>
<li><a href="#power-of-what" id="toc-power-of-what"><span class="toc-section-number">3</span> Power of What?</a>
<ul>
<li><a href="#study-design" id="toc-study-design"><span class="toc-section-number">3.1</span> Study design</a></li>
<li><a href="#mixed-effects-model" id="toc-mixed-effects-model"><span class="toc-section-number">3.2</span> Mixed effects model</a>
<ul>
<li><a href="#step-1-model-specification" id="toc-step-1-model-specification"><span class="toc-section-number">3.2.1</span> Step 1: model specification</a></li>
<li><a href="#step-2-variable-composition" id="toc-step-2-variable-composition"><span class="toc-section-number">3.2.2</span> Step 2: Variable composition</a></li>
<li><a href="#step-3-parameter-composition" id="toc-step-3-parameter-composition"><span class="toc-section-number">3.2.3</span> Step 3: Parameter composition</a></li>
</ul></li>
</ul></li>
<li><a href="#part-implementation" id="toc-part-implementation">(PART) Implementation</a></li>
<li><a href="#r" id="toc-r"><span class="toc-section-number">4</span> R</a>
<ul>
<li><a href="#setup" id="toc-setup"><span class="toc-section-number">4.1</span> Setup</a></li>
<li><a href="#data-simulation-step-by-step" id="toc-data-simulation-step-by-step"><span class="toc-section-number">4.2</span> Data simulation step by step</a>
<ul>
<li><a href="#establish-the-simulation-parameters" id="toc-establish-the-simulation-parameters"><span class="toc-section-number">4.2.1</span> Establish the simulation parameters</a></li>
<li><a href="#establish-the-data-generating-parameters" id="toc-establish-the-data-generating-parameters"><span class="toc-section-number">4.2.2</span> Establish the data-generating parameters</a></li>
<li><a href="#simulate-the-sampling-process" id="toc-simulate-the-sampling-process"><span class="toc-section-number">4.2.3</span> Simulate the sampling process</a></li>
<li><a href="#analyze-the-simulated-data" id="toc-analyze-the-simulated-data"><span class="toc-section-number">4.2.4</span> Analyze the simulated data</a></li>
</ul></li>
<li><a href="#data-simulation-automated" id="toc-data-simulation-automated"><span class="toc-section-number">4.3</span> Data simulation automated</a></li>
<li><a href="#power-calculation-single-run" id="toc-power-calculation-single-run"><span class="toc-section-number">4.4</span> Power calculation single run</a></li>
<li><a href="#power-calculation-automated" id="toc-power-calculation-automated"><span class="toc-section-number">4.5</span> Power calculation automated</a>
<ul>
<li><a href="#check-false-positive-rate" id="toc-check-false-positive-rate"><span class="toc-section-number">4.5.1</span> Check false positive rate</a></li>
</ul></li>
<li><a href="#power-for-different-effect-sizes" id="toc-power-for-different-effect-sizes"><span class="toc-section-number">4.6</span> Power for different effect sizes</a></li>
</ul></li>
<li><a href="#python" id="toc-python"><span class="toc-section-number">5</span> Python</a>
<ul>
<li><a href="#setup-1" id="toc-setup-1"><span class="toc-section-number">5.1</span> Setup</a></li>
<li><a href="#data-simulation-step-by-step-1" id="toc-data-simulation-step-by-step-1"><span class="toc-section-number">5.2</span> Data simulation step by step</a>
<ul>
<li><a href="#establish-the-simulation-parameters-1" id="toc-establish-the-simulation-parameters-1"><span class="toc-section-number">5.2.1</span> Establish the simulation parameters</a></li>
<li><a href="#establish-the-data-generating-parameters-1" id="toc-establish-the-data-generating-parameters-1"><span class="toc-section-number">5.2.2</span> Establish the data-generating parameters</a></li>
<li><a href="#simulate-the-sampling-process-1" id="toc-simulate-the-sampling-process-1"><span class="toc-section-number">5.2.3</span> Simulate the sampling process</a></li>
<li><a href="#analyze-the-simulated-data-1" id="toc-analyze-the-simulated-data-1"><span class="toc-section-number">5.2.4</span> Analyze the simulated data</a></li>
</ul></li>
<li><a href="#data-simulation-automated-1" id="toc-data-simulation-automated-1"><span class="toc-section-number">5.3</span> Data simulation automated</a></li>
<li><a href="#power-calculation-single-run-1" id="toc-power-calculation-single-run-1"><span class="toc-section-number">5.4</span> Power calculation single run</a></li>
<li><a href="#power-calculation-automated-1" id="toc-power-calculation-automated-1"><span class="toc-section-number">5.5</span> Power calculation automated</a>
<ul>
<li><a href="#check-false-positive-rate-1" id="toc-check-false-positive-rate-1"><span class="toc-section-number">5.5.1</span> Check false positive rate</a></li>
</ul></li>
<li><a href="#power-for-different-effect-sizes-1" id="toc-power-for-different-effect-sizes-1"><span class="toc-section-number">5.6</span> Power for different effect sizes</a></li>
</ul></li>
<li><a href="#stata" id="toc-stata"><span class="toc-section-number">6</span> Stata</a>
<ul>
<li><a href="#setup-2" id="toc-setup-2"><span class="toc-section-number">6.1</span> Setup</a></li>
<li><a href="#data-simulation-step-by-step-2" id="toc-data-simulation-step-by-step-2"><span class="toc-section-number">6.2</span> Data simulation step by step</a>
<ul>
<li><a href="#establish-the-data-generating-parameters-2" id="toc-establish-the-data-generating-parameters-2"><span class="toc-section-number">6.2.1</span> Establish the data-generating parameters</a></li>
<li><a href="#simulate-the-sampling-process-2" id="toc-simulate-the-sampling-process-2"><span class="toc-section-number">6.2.2</span> Simulate the sampling process</a></li>
<li><a href="#analyze-the-simulated-data-2" id="toc-analyze-the-simulated-data-2"><span class="toc-section-number">6.2.3</span> Analyze the simulated data</a></li>
</ul></li>
<li><a href="#data-simulation-automated-2" id="toc-data-simulation-automated-2"><span class="toc-section-number">6.3</span> Data simulation automated</a></li>
<li><a href="#power-calculation-single-run-2" id="toc-power-calculation-single-run-2"><span class="toc-section-number">6.4</span> Power calculation single run</a></li>
<li><a href="#power-calculation-automated-2" id="toc-power-calculation-automated-2"><span class="toc-section-number">6.5</span> Power calculation automated</a>
<ul>
<li><a href="#check-false-positive-rate-2" id="toc-check-false-positive-rate-2"><span class="toc-section-number">6.5.1</span> Check false positive rate</a></li>
</ul></li>
<li><a href="#power-for-different-effect-sizes-2" id="toc-power-for-different-effect-sizes-2"><span class="toc-section-number">6.6</span> Power for different effect sizes</a></li>
</ul></li>
<li><a href="#part-appendix" id="toc-part-appendix">(PART) Appendix</a></li>
<li><a href="#software-comparison" id="toc-software-comparison"><span class="toc-section-number">7</span> Software Comparison</a></li>
<li><a href="#resources" id="toc-resources">Resources</a>
<ul>
<li><a href="#r-1" id="toc-r-1">R</a></li>
<li><a href="#stata-1" id="toc-stata-1">Stata</a></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="simulation-based-power-analysis" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">Simulation-Based Power Analysis<a href="#simulation-based-power-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This tutorial is designed to be a quick-start guide for conducting simulation-based power analyses in R, Python, and Stata. We focus particularly on power for mixed effects models, but the principles employed can be repurposed for any model and study design. The tutorial is suitable for anyone with a intermediate understanding of mixed effects models and coding in either R, Python, or Stata.</p>
<p>While high-level packages exist in some of these languages for conducting simulation-based power analysis (e.g., the R packages <a href="https://cran.r-project.org/web/packages/simr/vignettes/fromscratch.html"><code>{simr}</code></a>, <a href="https://cran.r-project.org/web/packages/longpower/vignettes/longpower.html"><code>{longpower}</code></a>, and <a href="https://cran.r-project.org/web/packages/simglm/vignettes/tidy_simulation.html"><code>{simglm}</code></a>), such packages abstract away the details of conducting simulations and thus are best used after gaining an understanding of the power simulation process. In addition, rolling your own simulations from scratch provides much more flexibility to tackle different study designs and models - and it’s fun!</p>
<p>We are always grateful for any feedback you are willing to provide about our tutorials! Please email <a href="mailto:help@iq.harvard.edu" class="email">help@iq.harvard.edu</a> with any thoughts.</p>
<div id="table-of-contents" class="section level2 unnumbered hasAnchor">
<h2 class="unnumbered hasAnchor">Table of Contents<a href="#table-of-contents" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li><a href="./power-analysis.html">Canned Power Analysis</a></li>
<li><a href="./simulation.html">Simulation-based Power Analysis</a></li>
<li><a href="./power-of-what.html">Power of What?</a></li>
<li><a href="./r.html">R Examples</a></li>
<li><a href="./python.html">Python Examples</a></li>
<li><a href="./stata.html">Stata Examples</a></li>
<li><a href="./software-comparison.html">Software Comparison</a></li>
<li><a href="./resources.html">Resources</a></li>
</ol>
<p><br />
</p>
<p><img src="images/Ultimate_Power_Vol_1_5_Textless.png" /></p>
</div>
<div id="contributors" class="section level2 unnumbered hasAnchor">
<h2 class="unnumbered hasAnchor">Contributors<a href="#contributors" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The contents of these workshops are the result of a collaborative effort from members of the <a href="http://dss.iq.harvard.edu">Data Science Services</a> team at the Institute for Quantitative Social Science at Harvard University. The main contributors are Steve Worthington and Dan Yuan, with additional feedback from Jinjie Liu and Noah Greifer.</p>
<!--chapter:end:index.Rmd-->
</div>
</div>
<div id="part-concepts" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">(PART) Concepts<a href="#part-concepts" class="anchor-section" aria-label="Anchor link to header"></a></h1>
</div>
<div id="power-analysis" class="section level1 hasAnchor" number="1">
<h1 class="hasAnchor"><span class="header-section-number">1</span> Power Analysis<a href="#power-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="alert alert-success">
<p>Statistical power is the probability of rejecting a null hypothesis when it is false, or equivalently, of detecting an effect if such an effect exists.</p>
</div>
<div id="canned-routines" class="section level2 hasAnchor" number="1.1">
<h2 class="hasAnchor"><span class="header-section-number">1.1</span> Canned routines<a href="#canned-routines" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For some studies, it can be an important step to calculate <em>a priori</em> statistical power. We use statistical power to determine the probability of rejecting a null hypothesis when it is false, or equivalently, of detecting an effect if such an effect exists.</p>
<p><span class="math display">\[
\begin{align}
\textrm{Power} &amp;= \textrm{Pr}(\textrm{reject} \, H_0 \, | \, H_0 \, \textrm{is false}) \\
               &amp;= 1 - \textrm{Pr}(\textrm{fail to reject} \, H_0 \, | \, H_0 \, \textrm{is false}) \\
               &amp;= 1 - \beta
\end{align}
\]</span></p>
<p>We want <span class="math inline">\(\beta\)</span> (Type II error) to be small and power to be large. When designing a study, rather than calculating power when sample size and effect size are fixed, researchers typically want to know the sample size required to reject a null hypothesis at a given level of power and effect size.</p>
<p>In some situations, where the study design and/or model of interest is fairly simple, we can use a formula to calculate the sample size required to reject a null hypothesis. We will use a simple example to show the process involved. For instance, if we plan to perform a test of an hypothesis comparing the cholesterol levels of people in two populations, one with a diet comprising low oat consumption and the other with high oat consumption, we could specify the following null and alternative hypotheses, respectively:</p>
<p><span class="math display">\[
\begin{align}
\textrm{H}_0 : \mu_1 - \mu_2 &amp;= 0 \\
\textrm{H}_1 : \mu_1 - \mu_2 &amp;\neq 0
\end{align}
\]</span></p>
<p>where <span class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\mu_2\)</span> are the mean cholesterol levels in the two populations being compared. We can use a formula to determine the sample sizes required so that the test has a specific power. We will need the following inputs to the formula:</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(\alpha\)</span> (Type I error / significance level): typically, this is set to <span class="math inline">\(0.05\)</span> in most studies.</li>
<li><span class="math inline">\(1 - \beta\)</span> (power): often this is set to <span class="math inline">\(0.8\)</span> or <span class="math inline">\(0.9\)</span>.</li>
<li><span class="math inline">\(\sigma\)</span> (population standard deviation): we need to estimate/guess this.</li>
<li><span class="math inline">\(\delta\)</span> (alternative hypothesis): ideally the smallest difference <span class="math inline">\(\delta = \mu_1 - \mu_2\)</span> that has scientific or clinical importance.</li>
</ol>
<p>Given <span class="math inline">\(\alpha\)</span>, <span class="math inline">\((1 - \beta)\)</span>, <span class="math inline">\(\sigma\)</span>, and <span class="math inline">\(\delta\)</span>, we can calculate <span class="math inline">\(n_g\)</span> the sample size in each group to reject <span class="math inline">\(\textrm{H}_0\)</span> with probability <span class="math inline">\((1 - \beta)\)</span>. To simplify things a little, we will use the normal distribution as an approximation to the <span class="math inline">\(t\)</span> distribution (which should be fine when <span class="math inline">\(n_g \geq 30\)</span>). Here is the formula for this approximate two-sample <span class="math inline">\(t\)</span>-test:</p>
<p><span class="math display">\[
n_g \approx 2(z_{\alpha / 2} + z_\beta)^2 \left( \frac{\sigma}{\delta} \right)^2
\]</span></p>
<p>where <span class="math inline">\(n_g\)</span> is the sample size required in each group, <span class="math inline">\(z_{\alpha/2}\)</span> is the value from the standard normal distribution holding half the selected <span class="math inline">\(\alpha\)</span> level below it (because this is a two-tailed test), <span class="math inline">\(z_\beta\)</span> is the value from the standard normal distribution holding the <span class="math inline">\(\beta\)</span> level below it, <span class="math inline">\(\delta\)</span> is the effect size (the difference in population averages <span class="math inline">\(\mu_1 - \mu_2\)</span> of cholesterol), and <span class="math inline">\(\sigma\)</span> is the pooled population standard deviation (during study planning we usually assume equal variances in the two groups). Typically, we would set <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> to the following values and rely on previous studies or pilot data to obtain reasonable values for <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\delta\)</span>:</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(\alpha = 0.05\)</span>, so <span class="math inline">\(z_{\alpha / 2} = 1.960\)</span>.</li>
<li><span class="math inline">\(1 - \beta = 0.8\)</span>, so <span class="math inline">\(\beta = 0.2\)</span>, so <span class="math inline">\(z_\beta = 0.8416\)</span>.</li>
<li><span class="math inline">\(\sigma = 1\)</span>; this could be our best guess based on previous studies.</li>
<li><span class="math inline">\(\delta = 0.7\)</span>, our best guess based on previous studies could be that mean differences of 0.7 mmol/L or greater should be considered biologically important.</li>
</ol>
<p>We can then plug these input values into our formula:</p>
<p><span class="math display">\[
n_g \approx 2(1.960 + 0.8416)^2 \left( \frac{1}{0.7} \right)^2 = 32.036
\]</span></p>
<p>We always round up to a whole number for sample size, so for this study we need 33 subjects per group, or <span class="math inline">\(n=66\)</span> in total.</p>
<p>In practice, we will often rely on software to perform the above calculation for us. In R we can use the <code>power.t.test()</code> function from the built-in <code>{stats}</code> package to calculate the sample size needed to reject the null hypothesis that <span class="math inline">\(\textrm{H}_0 : \mu_1 - \mu_2 = 0\)</span>. We just need to pass the <span class="math inline">\(n\)</span> parameter as <code>NULL</code> to tell R that we’d like to calculate sample size based on the values of the other parameters:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">power.t.test</span>(<span class="at">n=</span><span class="cn">NULL</span>, <span class="at">delta=</span><span class="fl">0.7</span>, <span class="at">sd=</span><span class="dv">1</span>, <span class="at">sig.level=</span><span class="fl">0.05</span>, <span class="at">power=</span><span class="fl">0.8</span>, <span class="at">alternative=</span><span class="st">&quot;two.sided&quot;</span>)</span></code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 33.02467
##           delta = 0.7
##              sd = 1
##       sig.level = 0.05
##           power = 0.8
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
</div>
<div id="step-by-step" class="section level2 hasAnchor" number="1.2">
<h2 class="hasAnchor"><span class="header-section-number">1.2</span> Step by step<a href="#step-by-step" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here are the general set of steps required to implement a power analysis for most study designs:</p>
<p><strong>1. Specify a hypothesis test.</strong></p>
<p>Make explicit a null and alternative hypothesis.</p>
<p><strong>2. Specify Type I and Type II error levels for the test.</strong></p>
<p>Typically, the Type I error level (significance level / false positive level) is set to <span class="math inline">\(\alpha=0.05\)</span> and Type II error level (false negative level) <span class="math inline">\(\beta=0.2\)</span>, which yields a power level of <span class="math inline">\(1 - \beta = 0.8\)</span>, but other values could be substituted instead.</p>
<p><strong>3. Specify the estimated effect size level for the test.</strong></p>
<p>To solve for sample size <span class="math inline">\(n\)</span>, we need an estimate of effect size (<span class="math inline">\(\delta = \mu_1 - \mu_2\)</span>) that has scientific meaning. Sometimes we need to use a pilot dataset or look to previous studies to get this value.</p>
<p><strong>4. Calculate the sample size required to obtain the power level desired.</strong></p>
<p>This can either be done by pugging and chugging values into the relevant formula, or by using a software-based implementation of said formula.</p>
<!--chapter:end:01_canned.Rmd-->
</div>
</div>
<div id="simulation" class="section level1 hasAnchor" number="2">
<h1 class="hasAnchor"><span class="header-section-number">2</span> Simulation<a href="#simulation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="customization" class="section level2 hasAnchor" number="2.1">
<h2 class="hasAnchor"><span class="header-section-number">2.1</span> Customization<a href="#customization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Formulas often do not exist to calculate power for the effect of interest and therefore canned functions/programs/macros may not be available. For some studies, such as those involving complex study designs or those using mixed effects models for inference, we must therefore rely on simulation to provide a means of generating estimates of power that are customized for our current situation.</p>
<p>The basic idea is to simulate running our study many times and calculate the proportion of times we reject the null hypothesis. This proportion provides an estimate of power. Generating a dataset and running an analysis for the hypothesis test is part of the simulation. Randomness is introduced into the process during dataset generation.</p>
<p>For example, say the desired power level is 90%, and you want to calculate the sample size required to obtain this level of power. We could use the “guess sample size and check power” method. Firstly, choose a sample size <span class="math inline">\(n_1\)</span> and run the simulation to estimate power. If power is estimated to be lower than 90%, select a new value <span class="math inline">\(n_2\)</span> that is larger than <span class="math inline">\(n_1\)</span> and run the simulation again. Simulation runs are repeated until the estimated power is roughly 90%.</p>
</div>
<div id="step-by-step-1" class="section level2 hasAnchor" number="2.2">
<h2 class="hasAnchor"><span class="header-section-number">2.2</span> Step by step<a href="#step-by-step-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are two broad steps involved in conducting simulation-based power analysis: 1) thinking and, 2) implementing.</p>
<ul>
<li>Think
<ol style="list-style-type: decimal">
<li><strong>Model specification:</strong> Write down the regression model, including all variables and parameters of interest.</li>
<li><strong>Variable composition:</strong> Specify the form of the explanatory variables, such as the range of age or BMI, proportion of females/males, or the coding scheme used for categorical terms.</li>
<li><strong>Parameter composition:</strong> Establish reasonable values for the data-generating parameters in your model.</li>
</ol></li>
<li>Implement
<ol start="4" style="list-style-type: decimal">
<li><strong>Simulate:</strong> Simulate the sampling process for a single dataset, assuming the alternative hypothesis, and fit the model of interest.</li>
<li><strong>Automate:</strong> Write a function/program/macro to automate the process of creating datasets, fitting models, testing the hypothesis of interest, and calculating power for that test - the number of significant simulations out of the total number of simulations. The function/program/macro should be flexible enough to allow for iterating power calculations over a grid of different parameter values.</li>
<li><strong>Summarize:</strong> Summarize the relationships between power, sample size, and effect size in tables and figures.</li>
</ol></li>
</ul>
<p>The implementation phase can be summarized by the following graphic:</p>
<p><img src="images/powersim.png" /></p>
<!--chapter:end:02_simulation.Rmd-->
</div>
</div>
<div id="part-preparation" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">(PART) Preparation<a href="#part-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
</div>
<div id="power-of-what" class="section level1 hasAnchor" number="3">
<h1 class="hasAnchor"><span class="header-section-number">3</span> Power of What?<a href="#power-of-what" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The initial steps of power simulation involve nothing more than thinking and writing down your thoughts using a pencil and paper. But, prior to walking through these steps, there is an even more fundamental issue to be addressed - the power of what?</p>
<p>What quantity within our model do we wish to calculate power for? Overall model goodness-of-fit, individual parameters, or combinations of parameters? The point of entry for power analysis is always to identify the particular effect of interest, and for that we must answer the question: “power of what?”</p>
<div id="study-design" class="section level2 hasAnchor" number="3.1">
<h2 class="hasAnchor"><span class="header-section-number">3.1</span> Study design<a href="#study-design" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The study design we will use as an example throughout this tutorial comes from Julian Quandt’s blogpost (<a href="https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iv/" class="uri">https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iv/</a>). He describes this as:</p>
<blockquote>
<p>A new hypothetical research question focused on music preference. The overarching research goal will be to find out whether Rock or Pop music is better. Of course, we could just ask people what they prefer, but we want a more objective measure of what is Rock and Pop (people might have different ideas about the genres). Therefore, we will have participants listen to a bunch of different songs that are either from a Spotify “best-of-pop” or “best-of-rock” playlist and have them rate each song on an evaluation scale from 0-100 points.</p>
</blockquote>
</div>
<div id="mixed-effects-model" class="section level2 hasAnchor" number="3.2">
<h2 class="hasAnchor"><span class="header-section-number">3.2</span> Mixed effects model<a href="#mixed-effects-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Canned routines exist to perform power analysis for some simple general linear models (GLMs), however, for generalized linear mixed effects models (GLMMs) we must rely on simulation. We will walk through the process of simulating data for a GLMM in a step-by-step manner, which will serve as scaffolding to build intuition about how to conduct power simulation. Once we have the workflow down, we can automate the simulation process using functions.</p>
<p>While the outcome in this example is bounded on the interval [0, 100], we will not concern ourselves with the issue of using a linear model with such an outcome.</p>
<div id="step-1-model-specification" class="section level3 hasAnchor" number="3.2.1">
<h3 class="hasAnchor"><span class="header-section-number">3.2.1</span> Step 1: model specification<a href="#step-1-model-specification" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first step in simulation-based power analysis is to write down the regression model of interest, including all variables and parameters:</p>
<p><span class="math display">\[
\textrm{liking}_{ij} = \beta_0 + T_{0j} + O_{0i} + (\beta_1 + T_{1j}) \times \textrm{genre}_i + \epsilon_{ij}
\]</span></p>
<p>where the subscripts <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> denote individual songs and participants, respectively, <code>liking</code> is an integer-based rating of a given song on the interval [0, 100], <code>genre</code> is a dummy coded binary variable indicating whether the song is classified as “rock” or “pop”, and we assume <span class="math inline">\(T_{0j} \sim \mathcal{N}(0, \tau_0)\)</span>, <span class="math inline">\(T_{1j} \sim \mathcal{N}(0, \tau_1)\)</span>, <span class="math inline">\(O_{0i} \sim \mathcal{N}(0, \omega_0)\)</span>, and <span class="math inline">\(\epsilon_{ij} \sim \mathcal{N}(0, \sigma)\)</span>. The parameter of interest is <span class="math inline">\(\beta_1\)</span> - the average (within-subject) difference in the rating of songs between the two genres. Table 3.1 lists all of the variables and parameters in the model.</p>
<table>
<caption>(#tab:param-def) Variables in the data-generating model and associated code-based names.</caption>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="left">code</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\textrm{liking}_{ij}\)</span></td>
<td align="left"><span class="math inline">\(\texttt{liking_ij}\)</span></td>
<td align="left">rating of song <span class="math inline">\(i\)</span> for participant <span class="math inline">\(j\)</span> on the interval [0, 100]</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\textrm{genre}_i\)</span></td>
<td align="left"><span class="math inline">\(\texttt{genre_i}\)</span></td>
<td align="left">genre of song <span class="math inline">\(i\)</span> (0=‘pop’, 1=‘rock’)</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\beta_0\)</span></td>
<td align="left"><span class="math inline">\(\texttt{beta_0}\)</span></td>
<td align="left">intercept; mean of liking rating for ‘pop’ genre</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\beta_1\)</span></td>
<td align="left"><span class="math inline">\(\texttt{beta_1}\)</span></td>
<td align="left">slope; mean difference btw ‘pop’ and ‘rock’ song ratings</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\tau_0\)</span></td>
<td align="left"><span class="math inline">\(\texttt{tau_0}\)</span></td>
<td align="left">standard deviation of by-subject random intercepts</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\tau_1\)</span></td>
<td align="left"><span class="math inline">\(\texttt{tau_1}\)</span></td>
<td align="left">standard deviation of by-subject random slopes</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho\)</span></td>
<td align="left"><span class="math inline">\(\texttt{rho}\)</span></td>
<td align="left">correlation between by-subject random intercepts and slopes</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\omega_0\)</span></td>
<td align="left"><span class="math inline">\(\texttt{omega_0}\)</span></td>
<td align="left">standard deviation of by-song random intercepts</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\sigma\)</span></td>
<td align="left"><span class="math inline">\(\texttt{sigma}\)</span></td>
<td align="left">standard deviation of residuals</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(T_{0j}\)</span></td>
<td align="left"><span class="math inline">\(\texttt{T_0j}\)</span></td>
<td align="left">random intercept for subject <span class="math inline">\(j\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(T_{1j}\)</span></td>
<td align="left"><span class="math inline">\(\texttt{T_1j}\)</span></td>
<td align="left">random slope for subject <span class="math inline">\(j\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(O_{0i}\)</span></td>
<td align="left"><span class="math inline">\(\texttt{O_0i}\)</span></td>
<td align="left">random intercept for song <span class="math inline">\(i\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(e_{ij}\)</span></td>
<td align="left"><span class="math inline">\(\texttt{e_ij}\)</span></td>
<td align="left">residual of song <span class="math inline">\(i\)</span> for participant <span class="math inline">\(j\)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="step-2-variable-composition" class="section level3 hasAnchor" number="3.2.2">
<h3 class="hasAnchor"><span class="header-section-number">3.2.2</span> Step 2: Variable composition<a href="#step-2-variable-composition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Once we have the model equation, we need to specify the details of the explanatory variables. In our model, we only have a single binary predictor, so the only decision to make is which coding scheme to use: dummy coding, zero sum coding, or something else. Here, we chose dummy coding, since our primary interest is in the difference between the “rock” and “pop” genres.</p>
<p>In many other situations, we might include variables such as age and sex in the model. In which case we would need to determine reasonable settings for the range of age and the proportion of females to males. For example, the range of age might encompass the full possible range of human longevity (e.g., 0 to 120 years) or could be more focused on non-retired adults (e.g., 18 to 65 years). The proportion of females to males could theoretically vary anywhere in the interval (0, 1), but practically is rarely outside of the interval [0.45, 0.55].</p>
</div>
<div id="step-3-parameter-composition" class="section level3 hasAnchor" number="3.2.3">
<h3 class="hasAnchor"><span class="header-section-number">3.2.3</span> Step 3: Parameter composition<a href="#step-3-parameter-composition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, we need to establish the data-generating parameters in the model. You may draw on your own, or your colleague’s, substantive expertise about the phenomenom you’re studying to determine what paramater values are plausible. Or, you might look to the literature for studies that examined similar effects. Table 3.2 lists parameter values we will use as a starting point. Later, we will try using some alternative values and compare power for each.</p>
<table>
<caption>(#tab:param-all) Settings for all data-generating parameters.</caption>
<thead>
<tr class="header">
<th align="left">code</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\texttt{beta_0}\)</span></td>
<td align="left">60</td>
<td align="left">intercept; i.e., mean of liking rating for ‘pop’ genre</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\texttt{beta_1}\)</span></td>
<td align="left">5</td>
<td align="left">slope; i.e, mean difference btw ‘pop’ and ‘rock’ song ratings</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\texttt{tau_0}\)</span></td>
<td align="left">7</td>
<td align="left">by-subject random intercept sd</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\texttt{tau_1}\)</span></td>
<td align="left">4</td>
<td align="left">by-subject random slope sd</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\texttt{rho}\)</span></td>
<td align="left">0.2</td>
<td align="left">correlation between intercept and slope</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\texttt{omega_0}\)</span></td>
<td align="left">3</td>
<td align="left">by-song random intercept sd</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\texttt{sigma}\)</span></td>
<td align="left">8</td>
<td align="left">residual (error) sd</td>
</tr>
</tbody>
</table>
<!--chapter:end:03_power_of_what.Rmd-->
</div>
</div>
</div>
<div id="part-implementation" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">(PART) Implementation<a href="#part-implementation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
</div>
<div id="r" class="section level1 hasAnchor" number="4">
<h1 class="hasAnchor"><span class="header-section-number">4</span> R<a href="#r" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="setup" class="section level2 hasAnchor" number="4.1">
<h2 class="hasAnchor"><span class="header-section-number">4.1</span> Setup<a href="#setup" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will need to use several R packages to optimize our workflow and fit
mixed effects models. We can use the <code>p_load()</code> function from the
<code>{pacman}</code> library to automate installing these packages onto our
machine and then load them into our search path.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># uncomment the line below to install the {pacman} library on your computer</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"># install.packages(&quot;pacman&quot;)</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  lme4,         <span class="co"># model specification / estimation</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  lmerTest,     <span class="co"># provides p-values in the model output</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  future,       <span class="co"># parallelization</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  future.apply, <span class="co"># fast automation</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  furrr,        <span class="co"># fast functional programming</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  faux,         <span class="co"># simulate from multivariate normal distribution</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  broom.mixed,  <span class="co"># extracting tidy data from model fits</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  tidyverse,    <span class="co"># data wrangling and visualisation</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  gt            <span class="co"># nice tables</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>  )</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="fu">faux_options</span>(<span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>We will also set the pseudo-random number generator seed to <code>02138</code> to
make the stochastic components of our simulations reproducible.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">02138</span>)</span></code></pre></div>
<p>Finally, let’s take advantage of background parallelization to speed-up
iterative processes.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code></pre></div>
</div>
<div id="data-simulation-step-by-step" class="section level2 hasAnchor" number="4.2">
<h2 class="hasAnchor"><span class="header-section-number">4.2</span> Data simulation step by step<a href="#data-simulation-step-by-step" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To give an overview of the power simulation task, we will simulate data
from a design with crossed random factors of subjects and songs (see
<a href="./power-of-what.html">Power of What?</a> for design details), fit a model
to the simulated data, recover from the model output the parameter
values we put in, calculate power, and finally automate the whole
process so that we can calculate power for different effect sizes. Much
of the general workflow here is borrowed from <a href="https://journals.sagepub.com/doi/full/10.1177/2515245920965119">DeBruine &amp; Dale (2021)
Understanding Mixed-Effects Models through
Simulation</a>.
We’ll start by writing code that simulates datasets under the
alternative hypothesis.</p>
<div id="establish-the-simulation-parameters" class="section level3 hasAnchor" number="4.2.1">
<h3 class="hasAnchor"><span class="header-section-number">4.2.1</span> Establish the simulation parameters<a href="#establish-the-simulation-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before we start, let’s set some global parameters for our power
simulations. Since simulations can take a long time to run, we’ll use
100 replications here as an example, but we recommend increasing this
number to at least 1000 replications for a more accurate final power
calculation.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># number of simulation replicates for power calculation</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>reps <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># specified alpha for power calculation</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span></code></pre></div>
</div>
<div id="establish-the-data-generating-parameters" class="section level3 hasAnchor" number="4.2.2">
<h3 class="hasAnchor"><span class="header-section-number">4.2.2</span> Establish the data-generating parameters<a href="#establish-the-data-generating-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first thing to do is to set up the parameters that govern the
process we assume gave rise to the data - the <em>data-generating process</em>,
or DGP. We previously decided upon the the data-generating parameters
(see <a href="./power-of-what.html">Power of What?</a>), so we just need to code
them here.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># set all data-generating parameters</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>beta_0  <span class="ot">&lt;-</span>  <span class="dv">60</span>   <span class="co"># intercept; i.e., the grand mean</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>beta_1  <span class="ot">&lt;-</span>   <span class="dv">5</span>   <span class="co"># slope; i.e, effect of category</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>omega_0 <span class="ot">&lt;-</span>   <span class="dv">3</span>   <span class="co"># by-song random intercept sd</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>tau_0   <span class="ot">&lt;-</span>   <span class="dv">7</span>   <span class="co"># by-subject random intercept sd</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>tau_1   <span class="ot">&lt;-</span>   <span class="dv">4</span>   <span class="co"># by-subject random slope sd</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>rho     <span class="ot">&lt;-</span>   <span class="fl">0.2</span> <span class="co"># correlation between intercept and slope</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>sigma   <span class="ot">&lt;-</span>   <span class="dv">8</span>   <span class="co"># residual (error) sd</span></span></code></pre></div>
</div>
<div id="simulate-the-sampling-process" class="section level3 hasAnchor" number="4.2.3">
<h3 class="hasAnchor"><span class="header-section-number">4.2.3</span> Simulate the sampling process<a href="#simulate-the-sampling-process" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we will simulate the sampling process for the data. First, let’s
define parameters related to the number of observations.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># set number of subjects and songs</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>n_subj <span class="ot">&lt;-</span>  <span class="dv">25</span> <span class="co"># number of subjects</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>n_pop  <span class="ot">&lt;-</span>  <span class="dv">15</span> <span class="co"># number of songs in pop category</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>n_rock <span class="ot">&lt;-</span>  <span class="dv">15</span> <span class="co"># number of songs in rock category</span></span></code></pre></div>
<div id="simulate-the-sampling-of-songs" class="section level4 hasAnchor" number="4.2.3.1">
<h4 class="hasAnchor"><span class="header-section-number">4.2.3.1</span> Simulate the sampling of songs<a href="#simulate-the-sampling-of-songs" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We need to create a table listing each song <span class="math inline">\(i\)</span>, which category it is in
(<code>rock</code> or <code>pop</code>), and its random effect <span class="math inline">\(O_{0i}\)</span>. The latter is sampled
from a univariate normal distribution using the function <code>rnorm()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># simulate a sample of songs</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>songs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="at">song_id =</span> <span class="fu">seq_len</span>(n_pop <span class="sc">+</span> n_rock),</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="at">category =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;pop&quot;</span>, <span class="st">&quot;rock&quot;</span>), <span class="fu">c</span>(n_pop, n_rock)),</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="at">genre_i =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(n_pop, n_rock)),</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="at">O_0i =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_pop <span class="sc">+</span> n_rock, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> omega_0)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="fu">print</span>(songs, <span class="at">n=</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 30 × 4
##    song_id category genre_i    O_0i
##      &lt;int&gt; &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;
##  1       1 pop            0  0.0930
##  2       2 pop            0 -0.960 
##  3       3 pop            0 -2.40  
##  4       4 pop            0 -5.11  
##  5       5 pop            0  3.64  
##  6       6 pop            0  1.37  
##  7       7 pop            0 -8.10  
##  8       8 pop            0 -0.382 
##  9       9 pop            0 -3.41  
## 10      10 pop            0  5.14  
## # ℹ 20 more rows</code></pre>
</div>
<div id="simulate-the-sampling-of-subjects" class="section level4 hasAnchor" number="4.2.3.2">
<h4 class="hasAnchor"><span class="header-section-number">4.2.3.2</span> Simulate the sampling of subjects<a href="#simulate-the-sampling-of-subjects" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now we simulate the sampling of participants, which results in table
listing each individual and their two correlated random effects (a
random intercept and random slope). To do this, we must sample
<span class="math inline">\({T_{0j}, T_{1j}}\)</span> pairs - one for each subject - from a bivariate
normal distribution.</p>
<p>We will use the function <code>faux::rnorm_multi()</code>, which generates a table
of <code>n</code> simulated values from a multivariate normal distribution by
specifying the means (<code>mu</code>) and standard deviations (<code>sd</code>) of each
variable, plus the correlations (<code>r</code>), which can be either a single
value (applied to all pairs), a correlation matrix, or a vector of the
values in the upper right triangle of the correlation matrix.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># simulate a sample of subjects</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co"># sample from a multivariate normal distribution</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>subjects <span class="ot">&lt;-</span> faux<span class="sc">::</span><span class="fu">rnorm_multi</span>(</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="at">n =</span> n_subj,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    <span class="at">mu =</span> <span class="dv">0</span>, <span class="co"># means for random effects are always 0</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">c</span>(tau_0, tau_1), <span class="co"># set SDs</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="at">r =</span> rho, <span class="co"># set correlation</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    <span class="at">varnames =</span> <span class="fu">c</span>(<span class="st">&quot;T_0j&quot;</span>, <span class="st">&quot;T_1j&quot;</span>)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">subj_id =</span> <span class="fu">seq_len</span>(n_subj)) <span class="sc">|&gt;</span> <span class="co"># add subject IDs</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="fu">print</span>(subjects, <span class="at">n=</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 25 × 3
##       T_0j   T_1j subj_id
##      &lt;dbl&gt;  &lt;dbl&gt;   &lt;int&gt;
##  1  -2.33   0.169       1
##  2   0.396  1.96        2
##  3  -8.48   0.716       3
##  4 -13.8   -5.05        4
##  5  -3.51  -1.16        5
##  6  -2.12  -4.99        6
##  7   9.44   7.00        7
##  8   3.96   3.05        8
##  9 -11.5   -3.29        9
## 10   4.76  -5.68       10
## # ℹ 15 more rows</code></pre>
</div>
<div id="check-the-simulated-values" class="section level4 hasAnchor" number="4.2.3.3">
<h4 class="hasAnchor"><span class="header-section-number">4.2.3.3</span> Check the simulated values<a href="#check-the-simulated-values" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s do a quick sanity check by comparing our simulated values to the
parameters we used as inputs. Because the sampling process is
stochastic, we shouldn’t expect that these will exactly match for any
given run of the simulation.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="at">parameter =</span> <span class="fu">c</span>(<span class="st">&quot;omega_0&quot;</span>, <span class="st">&quot;tau_0&quot;</span>, <span class="st">&quot;tau_1&quot;</span>, <span class="st">&quot;rho&quot;</span>),</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(omega_0, tau_0, tau_1, rho),</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="at">simulated =</span> <span class="fu">c</span>(</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="fu">sd</span>(songs<span class="sc">$</span>O_0i),</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="fu">sd</span>(subjects<span class="sc">$</span>T_0j),</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="fu">sd</span>(subjects<span class="sc">$</span>T_1j),</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="fu">cor</span>(subjects<span class="sc">$</span>T_0j, subjects<span class="sc">$</span>T_1j)</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  )</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## # A tibble: 4 × 3
##   parameter value simulated
##   &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 omega_0     3       3.00 
## 2 tau_0       7       7.87 
## 3 tau_1       4       4.05 
## 4 rho         0.2     0.495</code></pre>
</div>
<div id="simulate-trials" class="section level4 hasAnchor" number="4.2.3.4">
<h4 class="hasAnchor"><span class="header-section-number">4.2.3.4</span> Simulate trials<a href="#simulate-trials" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Since all subjects rate all songs (i.e., the design is fully crossed) we
can set up a table of trials by including every possible combination of
the rows in the <code>subjects</code> and <code>songs</code> tables. Each trial has random
error associated with it, reflecting fluctuations in trial-by-trial
ratings due to unknown factors. We simulate this by sampling values from
a univariate normal distribution with a mean of 0 and a standard
deviation of <code>sigma</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># cross subject and song IDs; add an error term</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="fu">crossing</span>(subjects, songs) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_ij =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma))</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="fu">print</span>(trials, <span class="at">n=</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 750 × 8
##     T_0j   T_1j subj_id song_id category genre_i    O_0i  e_ij
##    &lt;dbl&gt;  &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
##  1 -14.2 -0.797      11       1 pop            0  0.0930 -2.07
##  2 -14.2 -0.797      11       2 pop            0 -0.960   5.46
##  3 -14.2 -0.797      11       3 pop            0 -2.40    5.79
##  4 -14.2 -0.797      11       4 pop            0 -5.11   -2.02
##  5 -14.2 -0.797      11       5 pop            0  3.64   16.5 
##  6 -14.2 -0.797      11       6 pop            0  1.37    3.92
##  7 -14.2 -0.797      11       7 pop            0 -8.10   11.9 
##  8 -14.2 -0.797      11       8 pop            0 -0.382  -6.91
##  9 -14.2 -0.797      11       9 pop            0 -3.41   -6.68
## 10 -14.2 -0.797      11      10 pop            0  5.14   -2.11
## # ℹ 740 more rows</code></pre>
</div>
<div id="calculate-response-values" class="section level4 hasAnchor" number="4.2.3.5">
<h4 class="hasAnchor"><span class="header-section-number">4.2.3.5</span> Calculate response values<a href="#calculate-response-values" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>With this resulting <code>trials</code> table, in combination with the constants
<code>beta_0</code> and <code>beta_1</code>, we have the full set of values that we need to
compute the response variable <code>liking_ij</code> according the linear model we
defined previously (see <a href="./power-of-what.html">Power of What?</a>).</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>dat_sim <span class="ot">&lt;-</span> trials <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">liking_ij =</span> beta_0 <span class="sc">+</span> T_0j <span class="sc">+</span> O_0i <span class="sc">+</span> (beta_1 <span class="sc">+</span> T_1j) <span class="sc">*</span> genre_i <span class="sc">+</span> e_ij) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="fu">select</span>(subj_id, song_id, category, genre_i, liking_ij)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="fu">print</span>(dat_sim, <span class="at">n=</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 750 × 5
##    subj_id song_id category genre_i liking_ij
##      &lt;int&gt;   &lt;int&gt; &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;
##  1      11       1 pop            0      43.8
##  2      11       2 pop            0      50.3
##  3      11       3 pop            0      49.2
##  4      11       4 pop            0      38.7
##  5      11       5 pop            0      66.0
##  6      11       6 pop            0      51.1
##  7      11       7 pop            0      49.7
##  8      11       8 pop            0      38.5
##  9      11       9 pop            0      35.7
## 10      11      10 pop            0      48.8
## # ℹ 740 more rows</code></pre>
</div>
<div id="plot-the-data" class="section level4 hasAnchor" number="4.2.3.6">
<h4 class="hasAnchor"><span class="header-section-number">4.2.3.6</span> Plot the data<a href="#plot-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s visualize the distribution of the response variable for each of
the two song genres and superimpose the simulated parameter estimates
for the means of these two groups.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>dat_sim <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(category, liking_ij, <span class="at">color =</span> category)) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="co"># predicted means</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> (beta_0 <span class="sc">+</span> <span class="dv">0</span><span class="sc">*</span>beta_1),</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;orange&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> (beta_0 <span class="sc">+</span> <span class="dv">1</span><span class="sc">*</span>beta_1),</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  <span class="co"># actual data</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="st">&quot;grey65&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom=</span><span class="st">&quot;crossbar&quot;</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;orange&quot;</span>, <span class="st">&quot;dodgerblue&quot;</span>)) <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Predicted versus simulated values&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="figures/unnamed-chunk-10-1.png" width="768" /></p>
</div>
</div>
<div id="analyze-the-simulated-data" class="section level3 hasAnchor" number="4.2.4">
<h3 class="hasAnchor"><span class="header-section-number">4.2.4</span> Analyze the simulated data<a href="#analyze-the-simulated-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we can analyze our simulated data in a linear mixed effects model
using the function <code>lmer()</code> from the <code>{lmerTest}</code> package (which is a
wrapper around the <code>lmer()</code> function from the <code>{lme4}</code> package that
additionally provides <span class="math inline">\(p\)</span>-values). The model formula in <code>lmer()</code> maps
onto how we calculated our <code>liking_ij</code> outcome variable above.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>form <span class="ot">&lt;-</span> <span class="fu">formula</span>(liking_ij <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> genre_i <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> song_id) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> genre_i <span class="sc">|</span> subj_id))</span></code></pre></div>
<p>The terms in this R formula are as follows:</p>
<ul>
<li><code>liking_ij</code> is the response.</li>
<li><code>1</code> is the intercept (<code>beta_0</code>), which is the mean of the response
for the pop genre of songs (because we used dummy coding for the
<code>genre_i</code> term).</li>
<li><code>genre_i</code> is the dummy coded variable identifying whether song <span class="math inline">\(i\)</span>
belongs to the pop or rock genre.</li>
<li><code>(1 | song_id)</code> specifies a song-specific random intercept (<code>O_0i</code>).</li>
<li><code>(1 + genre_i | subj_id)</code> specifies a subject-specific random
intercept (<code>T_0j</code>) plus the subject specific random slope of the
genre category (<code>T_1j</code>).</li>
</ul>
<p>Now we can estimate the model.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># fit a linear mixed-effects model to data</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>mod_sim <span class="ot">&lt;-</span> <span class="fu">lmer</span>(form, <span class="at">data =</span> dat_sim)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="fu">summary</span>(mod_sim, <span class="at">corr =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: form
##    Data: dat_sim
## 
## REML criterion at convergence: 5392.5
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -3.00888 -0.66610  0.02982  0.64259  2.95212 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  song_id  (Intercept) 12.60    3.550        
##  subj_id  (Intercept) 57.18    7.562        
##           genre_i     22.98    4.793    0.45
##  Residual             62.81    7.926        
## Number of obs: 750, groups:  song_id, 30; subj_id, 25
## 
## Fixed effects:
##             Estimate Std. Error     df t value Pr(&gt;|t|)    
## (Intercept)   58.474      1.815 37.775  32.216  &lt; 2e-16 ***
## genre_i        7.501      1.713 40.857   4.379 8.09e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>We can use the <code>broom.mixed::tidy()</code> function to get a tidy table of the
results. This will prove to be super useful later when we need to
combine the output from hundreds of simulations to calculate power. We
will added columns for <code>parameter</code> and <code>value</code>, so we can compare the
estimate from the model to the parameters we used to simulate the data.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># get a tidy table of results</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>broom.mixed<span class="sc">::</span><span class="fu">tidy</span>(mod_sim) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(is.numeric, round, <span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>    <span class="at">parameter =</span> <span class="fu">c</span>(<span class="st">&quot;beta_0&quot;</span>, <span class="st">&quot;beta_1&quot;</span>, <span class="st">&quot;omega_0&quot;</span>, <span class="st">&quot;tau_0&quot;</span>, <span class="st">&quot;rho&quot;</span>, <span class="st">&quot;tau_1&quot;</span>, <span class="st">&quot;sigma&quot;</span>),</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">c</span>(beta_0, beta_1, omega_0, tau_0, rho, tau_1, sigma),</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="fu">select</span>(term, parameter, value, estimate) <span class="sc">|&gt;</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="left">parameter</th>
<th align="right">value</th>
<th align="right">estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="left">beta_0</td>
<td align="right">60.0</td>
<td align="right">58.474</td>
</tr>
<tr class="even">
<td align="left">genre_i</td>
<td align="left">beta_1</td>
<td align="right">5.0</td>
<td align="right">7.501</td>
</tr>
<tr class="odd">
<td align="left">sd__(Intercept)</td>
<td align="left">omega_0</td>
<td align="right">3.0</td>
<td align="right">3.550</td>
</tr>
<tr class="even">
<td align="left">sd__(Intercept)</td>
<td align="left">tau_0</td>
<td align="right">7.0</td>
<td align="right">7.562</td>
</tr>
<tr class="odd">
<td align="left">cor__(Intercept).genre_i</td>
<td align="left">rho</td>
<td align="right">0.2</td>
<td align="right">0.451</td>
</tr>
<tr class="even">
<td align="left">sd__genre_i</td>
<td align="left">tau_1</td>
<td align="right">4.0</td>
<td align="right">4.793</td>
</tr>
<tr class="odd">
<td align="left">sd__Observation</td>
<td align="left">sigma</td>
<td align="right">8.0</td>
<td align="right">7.926</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="data-simulation-automated" class="section level2 hasAnchor" number="4.3">
<h2 class="hasAnchor"><span class="header-section-number">4.3</span> Data simulation automated<a href="#data-simulation-automated" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we’ve tested the data generating code, we can put it into a
function so that it’s easy to run it repeatedly.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># set up the custom data simulation function</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="at">n_subj     =</span>  <span class="dv">25</span>,   <span class="co"># number of subjects</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  <span class="at">n_pop      =</span>  <span class="dv">15</span>,   <span class="co"># number of pop songs</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="at">n_rock     =</span>  <span class="dv">15</span>,   <span class="co"># number of rock songs</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="at">beta_0     =</span>  <span class="dv">60</span>,   <span class="co"># mean for pop genre</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  <span class="at">beta_1     =</span>   <span class="dv">5</span>,   <span class="co"># effect of genre</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>  <span class="at">omega_0    =</span>   <span class="dv">3</span>,   <span class="co"># by-song random intercept sd</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>  <span class="at">tau_0      =</span>   <span class="dv">7</span>,   <span class="co"># by-subject random intercept sd</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>  <span class="at">tau_1      =</span>   <span class="dv">4</span>,   <span class="co"># by-subject random slope sd</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>  <span class="at">rho        =</span>   <span class="fl">0.2</span>, <span class="co"># correlation between intercept and slope</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>  <span class="at">sigma      =</span>   <span class="dv">8</span>    <span class="co"># residual (standard deviation)</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>  )</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>{</span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>  <span class="co"># simulate a sample of songs</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>  songs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>    <span class="at">song_id =</span> <span class="fu">seq_len</span>(n_pop <span class="sc">+</span> n_rock),</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;pop&quot;</span>, <span class="st">&quot;rock&quot;</span>), <span class="fu">c</span>(n_pop, n_rock)),</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>    <span class="at">genre_i =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(n_pop, n_rock)),</span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>    <span class="at">O_0i =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> n_pop <span class="sc">+</span> n_rock, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> omega_0)</span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>  )</span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>  <span class="co"># simulate a sample of subjects</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>  subjects <span class="ot">&lt;-</span> faux<span class="sc">::</span><span class="fu">rnorm_multi</span>(</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>    <span class="at">n =</span> n_subj,</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a>    <span class="at">mu =</span> <span class="dv">0</span>,</span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">c</span>(tau_0, tau_1),</span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>    <span class="at">r =</span> rho,</span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>    <span class="at">varnames =</span> <span class="fu">c</span>(<span class="st">&quot;T_0j&quot;</span>, <span class="st">&quot;T_1j&quot;</span>)</span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">subj_id =</span> <span class="fu">seq_len</span>(n_subj))</span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a><span class="co"># cross subject and song IDs</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a><span class="fu">crossing</span>(subjects, songs) <span class="sc">|&gt;</span></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_ij =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma),</span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a>         <span class="at">liking_ij =</span> beta_0 <span class="sc">+</span> T_0j <span class="sc">+</span> O_0i <span class="sc">+</span> (beta_1 <span class="sc">+</span> T_1j) <span class="sc">*</span> genre_i <span class="sc">+</span> e_ij) <span class="sc">|&gt;</span></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a>  <span class="fu">select</span>(subj_id, song_id, category, genre_i, liking_ij)</span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="power-calculation-single-run" class="section level2 hasAnchor" number="4.4">
<h2 class="hasAnchor"><span class="header-section-number">4.4</span> Power calculation single run<a href="#power-calculation-single-run" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can wrap the data generating function and modeling code in a new
function <code>single_run()</code> that returns a tidy table of the analysis
results for a single simulation run. We’ll suppress warnings and
messages from the modeling fitting process, as these sometimes occur
with simulation runs that generate extreme realized values for
parameters.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># set up the power function</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>single_run <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  <span class="co"># ... is a shortcut that forwards any additional arguments to sim_data()</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  dat_sim <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(...)</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  mod_sim <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>({ <span class="fu">suppressMessages</span>({ <span class="co"># suppress singularity messages</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>    lmerTest<span class="sc">::</span><span class="fu">lmer</span>(liking_ij <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> genre_i <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> song_id) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> genre_i <span class="sc">|</span> subj_id), <span class="at">data =</span> dat_sim)</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>  })})</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>  broom.mixed<span class="sc">::</span><span class="fu">tidy</span>(mod_sim)</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s test that our new <code>single_run()</code> function performs as expected.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># run one model with default parameters</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="fu">single_run</span>()</span></code></pre></div>
<pre><code>## # A tibble: 7 × 8
##   effect   group    term            estimate std.error statistic    df   p.value
##   &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
## 1 fixed    &lt;NA&gt;     (Intercept)       60.9        1.89     32.2   34.6  2.26e-27
## 2 fixed    &lt;NA&gt;     genre_i            4.23       1.58      2.68  39.9  1.08e- 2
## 3 ran_pars song_id  sd__(Intercept)    3.27      NA        NA     NA   NA       
## 4 ran_pars subj_id  sd__(Intercept)    8.24      NA        NA     NA   NA       
## 5 ran_pars subj_id  cor__(Intercep…    0.678     NA        NA     NA   NA       
## 6 ran_pars subj_id  sd__genre_i        4.37      NA        NA     NA   NA       
## 7 ran_pars Residual sd__Observation    7.73      NA        NA     NA   NA</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># run one model with new parameters</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="fu">single_run</span>(<span class="at">n_pop =</span> <span class="dv">10</span>, <span class="at">n_rock =</span> <span class="dv">50</span>, <span class="at">beta_1 =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## # A tibble: 7 × 8
##   effect   group    term            estimate std.error statistic    df   p.value
##   &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
## 1 fixed    &lt;NA&gt;     (Intercept)       57.0        1.97    29.0    44.9  1.05e-30
## 2 fixed    &lt;NA&gt;     genre_i            1.54       1.76     0.873  57.3  3.86e- 1
## 3 ran_pars song_id  sd__(Intercept)    3.46      NA       NA      NA   NA       
## 4 ran_pars subj_id  sd__(Intercept)    7.77      NA       NA      NA   NA       
## 5 ran_pars subj_id  cor__(Intercep…    0.210     NA       NA      NA   NA       
## 6 ran_pars subj_id  sd__genre_i        5.85      NA       NA      NA   NA       
## 7 ran_pars Residual sd__Observation    7.92      NA       NA      NA   NA</code></pre>
</div>
<div id="power-calculation-automated" class="section level2 hasAnchor" number="4.5">
<h2 class="hasAnchor"><span class="header-section-number">4.5</span> Power calculation automated<a href="#power-calculation-automated" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To get an accurate estimation of power, we need to run the simulation
many times. Here we use the <code>future_map_dfr()</code> function to iterate over
a sequence of integers denoting the replications we want to perform.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">future_map_dfr</span>(<span class="dv">1</span><span class="sc">:</span>reps, <span class="sc">~</span> <span class="fu">single_run</span>())</span></code></pre></div>
<p>We can finally calculate power for our parameter of interest
<code>beta_1</code>(denoted in the tidy model output table as the term <code>genre_i</code>)
by filtering to keep only that term and the calculating the proportion
of times the <span class="math inline">\(p\)</span>-value is below the <code>alpha</code> (0.05) threshold.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="co"># calculate mean estimates and power for specified alpha</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>sims <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;genre_i&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>  <span class="fu">group_by</span>(term) <span class="sc">|&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>    <span class="at">mean_estimate =</span> <span class="fu">mean</span>(estimate),</span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>    <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error),</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">mean</span>(p.value <span class="sc">&lt;</span> alpha),</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##   term    mean_estimate mean_se power
##   &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 genre_i          4.97    1.47  0.88</code></pre>
<div id="check-false-positive-rate" class="section level3 hasAnchor" number="4.5.1">
<h3 class="hasAnchor"><span class="header-section-number">4.5.1</span> Check false positive rate<a href="#check-false-positive-rate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can do a sanity check to see if our simulation is performing as
expected by checking the false positive rate (Type I error rate). We set
the effect of <code>genre_ij</code> (<code>beta_1</code>) to 0 to calculate the false positive
rate, which is the probability of concluding there is an effect when
there is no actual effect in the population.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># run simulations and calculate the false positive rate</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>sims_fp <span class="ot">&lt;-</span> <span class="fu">future_map_dfr</span>(<span class="dv">1</span><span class="sc">:</span>reps, <span class="sc">~</span> <span class="fu">single_run</span>(<span class="at">beta_1 =</span> <span class="dv">0</span>))</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="co"># calculate mean estimates and power for specified alpha</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>sims_fp <span class="sc">|&gt;</span></span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;genre_i&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">power =</span> <span class="fu">mean</span>(p.value <span class="sc">&lt;</span> alpha))</span></code></pre></div>
<pre><code>## # A tibble: 1 × 1
##   power
##   &lt;dbl&gt;
## 1  0.05</code></pre>
<p>Ideally, the false positive rate will be equal to <code>alpha</code>, which we set
at 0.05.</p>
</div>
</div>
<div id="power-for-different-effect-sizes" class="section level2 hasAnchor" number="4.6">
<h2 class="hasAnchor"><span class="header-section-number">4.6</span> Power for different effect sizes<a href="#power-for-different-effect-sizes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In real life, we will not know the effect size of our quantity of
interest and so we will need to repeatedly perform the power analysis
over a range of different plausible effect sizes. Perhaps we might also
want to calculate power as we vary other data-generating parameters,
such as the number of pop and rock songs sampled and the number of
subjects sampled. We can create a table that combines all combinations
of the parameters we want to vary in a grid.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="co"># grid of parameter values of interest</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>pgrid <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a>  <span class="at">n_subj =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>),</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>  <span class="at">n_pop =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>),</span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>  <span class="at">n_rock =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>),</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a>  <span class="at">beta_1 =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a>)</span></code></pre></div>
<p>We can now wrap our <code>single_run()</code> function within a more general
function <code>parameter_search()</code> that takes the grid of parameter values as
input and uses the <code>future_pmap_dfr()</code> function to iterate over each row
of parameter values in <code>pgrid</code> and feed them into <code>single_run()</code>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co"># fit the models over the parameters</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>parameter_search <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">params =</span> pgrid){</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>  <span class="fu">future_pmap_dfr</span>(</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>    <span class="at">.l =</span> params, <span class="co"># iterate over the grid of parameter values</span></span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">single_run</span>(</span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a>             <span class="at">n_subj =</span> ..<span class="dv">1</span>, <span class="co"># plug each row of parameter values into single_run()</span></span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a>             <span class="at">n_pop  =</span> ..<span class="dv">2</span>,</span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a>             <span class="at">n_rock =</span> ..<span class="dv">3</span>,</span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a>             <span class="at">beta_1 =</span> ..<span class="dv">4</span></span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a>             ),</span>
<span id="cb36-11"><a href="#cb36-11" tabindex="-1"></a>    <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-12"><a href="#cb36-12" tabindex="-1"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb36-13"><a href="#cb36-13" tabindex="-1"></a>  )</span>
<span id="cb36-14"><a href="#cb36-14" tabindex="-1"></a>}</span></code></pre></div>
<p>If we call <code>parameter_search()</code> it will return a single replication of
simulations for each combination of parameter values in <code>pgrid</code>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="fu">parameter_search</span>()</span></code></pre></div>
<pre><code>## # A tibble: 420 × 8
##    effect   group    term           estimate std.error statistic    df   p.value
##    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1 fixed    &lt;NA&gt;     (Intercept)      58.3        2.97    19.7    10.4  1.42e- 9
##  2 fixed    &lt;NA&gt;     genre_i          -0.383      1.98    -0.194  12.9  8.49e- 1
##  3 ran_pars song_id  sd__(Intercep…    2.62      NA       NA      NA   NA       
##  4 ran_pars subj_id  sd__(Intercep…    8.58      NA       NA      NA   NA       
##  5 ran_pars subj_id  cor__(Interce…   -0.708     NA       NA      NA   NA       
##  6 ran_pars subj_id  sd__genre_i       3.24      NA       NA      NA   NA       
##  7 ran_pars Residual sd__Observati…    8.62      NA       NA      NA   NA       
##  8 fixed    &lt;NA&gt;     (Intercept)      62.8        2.15    29.1    14.6  2.36e-14
##  9 fixed    &lt;NA&gt;     genre_i           1.75       2.13     0.820  16.8  4.24e- 1
## 10 ran_pars song_id  sd__(Intercep…    3.52      NA       NA      NA   NA       
## # ℹ 410 more rows</code></pre>
<p>To run multiple replications of <code>parameter_search()</code>, we can use the
<code>future_replicate()</code> function, which just repeatedly calls
<code>parameter_search()</code> for the number of times specified by <code>reps</code>. Fair
warning, this will take some time if you have set a high number of
replications!</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="co"># replicate the parameter grid to match the dimensions of the model outputs</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>pgrid_expand <span class="ot">&lt;-</span> pgrid <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">each =</span> <span class="dv">7</span>)) <span class="sc">|&gt;</span> <span class="co"># replicate each row by 7 parameters</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>  <span class="fu">map_df</span>(rep.int, <span class="at">times =</span> reps) <span class="co"># replicate the whole grid by number of reps</span></span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a><span class="co"># replicate the parameter search many times</span></span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>sims_params <span class="ot">&lt;-</span> <span class="fu">future_replicate</span>(</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>    <span class="at">n =</span> reps,</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>    <span class="at">expr =</span> <span class="fu">parameter_search</span>(),</span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a>  <span class="fu">imap</span>( <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">rep =</span> .y, <span class="at">.before =</span> <span class="st">&quot;effect&quot;</span>)) <span class="sc">|&gt;</span> <span class="co"># include rep ID</span></span>
<span id="cb39-13"><a href="#cb39-13" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> <span class="co"># combine into a single tibble</span></span>
<span id="cb39-14"><a href="#cb39-14" tabindex="-1"></a>  <span class="fu">mutate</span>(pgrid_expand, <span class="at">.before =</span> <span class="st">&quot;effect&quot;</span>) <span class="co"># add in the parameter grid values</span></span></code></pre></div>
<p>Now, as before, we can calculate power. But this time we’ll group by all
of the parameters we manipulated in <code>pgrid</code>, so that we can get power
estimates for all combinations of parameter values.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>sims_table <span class="ot">&lt;-</span> sims_params <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;genre_i&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>  <span class="fu">group_by</span>(term, n_subj, n_pop, n_rock, beta_1) <span class="sc">|&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>    <span class="at">mean_estimate =</span> <span class="fu">mean</span>(estimate),</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>    <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error),</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">mean</span>(p.value <span class="sc">&lt;</span> alpha),</span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a>  )</span></code></pre></div>
<p>Here’s a graph that visualizes the output of the power simulation.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>sims_table <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(n_subj<span class="sc">:</span>beta_1, as.factor),</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>         <span class="at">n_pop =</span> <span class="fu">paste0</span>(<span class="st">&quot;n_pop: &quot;</span>, n_pop),</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>         <span class="at">n_rock =</span> <span class="fu">paste0</span>(<span class="st">&quot;n_rock: &quot;</span>, n_rock)) <span class="sc">|&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mean_estimate, <span class="at">y =</span> power,</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>             <span class="at">group =</span> n_subj, <span class="at">color =</span> n_subj)) <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;grey50&quot;</span>, <span class="at">linewidth =</span>  <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>  <span class="fu">facet_grid</span>(n_pop <span class="sc">~</span> n_rock) <span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Effect size (rock genre - pop genre)&quot;</span>,</span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Power&quot;</span>,</span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Power analysis via simulation&quot;</span>,</span>
<span id="cb41-16"><a href="#cb41-16" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Sample size&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-17"><a href="#cb41-17" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="figures/unnamed-chunk-26-1.png" width="768" /></p>
<p>Here’s a nicely formatted table that summarizes the output from the
power simulation.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>sims_table <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">&quot;Power analysis via simulation&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a>  <span class="fu">data_color</span>(</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>    <span class="at">columns =</span> power,</span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a>    <span class="at">fn =</span> scales<span class="sc">::</span><span class="fu">col_numeric</span>(</span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a>      <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;green&quot;</span>),</span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a>      )</span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a>  )</span></code></pre></div>
<div id="peypicwoph" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#peypicwoph table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#peypicwoph thead, #peypicwoph tbody, #peypicwoph tfoot, #peypicwoph tr, #peypicwoph td, #peypicwoph th {
  border-style: none;
}

#peypicwoph p {
  margin: 0;
  padding: 0;
}

#peypicwoph .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#peypicwoph .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#peypicwoph .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#peypicwoph .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#peypicwoph .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#peypicwoph .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#peypicwoph .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#peypicwoph .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#peypicwoph .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#peypicwoph .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#peypicwoph .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#peypicwoph .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#peypicwoph .gt_spanner_row {
  border-bottom-style: hidden;
}

#peypicwoph .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#peypicwoph .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#peypicwoph .gt_from_md > :first-child {
  margin-top: 0;
}

#peypicwoph .gt_from_md > :last-child {
  margin-bottom: 0;
}

#peypicwoph .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#peypicwoph .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#peypicwoph .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#peypicwoph .gt_row_group_first td {
  border-top-width: 2px;
}

#peypicwoph .gt_row_group_first th {
  border-top-width: 2px;
}

#peypicwoph .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#peypicwoph .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#peypicwoph .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#peypicwoph .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#peypicwoph .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#peypicwoph .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#peypicwoph .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#peypicwoph .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#peypicwoph .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#peypicwoph .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#peypicwoph .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#peypicwoph .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#peypicwoph .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#peypicwoph .gt_left {
  text-align: left;
}

#peypicwoph .gt_center {
  text-align: center;
}

#peypicwoph .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#peypicwoph .gt_font_normal {
  font-weight: normal;
}

#peypicwoph .gt_font_bold {
  font-weight: bold;
}

#peypicwoph .gt_font_italic {
  font-style: italic;
}

#peypicwoph .gt_super {
  font-size: 65%;
}

#peypicwoph .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#peypicwoph .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#peypicwoph .gt_indent_1 {
  text-indent: 5px;
}

#peypicwoph .gt_indent_2 {
  text-indent: 10px;
}

#peypicwoph .gt_indent_3 {
  text-indent: 15px;
}

#peypicwoph .gt_indent_4 {
  text-indent: 20px;
}

#peypicwoph .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_heading">
      <td colspan="8" class="gt_heading gt_title gt_font_normal gt_bottom_border" style>Power analysis via simulation</td>
    </tr>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="term">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="n_subj">n_subj</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="n_pop">n_pop</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="n_rock">n_rock</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="beta_1">beta_1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="mean_estimate">mean_estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="mean_se">mean_se</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="power">power</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.6821340</td>
<td headers="mean_se" class="gt_row gt_right">2.1433713</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F84200; color: #FFFFFF;">0.08</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.7274589</td>
<td headers="mean_se" class="gt_row gt_right">2.1428328</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F45500; color: #FFFFFF;">0.13</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.7482126</td>
<td headers="mean_se" class="gt_row gt_right">2.1406312</td>
<td headers="power" class="gt_row gt_right" style="background-color: #ED6A00; color: #FFFFFF;">0.20</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.6963509</td>
<td headers="mean_se" class="gt_row gt_right">2.1395978</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E38200; color: #FFFFFF;">0.30</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.6922276</td>
<td headers="mean_se" class="gt_row gt_right">2.1399928</td>
<td headers="power" class="gt_row gt_right" style="background-color: #CCA700; color: #000000;">0.48</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.7216763</td>
<td headers="mean_se" class="gt_row gt_right">1.8288711</td>
<td headers="power" class="gt_row gt_right" style="background-color: #FA3900; color: #FFFFFF;">0.06</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.7059291</td>
<td headers="mean_se" class="gt_row gt_right">1.8322452</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F55100; color: #FFFFFF;">0.12</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.6756674</td>
<td headers="mean_se" class="gt_row gt_right">1.8421349</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E57E00; color: #FFFFFF;">0.28</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.7319609</td>
<td headers="mean_se" class="gt_row gt_right">1.8460865</td>
<td headers="power" class="gt_row gt_right" style="background-color: #CCA700; color: #000000;">0.48</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.7424011</td>
<td headers="mean_se" class="gt_row gt_right">1.8396710</td>
<td headers="power" class="gt_row gt_right" style="background-color: #9FD200; color: #000000;">0.72</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.8245941</td>
<td headers="mean_se" class="gt_row gt_right">1.8332649</td>
<td headers="power" class="gt_row gt_right" style="background-color: #FA3900; color: #FFFFFF;">0.06</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.8476570</td>
<td headers="mean_se" class="gt_row gt_right">1.8308934</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F35800; color: #FFFFFF;">0.14</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.8841097</td>
<td headers="mean_se" class="gt_row gt_right">1.8234947</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E57E00; color: #FFFFFF;">0.28</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.9163802</td>
<td headers="mean_se" class="gt_row gt_right">1.8294477</td>
<td headers="power" class="gt_row gt_right" style="background-color: #C4B100; color: #000000;">0.53</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.9206879</td>
<td headers="mean_se" class="gt_row gt_right">1.8285285</td>
<td headers="power" class="gt_row gt_right" style="background-color: #9FD200; color: #000000;">0.72</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">1.1213453</td>
<td headers="mean_se" class="gt_row gt_right">1.4790176</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F84200; color: #FFFFFF;">0.08</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">2.1427686</td>
<td headers="mean_se" class="gt_row gt_right">1.4853952</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E77900; color: #FFFFFF;">0.26</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">3.1372541</td>
<td headers="mean_se" class="gt_row gt_right">1.4847813</td>
<td headers="power" class="gt_row gt_right" style="background-color: #CDA500; color: #000000;">0.47</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">4.1692116</td>
<td headers="mean_se" class="gt_row gt_right">1.4875177</td>
<td headers="power" class="gt_row gt_right" style="background-color: #98D700; color: #000000;">0.75</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">10</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">5.1915115</td>
<td headers="mean_se" class="gt_row gt_right">1.4906063</td>
<td headers="power" class="gt_row gt_right" style="background-color: #6EEC00; color: #000000;">0.88</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.6206088</td>
<td headers="mean_se" class="gt_row gt_right">1.7168699</td>
<td headers="power" class="gt_row gt_right" style="background-color: #FB3300; color: #FFFFFF;">0.05</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.6084364</td>
<td headers="mean_se" class="gt_row gt_right">1.7200867</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F15E00; color: #FFFFFF;">0.16</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.6187355</td>
<td headers="mean_se" class="gt_row gt_right">1.7234279</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E08700; color: #FFFFFF;">0.32</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.6035387</td>
<td headers="mean_se" class="gt_row gt_right">1.7198478</td>
<td headers="power" class="gt_row gt_right" style="background-color: #CDA500; color: #000000;">0.47</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.5822773</td>
<td headers="mean_se" class="gt_row gt_right">1.7152229</td>
<td headers="power" class="gt_row gt_right" style="background-color: #98D700; color: #000000;">0.75</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.9055907</td>
<td headers="mean_se" class="gt_row gt_right">1.4495971</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F84200; color: #FFFFFF;">0.08</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.8898537</td>
<td headers="mean_se" class="gt_row gt_right">1.4482416</td>
<td headers="power" class="gt_row gt_right" style="background-color: #EC6C00; color: #FFFFFF;">0.21</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.8874405</td>
<td headers="mean_se" class="gt_row gt_right">1.4451125</td>
<td headers="power" class="gt_row gt_right" style="background-color: #C9AB00; color: #000000;">0.50</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.9016062</td>
<td headers="mean_se" class="gt_row gt_right">1.4461336</td>
<td headers="power" class="gt_row gt_right" style="background-color: #95D800; color: #000000;">0.76</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.8689765</td>
<td headers="mean_se" class="gt_row gt_right">1.4454748</td>
<td headers="power" class="gt_row gt_right" style="background-color: #65EF00; color: #000000;">0.90</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">1.0219424</td>
<td headers="mean_se" class="gt_row gt_right">1.4336253</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F45500; color: #FFFFFF;">0.13</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">2.0103972</td>
<td headers="mean_se" class="gt_row gt_right">1.4328663</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E57E00; color: #FFFFFF;">0.28</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.9942518</td>
<td headers="mean_se" class="gt_row gt_right">1.4348602</td>
<td headers="power" class="gt_row gt_right" style="background-color: #CAA900; color: #000000;">0.49</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">4.0128924</td>
<td headers="mean_se" class="gt_row gt_right">1.4346163</td>
<td headers="power" class="gt_row gt_right" style="background-color: #92DA00; color: #000000;">0.77</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">5.0216769</td>
<td headers="mean_se" class="gt_row gt_right">1.4367690</td>
<td headers="power" class="gt_row gt_right" style="background-color: #38FA00; color: #000000;">0.97</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.9529641</td>
<td headers="mean_se" class="gt_row gt_right">1.0960452</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F06100; color: #FFFFFF;">0.17</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.9357289</td>
<td headers="mean_se" class="gt_row gt_right">1.0964069</td>
<td headers="power" class="gt_row gt_right" style="background-color: #D49C00; color: #000000;">0.42</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.9554635</td>
<td headers="mean_se" class="gt_row gt_right">1.0980189</td>
<td headers="power" class="gt_row gt_right" style="background-color: #9FD200; color: #000000;">0.72</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.9530592</td>
<td headers="mean_se" class="gt_row gt_right">1.0980972</td>
<td headers="power" class="gt_row gt_right" style="background-color: #65EF00; color: #000000;">0.90</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">25</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.9797585</td>
<td headers="mean_se" class="gt_row gt_right">1.0980008</td>
<td headers="power" class="gt_row gt_right" style="background-color: #1FFD00; color: #000000;">0.99</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.8935373</td>
<td headers="mean_se" class="gt_row gt_right">1.5072281</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F45500; color: #FFFFFF;">0.13</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.8989927</td>
<td headers="mean_se" class="gt_row gt_right">1.5076401</td>
<td headers="power" class="gt_row gt_right" style="background-color: #ED6A00; color: #FFFFFF;">0.20</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.8976098</td>
<td headers="mean_se" class="gt_row gt_right">1.5096626</td>
<td headers="power" class="gt_row gt_right" style="background-color: #D49C00; color: #000000;">0.42</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.8978394</td>
<td headers="mean_se" class="gt_row gt_right">1.5063429</td>
<td headers="power" class="gt_row gt_right" style="background-color: #B2C200; color: #000000;">0.63</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.9065649</td>
<td headers="mean_se" class="gt_row gt_right">1.5102823</td>
<td headers="power" class="gt_row gt_right" style="background-color: #65EF00; color: #000000;">0.90</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.8624299</td>
<td headers="mean_se" class="gt_row gt_right">1.2642870</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F55100; color: #FFFFFF;">0.12</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.8966771</td>
<td headers="mean_se" class="gt_row gt_right">1.2632428</td>
<td headers="power" class="gt_row gt_right" style="background-color: #E48000; color: #FFFFFF;">0.29</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.9027209</td>
<td headers="mean_se" class="gt_row gt_right">1.2631341</td>
<td headers="power" class="gt_row gt_right" style="background-color: #B8BD00; color: #000000;">0.60</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.8651279</td>
<td headers="mean_se" class="gt_row gt_right">1.2660560</td>
<td headers="power" class="gt_row gt_right" style="background-color: #72EA00; color: #000000;">0.87</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">10</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.8895942</td>
<td headers="mean_se" class="gt_row gt_right">1.2672331</td>
<td headers="power" class="gt_row gt_right" style="background-color: #2EFC00; color: #000000;">0.98</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.9841072</td>
<td headers="mean_se" class="gt_row gt_right">1.2649184</td>
<td headers="power" class="gt_row gt_right" style="background-color: #F15E00; color: #FFFFFF;">0.16</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.9939159</td>
<td headers="mean_se" class="gt_row gt_right">1.2657069</td>
<td headers="power" class="gt_row gt_right" style="background-color: #DD8D00; color: #FFFFFF;">0.35</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">3.0015429</td>
<td headers="mean_se" class="gt_row gt_right">1.2671451</td>
<td headers="power" class="gt_row gt_right" style="background-color: #AEC600; color: #000000;">0.65</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.9797475</td>
<td headers="mean_se" class="gt_row gt_right">1.2674822</td>
<td headers="power" class="gt_row gt_right" style="background-color: #7DE600; color: #000000;">0.84</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">10</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.9817978</td>
<td headers="mean_se" class="gt_row gt_right">1.2696729</td>
<td headers="power" class="gt_row gt_right" style="background-color: #41F900; color: #000000;">0.96</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">1</td>
<td headers="mean_estimate" class="gt_row gt_right">0.9598020</td>
<td headers="mean_se" class="gt_row gt_right">0.9119579</td>
<td headers="power" class="gt_row gt_right" style="background-color: #EC6C00; color: #FFFFFF;">0.21</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">2</td>
<td headers="mean_estimate" class="gt_row gt_right">1.9561492</td>
<td headers="mean_se" class="gt_row gt_right">0.9104043</td>
<td headers="power" class="gt_row gt_right" style="background-color: #C2B200; color: #000000;">0.54</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">3</td>
<td headers="mean_estimate" class="gt_row gt_right">2.9585712</td>
<td headers="mean_se" class="gt_row gt_right">0.9104248</td>
<td headers="power" class="gt_row gt_right" style="background-color: #60F100; color: #000000;">0.91</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">4</td>
<td headers="mean_estimate" class="gt_row gt_right">3.9730888</td>
<td headers="mean_se" class="gt_row gt_right">0.9107468</td>
<td headers="power" class="gt_row gt_right" style="background-color: #1FFD00; color: #000000;">0.99</td></tr>
    <tr><td headers="term" class="gt_row gt_left">genre_i</td>
<td headers="n_subj" class="gt_row gt_right">50</td>
<td headers="n_pop" class="gt_row gt_right">40</td>
<td headers="n_rock" class="gt_row gt_right">40</td>
<td headers="beta_1" class="gt_row gt_right">5</td>
<td headers="mean_estimate" class="gt_row gt_right">4.9661969</td>
<td headers="mean_se" class="gt_row gt_right">0.9115207</td>
<td headers="power" class="gt_row gt_right" style="background-color: #00FF00; color: #000000;">1.00</td></tr>
  </tbody>
  
  
</table>
</div>
<!--chapter:end:04_R.Rmd-->
</div>
</div>
<div id="python" class="section level1 hasAnchor" number="5">
<h1 class="hasAnchor"><span class="header-section-number">5</span> Python<a href="#python" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>To begin with, the simulation-based power analysis in Python follows the structure in the last section in R, and there are repetitions in the text to describe the method. However, there are differences between the two languages; we will specify those discrepancies in the following “note” parts.</p>
<div id="setup-1" class="section level2 hasAnchor" number="5.1">
<h2 class="hasAnchor"><span class="header-section-number">5.1</span> Setup<a href="#setup-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Note: There are two differences between Python and the R language:</p>
<ol style="list-style-type: decimal">
<li>R uses the p_load function to automatically install missing libraries and import libraries. Python needs to manually configure the environment. If the library is missing, you can use “! pip install [package_name]” to install;</li>
<li>The R has set parallelism in the setup part, but Python uses the dask package to perform parallel computing in the simulation part.</li>
</ol>
<p>We will need to use several Python packages to optimize our workflow and fit mixed effects models.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a>matplotlib.use(<span class="st">&quot;Agg&quot;</span>)</span></code></pre></div>
<p>We will also set the pseudo-random number generator seed to 2138 to make the stochastic components of our simulations reproducible.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a>np.random.seed(<span class="dv">2138</span>)</span></code></pre></div>
</div>
<div id="data-simulation-step-by-step-1" class="section level2 hasAnchor" number="5.2">
<h2 class="hasAnchor"><span class="header-section-number">5.2</span> Data simulation step by step<a href="#data-simulation-step-by-step-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To give an overview of the power simulation task, we will simulate data from a design with crossed random factors of subjects and songs (see Power of What? for design details), fit a model to the simulated data, recover from the model output the parameter values we put in, calculate power, and finally automate the whole process so that we can calculate power for different effect sizes. Much of the general workflow here is borrowed from DeBruine &amp; Dale (2021) Understanding Mixed-Effects Models through Simulation. We’ll start by writing code that simulates datasets under the alternative hypothesis.</p>
<p>Note: There are two differences between Python and the R:</p>
<ol style="list-style-type: decimal">
<li>We use the package of “statsmodels” to set up the mixd effect model in Python. However, this package doesn’t have extension to show the correlation between the random intercept and the random slope of the subject like that in R;</li>
<li>There’s no “broom.mixed::tidy()” function in Python and that’s why the output is incomplete.</li>
</ol>
<div id="establish-the-simulation-parameters-1" class="section level3 hasAnchor" number="5.2.1">
<h3 class="hasAnchor"><span class="header-section-number">5.2.1</span> Establish the simulation parameters<a href="#establish-the-simulation-parameters-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before we start, let’s set some global parameters for our power simulations. Since simulations can take a long time to run, we’ll use 30 replications here as an example, but we recommend increasing this number to at least 1000 replications for a more accurate final power calculation.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="co"># number of simulation replicates for power calculation</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>reps <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a><span class="co"># specified alpha for power calculation</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span></code></pre></div>
</div>
<div id="establish-the-data-generating-parameters-1" class="section level3 hasAnchor" number="5.2.2">
<h3 class="hasAnchor"><span class="header-section-number">5.2.2</span> Establish the data-generating parameters<a href="#establish-the-data-generating-parameters-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first thing to do is to set up the parameters that govern the process we assume gave rise to the data - the data-generating process, or DGP. We previously decided upon the the data-generating parameters (see Power of What?), so we just need to code them here.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="co"># set all data-generating parameters</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>beta_0 <span class="op">=</span> <span class="dv">60</span>  <span class="co"># intercept; i.e., the grand mean</span></span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>beta_1 <span class="op">=</span> <span class="dv">5</span>   <span class="co"># slope; i.e, effect of category</span></span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a>omega_0 <span class="op">=</span> <span class="dv">3</span>  <span class="co"># by-song random intercept sd</span></span>
<span id="cb46-5"><a href="#cb46-5" tabindex="-1"></a>tau_0 <span class="op">=</span> <span class="dv">7</span>    <span class="co"># by-subject random intercept sd</span></span>
<span id="cb46-6"><a href="#cb46-6" tabindex="-1"></a>tau_1 <span class="op">=</span> <span class="dv">4</span>    <span class="co"># by-subject random slope sd</span></span>
<span id="cb46-7"><a href="#cb46-7" tabindex="-1"></a>rho <span class="op">=</span> <span class="fl">0.2</span>    <span class="co"># correlation between intercept and slope</span></span>
<span id="cb46-8"><a href="#cb46-8" tabindex="-1"></a>sigma <span class="op">=</span> <span class="dv">8</span>    <span class="co"># residual (error) sd</span></span></code></pre></div>
</div>
<div id="simulate-the-sampling-process-1" class="section level3 hasAnchor" number="5.2.3">
<h3 class="hasAnchor"><span class="header-section-number">5.2.3</span> Simulate the sampling process<a href="#simulate-the-sampling-process-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we will simulate the sampling process for the data. First, let’s define parameters related to the number of observations.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="co"># set number of subjects and songs</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>n_subj <span class="op">=</span> <span class="dv">25</span>  <span class="co"># number of subjects</span></span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>n_pop <span class="op">=</span> <span class="dv">15</span>   <span class="co"># number of songs in pop category</span></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>n_rock <span class="op">=</span> <span class="dv">15</span>  <span class="co"># number of songs in rock category</span></span></code></pre></div>
<div id="simulate-the-sampling-of-songs-1" class="section level4 hasAnchor" number="5.2.3.1">
<h4 class="hasAnchor"><span class="header-section-number">5.2.3.1</span> Simulate the sampling of songs<a href="#simulate-the-sampling-of-songs-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We need to create a table listing each song <span class="math inline">\(i\)</span>, which category it is in (rock or pop), and its random effect <span class="math inline">\(O_{0i}\)</span>. The latter is sampled from a univariate normal distribution using the function np.random.normal().</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co"># simulate a sample of songs</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>songs <span class="op">=</span> pd.DataFrame({</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>    <span class="st">&#39;song_id&#39;</span>: <span class="bu">range</span>(<span class="dv">1</span>, n_pop <span class="op">+</span> n_rock <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>    <span class="st">&#39;category&#39;</span>: [<span class="st">&#39;pop&#39;</span>]<span class="op">*</span>n_pop <span class="op">+</span> [<span class="st">&#39;rock&#39;</span>]<span class="op">*</span>n_rock,</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a>    <span class="st">&#39;genre_i&#39;</span>: [<span class="dv">0</span>]<span class="op">*</span>n_pop <span class="op">+</span> [<span class="dv">1</span>]<span class="op">*</span>n_rock,</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a>    <span class="st">&#39;O_0i&#39;</span>: np.random.normal(<span class="dv">0</span>, omega_0, n_pop <span class="op">+</span> n_rock)</span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a>})</span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a><span class="bu">print</span>(songs.head(<span class="dv">10</span>))</span></code></pre></div>
<pre><code>##    song_id category  genre_i      O_0i
## 0        1      pop        0 -1.803722
## 1        2      pop        0 -4.618354
## 2        3      pop        0 -4.847097
## 3        4      pop        0 -1.097951
## 4        5      pop        0 -1.394909
## 5        6      pop        0  2.424235
## 6        7      pop        0 -3.956914
## 7        8      pop        0  0.873891
## 8        9      pop        0  3.318065
## 9       10      pop        0  5.513671</code></pre>
</div>
<div id="simulate-the-sampling-of-subjects-1" class="section level4 hasAnchor" number="5.2.3.2">
<h4 class="hasAnchor"><span class="header-section-number">5.2.3.2</span> Simulate the sampling of subjects<a href="#simulate-the-sampling-of-subjects-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now we simulate the sampling of participants, which results in table listing each individual and their two correlated random effects (a random intercept and random slope). To do this, we must sample <span class="math inline">\(T_{0j} ,T_{1j}\)</span> pairs - one for each subject - from a bivariate normal distribution.</p>
<p>We will use the function np.random.multivariate_normal(), which generates a table of n simulated values from a multivariate normal distribution by specifying the means and covariance matrix(cov).</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="co"># simulate a sample of subjects</span></span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a><span class="co"># sample from a multivariate normal distribution</span></span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>mean <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># means for random effects are always 0</span></span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>cov <span class="op">=</span> [[tau_0<span class="op">**</span><span class="dv">2</span>, rho<span class="op">*</span>tau_0<span class="op">*</span>tau_1], [rho<span class="op">*</span>tau_0<span class="op">*</span>tau_1, tau_1<span class="op">**</span><span class="dv">2</span>]]  <span class="co"># set covariance matrix</span></span>
<span id="cb50-6"><a href="#cb50-6" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" tabindex="-1"></a>random_effects <span class="op">=</span> np.random.multivariate_normal(mean, cov, n_subj)</span>
<span id="cb50-8"><a href="#cb50-8" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" tabindex="-1"></a>subjects <span class="op">=</span> pd.DataFrame(random_effects, columns<span class="op">=</span>[<span class="st">&#39;T_0j&#39;</span>, <span class="st">&#39;T_1j&#39;</span>])</span>
<span id="cb50-10"><a href="#cb50-10" tabindex="-1"></a>subjects[<span class="st">&#39;subj_id&#39;</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, n_subj <span class="op">+</span> <span class="dv">1</span>) <span class="co"># add subject IDs</span></span>
<span id="cb50-11"><a href="#cb50-11" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" tabindex="-1"></a><span class="bu">print</span>(subjects.head(<span class="dv">10</span>))</span></code></pre></div>
<pre><code>##         T_0j      T_1j  subj_id
## 0  -0.547564 -2.796419        1
## 1 -10.695092 -3.700622        2
## 2   3.387493 -7.940628        3
## 3   4.344241  0.531463        4
## 4   6.461586  5.260280        5
## 5 -12.373764 -1.387928        6
## 6   0.352194 -3.990547        7
## 7  -6.962734  2.358670        8
## 8  -2.636463 -0.370637        9
## 9   0.619930 -4.416671       10</code></pre>
</div>
<div id="check-the-simulated-values-1" class="section level4 hasAnchor" number="5.2.3.3">
<h4 class="hasAnchor"><span class="header-section-number">5.2.3.3</span> Check the simulated values<a href="#check-the-simulated-values-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s do a quick sanity check by comparing our simulated values to the parameters we used as inputs. Because the sampling process is stochastic, we shouldn’t expect that these will exactly match for any given run of the simulation.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>check_values <span class="op">=</span> pd.DataFrame({</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>    <span class="st">&#39;parameter&#39;</span>: [<span class="st">&#39;omega_0&#39;</span>, <span class="st">&#39;tau_0&#39;</span>, <span class="st">&#39;tau_1&#39;</span>, <span class="st">&#39;rho&#39;</span>],</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>    <span class="st">&#39;value&#39;</span>: [omega_0, tau_0, tau_1, rho],</span>
<span id="cb52-4"><a href="#cb52-4" tabindex="-1"></a>    <span class="st">&#39;simulated&#39;</span>: [songs[<span class="st">&#39;O_0i&#39;</span>].std(), subjects[<span class="st">&#39;T_0j&#39;</span>].std(), subjects[<span class="st">&#39;T_1j&#39;</span>].std(), subjects[<span class="st">&#39;T_0j&#39;</span>].corr(subjects[<span class="st">&#39;T_1j&#39;</span>])]</span>
<span id="cb52-5"><a href="#cb52-5" tabindex="-1"></a>})</span>
<span id="cb52-6"><a href="#cb52-6" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" tabindex="-1"></a><span class="bu">print</span>(check_values)</span></code></pre></div>
<pre><code>##   parameter  value  simulated
## 0   omega_0    3.0   3.372345
## 1     tau_0    7.0   5.648262
## 2     tau_1    4.0   4.439518
## 3       rho    0.2   0.063860</code></pre>
</div>
<div id="simulate-trials-1" class="section level4 hasAnchor" number="5.2.3.4">
<h4 class="hasAnchor"><span class="header-section-number">5.2.3.4</span> Simulate trials<a href="#simulate-trials-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Since all subjects rate all songs (i.e., the design is fully crossed) we can set up a table of trials by including every possible combination of the rows in the subjects and songs tables. Each trial has random error associated with it, reflecting fluctuations in trial-by-trial ratings due to unknown factors. We simulate this by sampling values from a univariate normal distribution with a mean of 0 and a standard deviation of sigma.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="co"># cross subject and song IDs; add an error term</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>trials <span class="op">=</span> subjects.assign(key<span class="op">=</span><span class="dv">1</span>).merge(songs.assign(key<span class="op">=</span><span class="dv">1</span>), on<span class="op">=</span><span class="st">&#39;key&#39;</span>).drop(columns<span class="op">=</span><span class="st">&#39;key&#39;</span>)</span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>trials[<span class="st">&#39;e_ij&#39;</span>] <span class="op">=</span> np.random.normal(<span class="dv">0</span>, sigma, <span class="bu">len</span>(trials))</span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="bu">print</span>(trials.head(<span class="dv">10</span>))</span></code></pre></div>
<pre><code>##        T_0j      T_1j  subj_id  song_id category  genre_i      O_0i       e_ij
## 0 -0.547564 -2.796419        1        1      pop        0 -1.803722   6.954841
## 1 -0.547564 -2.796419        1        2      pop        0 -4.618354  -6.588163
## 2 -0.547564 -2.796419        1        3      pop        0 -4.847097   5.226969
## 3 -0.547564 -2.796419        1        4      pop        0 -1.097951 -11.285800
## 4 -0.547564 -2.796419        1        5      pop        0 -1.394909   2.418785
## 5 -0.547564 -2.796419        1        6      pop        0  2.424235  -7.579483
## 6 -0.547564 -2.796419        1        7      pop        0 -3.956914  -2.553524
## 7 -0.547564 -2.796419        1        8      pop        0  0.873891  12.726906
## 8 -0.547564 -2.796419        1        9      pop        0  3.318065  -6.371494
## 9 -0.547564 -2.796419        1       10      pop        0  5.513671  13.508966</code></pre>
</div>
<div id="calculate-response-values-1" class="section level4 hasAnchor" number="5.2.3.5">
<h4 class="hasAnchor"><span class="header-section-number">5.2.3.5</span> Calculate response values<a href="#calculate-response-values-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>With this resulting trials table, in combination with the constants <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span>, we have the full set of values that we need to compute the response variable liking_ij according the linear model we defined previously (see Power of What?).</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>dat_sim <span class="op">=</span> trials.copy()</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>dat_sim[<span class="st">&#39;liking_ij&#39;</span>] <span class="op">=</span> beta_0 <span class="op">+</span> dat_sim[<span class="st">&#39;T_0j&#39;</span>] <span class="op">+</span> dat_sim[<span class="st">&#39;O_0i&#39;</span>] <span class="op">+</span> (beta_1 <span class="op">+</span> dat_sim[<span class="st">&#39;T_1j&#39;</span>]) <span class="op">*</span> dat_sim[<span class="st">&#39;genre_i&#39;</span>] <span class="op">+</span> dat_sim[<span class="st">&#39;e_ij&#39;</span>]</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a>dat_sim <span class="op">=</span> dat_sim[[<span class="st">&#39;subj_id&#39;</span>, <span class="st">&#39;song_id&#39;</span>, <span class="st">&#39;category&#39;</span>, <span class="st">&#39;genre_i&#39;</span>, <span class="st">&#39;liking_ij&#39;</span>]]</span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a><span class="bu">print</span>(dat_sim.head(<span class="dv">10</span>))</span></code></pre></div>
<pre><code>##    subj_id  song_id category  genre_i  liking_ij
## 0        1        1      pop        0  64.603556
## 1        1        2      pop        0  48.245919
## 2        1        3      pop        0  59.832308
## 3        1        4      pop        0  47.068685
## 4        1        5      pop        0  60.476312
## 5        1        6      pop        0  54.297188
## 6        1        7      pop        0  52.941998
## 7        1        8      pop        0  73.053233
## 8        1        9      pop        0  56.399007
## 9        1       10      pop        0  78.475074</code></pre>
</div>
<div id="plot-the-data-1" class="section level4 hasAnchor" number="5.2.3.6">
<h4 class="hasAnchor"><span class="header-section-number">5.2.3.6</span> Plot the data<a href="#plot-the-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s visualize the distribution of the response variable for each of the two song genres and superimpose the simulated parameter estimates for the means of these two groups.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a>palette <span class="op">=</span> {<span class="st">&#39;pop&#39;</span>: <span class="st">&#39;orange&#39;</span>, <span class="st">&#39;rock&#39;</span>: <span class="st">&#39;dodgerblue&#39;</span>}</span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a><span class="co"># actual data</span></span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a>sns.violinplot(x<span class="op">=</span><span class="st">&#39;category&#39;</span>, y<span class="op">=</span><span class="st">&#39;liking_ij&#39;</span>, data<span class="op">=</span>dat_sim, palette<span class="op">=</span>palette, inner<span class="op">=</span><span class="va">None</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a>sns.pointplot(x<span class="op">=</span><span class="st">&#39;category&#39;</span>, y<span class="op">=</span><span class="st">&#39;liking_ij&#39;</span>, data<span class="op">=</span>dat_sim, estimator<span class="op">=</span>np.mean, ci<span class="op">=</span><span class="va">None</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a><span class="co"># predicted means</span></span>
<span id="cb58-8"><a href="#cb58-8" tabindex="-1"></a>plt.axhline(y<span class="op">=</span>(beta_0 <span class="op">+</span> <span class="dv">0</span><span class="op">*</span>beta_1), color<span class="op">=</span><span class="st">&#39;orange&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;dashed&#39;</span>)</span>
<span id="cb58-9"><a href="#cb58-9" tabindex="-1"></a>plt.axhline(y<span class="op">=</span>(beta_0 <span class="op">+</span> <span class="dv">1</span><span class="op">*</span>beta_1), color<span class="op">=</span><span class="st">&#39;dodgerblue&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;dashed&#39;</span>)</span>
<span id="cb58-10"><a href="#cb58-10" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" tabindex="-1"></a>plt.title(<span class="st">&quot;Predicted versus simulated values&quot;</span>)</span>
<span id="cb58-12"><a href="#cb58-12" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="figures/unnamed-chunk-12-1.png" width="672" /></p>
</div>
</div>
<div id="analyze-the-simulated-data-1" class="section level3 hasAnchor" number="5.2.4">
<h3 class="hasAnchor"><span class="header-section-number">5.2.4</span> Analyze the simulated data<a href="#analyze-the-simulated-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we can analyze our simulated data in a linear mixed effects model using the function mixedlm from the {statsmodels} package. The formula and vc_formula in mixedlm() map onto how we calculated our liking_ij outcome variable above.</p>
<p>The terms in formula are as follows:
liking_ij is the response.
1 is the intercept (<span class="math inline">\(\beta_0\)</span>), which is the mean of the response for the pop genre of songs (because we used dummy coding for the genre_i term).
genre_i is the dummy coded variable identifying whether song <span class="math inline">\(i\)</span> belongs to the pop or rock genre.</p>
<p>The terms in vc_formula are as follows:</p>
<ul>
<li>0 + C(song_id) specifies a song-specific random intercept O_0i.</li>
<li>0 + C(subject_id) specifies a subject-specific random intercept T_0j.</li>
<li>0 + C(subject_id):genre_i specifies the subject specific random slope of the genre category T_1j.</li>
</ul>
<p>However, due to the inability of the function mixedlm(), the module did not indicate the correlation between subject-specific random intercept and the subject specific random slope of the genre category.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="co"># fit a linear mixed-effects model to data</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>form <span class="op">=</span> <span class="st">&#39;liking_ij ~ 1 + genre_i&#39;</span></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>dat_sim[<span class="st">&#39;groups&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>vcf <span class="op">=</span> {<span class="st">&#39;song_id&#39;</span>:<span class="st">&#39;0 + C(song_id)&#39;</span>, <span class="st">&#39;subj_id&#39;</span>:<span class="st">&#39;0 + C(subj_id)&#39;</span>, <span class="st">&#39;genre_i&#39;</span>: <span class="st">&#39;0 + C(subj_id):genre_i&#39;</span>}</span></code></pre></div>
<p>Now we can estimate the model.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a>model <span class="op">=</span> smf.mixedlm(form, groups<span class="op">=</span>dat_sim[<span class="st">&#39;groups&#39;</span>], vc_formula<span class="op">=</span>vcf, re_formula<span class="op">=</span><span class="st">&#39;0&#39;</span>, data<span class="op">=</span>dat_sim)</span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>mod_sim <span class="op">=</span> model.fit()</span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a><span class="bu">print</span>(mod_sim.summary())</span></code></pre></div>
<pre><code>##          Mixed Linear Model Regression Results
## ========================================================
## Model:            MixedLM Dependent Variable: liking_ij 
## No. Observations: 750     Method:             REML      
## No. Groups:       1       Scale:              66.4110   
## Min. group size:  750     Log-Likelihood:     -2708.1155
## Max. group size:  750     Converged:          Yes       
## Mean group size:  750.0                                 
## --------------------------------------------------------
##               Coef.  Std.Err.   z    P&gt;|z| [0.025 0.975]
## --------------------------------------------------------
## Intercept     58.078    1.494 38.873 0.000 55.150 61.007
## genre_i        5.505    1.631  3.376 0.001  2.309  8.701
## genre_i Var   22.355    1.106                           
## song_id Var   10.578    0.443                           
## subj_id Var   33.748    1.353                           
## ========================================================</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a>formatted_sim_result <span class="op">=</span> pd.DataFrame({</span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a>    <span class="st">&#39;term&#39;</span>: [<span class="st">&#39;Intercept&#39;</span>, <span class="st">&#39;genre_i&#39;</span>, <span class="st">&#39;&#39;</span>, <span class="st">&#39;&#39;</span>, <span class="st">&#39;&#39;</span>, <span class="st">&#39;&#39;</span>, <span class="st">&#39;&#39;</span>],</span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>    <span class="st">&#39;parameter&#39;</span>: [<span class="st">&#39;beta_0&#39;</span>, <span class="st">&#39;beta_1&#39;</span>, <span class="st">&#39;omega_0&#39;</span>, <span class="st">&#39;tau_0&#39;</span>, <span class="st">&#39;rho&#39;</span>, <span class="st">&#39;tau_1&#39;</span>, <span class="st">&#39;sigma&#39;</span>],</span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a>    <span class="st">&#39;value&#39;</span>: [beta_0, beta_1, omega_0, tau_0, rho, tau_1, sigma],</span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a>    <span class="st">&#39;simulated&#39;</span>: [mod_sim.fe_params[<span class="dv">0</span>], mod_sim.fe_params[<span class="dv">1</span>],</span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a>                  <span class="st">&#39;&#39;</span>, <span class="st">&#39;&#39;</span>,</span>
<span id="cb62-7"><a href="#cb62-7" tabindex="-1"></a>                 <span class="st">&#39;&#39;</span>, <span class="st">&#39;&#39;</span>,</span>
<span id="cb62-8"><a href="#cb62-8" tabindex="-1"></a>                 <span class="st">&#39;&#39;</span>]</span>
<span id="cb62-9"><a href="#cb62-9" tabindex="-1"></a>})</span>
<span id="cb62-10"><a href="#cb62-10" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" tabindex="-1"></a><span class="bu">print</span>(formatted_sim_result)</span></code></pre></div>
<pre><code>##         term parameter  value  simulated
## 0  Intercept    beta_0   60.0  58.078342
## 1    genre_i    beta_1    5.0   5.504843
## 2              omega_0    3.0           
## 3                tau_0    7.0           
## 4                  rho    0.2           
## 5                tau_1    4.0           
## 6                sigma    8.0</code></pre>
</div>
</div>
<div id="data-simulation-automated-1" class="section level2 hasAnchor" number="5.3">
<h2 class="hasAnchor"><span class="header-section-number">5.3</span> Data simulation automated<a href="#data-simulation-automated-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we’ve tested the data generating code, we can put it into a function so that it’s easy to run it repeatedly.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="kw">def</span> sim_data(n_subj<span class="op">=</span><span class="dv">25</span>, n_pop<span class="op">=</span><span class="dv">15</span>, n_rock<span class="op">=</span><span class="dv">15</span>, beta_0<span class="op">=</span><span class="dv">60</span>, beta_1<span class="op">=</span><span class="dv">5</span>, omega_0<span class="op">=</span><span class="dv">3</span>, tau_0<span class="op">=</span><span class="dv">7</span>, tau_1<span class="op">=</span><span class="dv">4</span>, rho<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="dv">8</span>):</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>    songs <span class="op">=</span> pd.DataFrame({</span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a>        <span class="st">&#39;song_id&#39;</span>: np.arange(n_pop <span class="op">+</span> n_rock),</span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>        <span class="st">&#39;category&#39;</span>: np.repeat([<span class="st">&quot;pop&quot;</span>, <span class="st">&quot;rock&quot;</span>], [n_pop, n_rock]),</span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a>        <span class="st">&#39;genre_i&#39;</span>: np.repeat([<span class="dv">0</span>, <span class="dv">1</span>], [n_pop, n_rock]),</span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a>        <span class="st">&#39;O_0i&#39;</span>: np.random.normal(<span class="dv">0</span>, omega_0, n_pop <span class="op">+</span> n_rock)</span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a>    })</span>
<span id="cb64-8"><a href="#cb64-8" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" tabindex="-1"></a>    random_effects <span class="op">=</span> np.random.multivariate_normal([<span class="dv">0</span>, <span class="dv">0</span>], [[tau_0<span class="op">**</span><span class="dv">2</span>, rho<span class="op">*</span>tau_0<span class="op">*</span>tau_1], [rho<span class="op">*</span>tau_0<span class="op">*</span>tau_1, tau_1<span class="op">**</span><span class="dv">2</span>]], n_subj)</span>
<span id="cb64-10"><a href="#cb64-10" tabindex="-1"></a>    subjects <span class="op">=</span> pd.DataFrame(random_effects, columns<span class="op">=</span>[<span class="st">&#39;T_0j&#39;</span>, <span class="st">&#39;T_1j&#39;</span>])</span>
<span id="cb64-11"><a href="#cb64-11" tabindex="-1"></a>    subjects[<span class="st">&#39;subj_id&#39;</span>] <span class="op">=</span> np.arange(<span class="dv">1</span>, n_subj <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb64-12"><a href="#cb64-12" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" tabindex="-1"></a>    trials <span class="op">=</span> pd.merge(subjects, songs, how<span class="op">=</span><span class="st">&#39;cross&#39;</span>)</span>
<span id="cb64-14"><a href="#cb64-14" tabindex="-1"></a>    trials[<span class="st">&#39;e_ij&#39;</span>] <span class="op">=</span> np.random.normal(<span class="dv">0</span>, sigma, <span class="bu">len</span>(trials))</span>
<span id="cb64-15"><a href="#cb64-15" tabindex="-1"></a>    trials[<span class="st">&#39;liking_ij&#39;</span>] <span class="op">=</span> beta_0 <span class="op">+</span> trials[<span class="st">&#39;T_0j&#39;</span>] <span class="op">+</span> trials[<span class="st">&#39;O_0i&#39;</span>] <span class="op">+</span> (beta_1 <span class="op">+</span> trials[<span class="st">&#39;T_1j&#39;</span>]) <span class="op">*</span> trials[<span class="st">&#39;genre_i&#39;</span>] <span class="op">+</span> trials[<span class="st">&#39;e_ij&#39;</span>]</span>
<span id="cb64-16"><a href="#cb64-16" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" tabindex="-1"></a>    <span class="cf">return</span> trials[[<span class="st">&#39;subj_id&#39;</span>, <span class="st">&#39;song_id&#39;</span>, <span class="st">&#39;category&#39;</span>, <span class="st">&#39;genre_i&#39;</span>, <span class="st">&#39;liking_ij&#39;</span>]]</span></code></pre></div>
</div>
<div id="power-calculation-single-run-1" class="section level2 hasAnchor" number="5.4">
<h2 class="hasAnchor"><span class="header-section-number">5.4</span> Power calculation single run<a href="#power-calculation-single-run-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can wrap the data generating function and modeling code in a new function single_run() that returns a table of the analysis results for a single simulation run.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a><span class="kw">def</span> single_run(n_subj<span class="op">=</span><span class="dv">25</span>, n_pop<span class="op">=</span><span class="dv">15</span>, n_rock<span class="op">=</span><span class="dv">15</span>, beta_0<span class="op">=</span><span class="dv">60</span>, beta_1<span class="op">=</span><span class="dv">5</span>, omega_0<span class="op">=</span><span class="dv">3</span>, tau_0<span class="op">=</span><span class="dv">7</span>, tau_1<span class="op">=</span><span class="dv">4</span>, rho<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="dv">8</span>):</span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>    dat_sim <span class="op">=</span> sim_data(n_subj, n_pop, n_rock, beta_0, beta_1, omega_0, tau_0, tau_1, rho, sigma)</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>    dat_sim[<span class="st">&#39;groups&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>    mod_sim <span class="op">=</span> smf.mixedlm(<span class="st">&#39;liking_ij ~ 1 + genre_i&#39;</span>, groups<span class="op">=</span>dat_sim[<span class="st">&#39;groups&#39;</span>],</span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a>                          vc_formula<span class="op">=</span>{<span class="st">&#39;song_id&#39;</span>:<span class="st">&#39;0 + C(song_id)&#39;</span>, <span class="st">&#39;subj_id&#39;</span>:<span class="st">&#39;0 + C(subj_id)&#39;</span>, <span class="st">&#39;genre_i&#39;</span>: <span class="st">&#39;0 + C(subj_id):genre_i&#39;</span>},</span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a>                          re_formula<span class="op">=</span><span class="st">&#39;0&#39;</span>, data<span class="op">=</span>dat_sim).fit()</span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" tabindex="-1"></a>    df <span class="op">=</span> mod_sim.summary().tables[<span class="dv">1</span>]</span>
<span id="cb65-10"><a href="#cb65-10" tabindex="-1"></a>    df[<span class="st">&#39;p_value&#39;</span>] <span class="op">=</span> mod_sim.pvalues</span>
<span id="cb65-11"><a href="#cb65-11" tabindex="-1"></a>    <span class="cf">return</span> df[[<span class="st">&#39;Coef.&#39;</span>, <span class="st">&#39;Std.Err.&#39;</span>, <span class="st">&#39;p_value&#39;</span>]]</span></code></pre></div>
<p>Let’s test that our new single_run() function performs as expected.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a><span class="co"># run one model with default parameters</span></span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a><span class="bu">print</span>(single_run())</span></code></pre></div>
<pre><code>##               Coef. Std.Err.   p_value
## Intercept    62.364    1.620  0.000000
## genre_i       1.794    1.454  0.217012
## genre_i Var  15.056    0.854  0.027138
## song_id Var   8.783    0.387  0.004477
## subj_id Var  46.691    1.848  0.001541</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="co"># run one model with new parameters</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a><span class="bu">print</span>(single_run(n_pop <span class="op">=</span> <span class="dv">10</span>, n_rock <span class="op">=</span> <span class="dv">50</span>, beta_1 <span class="op">=</span> <span class="dv">2</span>))</span></code></pre></div>
<pre><code>##               Coef. Std.Err.        p_value
## Intercept    60.065    1.635  1.824465e-295
## genre_i       2.934    1.308   2.494009e-02
## genre_i Var  14.922    0.811   1.634819e-02
## song_id Var   6.946    0.230   8.011783e-05
## subj_id Var  43.595    1.826   1.830974e-03</code></pre>
</div>
<div id="power-calculation-automated-1" class="section level2 hasAnchor" number="5.5">
<h2 class="hasAnchor"><span class="header-section-number">5.5</span> Power calculation automated<a href="#power-calculation-automated-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To get an accurate estimation of power, we need to run the simulation many times. Here we use the package dask to parallelize existing code to speed up iterative processes.</p>
<p>We use dask.delayed function to decorate single_run() so that it operates lazily, then call the delayed version repeatedly using for statement, and finally call dask.compute function to get the result of simulations.</p>
<p>Note: There are two differences between Python and the R:</p>
<ol style="list-style-type: decimal">
<li>The R uses the “future_map_dfr() function” to use the single_run() function in a loop, and Python directly uses the “for” structure to do a loop;</li>
<li>The R sets parallel computing in the setup part, while Python uses the “dask” library for parallel computing.</li>
</ol>
<div class="sourceCode" id="cb70"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>client <span class="op">=</span> Client()</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a><span class="kw">def</span> delayed_single_run(n_subj<span class="op">=</span><span class="dv">25</span>, n_pop<span class="op">=</span><span class="dv">15</span>, n_rock<span class="op">=</span><span class="dv">15</span>, beta_0<span class="op">=</span><span class="dv">60</span>, beta_1<span class="op">=</span><span class="dv">5</span>, omega_0<span class="op">=</span><span class="dv">3</span>, tau_0<span class="op">=</span><span class="dv">7</span>, tau_1<span class="op">=</span><span class="dv">4</span>, rho<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="dv">8</span>):</span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a>    df <span class="op">=</span> single_run(n_subj, n_pop, n_rock, beta_0, beta_1, omega_0, tau_0, tau_1, rho, sigma)</span>
<span id="cb70-6"><a href="#cb70-6" tabindex="-1"></a>    df <span class="op">=</span> df.assign(n_subj<span class="op">=</span>n_subj, n_pop<span class="op">=</span>n_pop, n_rock<span class="op">=</span>n_rock, beta_1<span class="op">=</span>beta_1)</span>
<span id="cb70-7"><a href="#cb70-7" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb70-8"><a href="#cb70-8" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" tabindex="-1"></a>sims <span class="op">=</span> [delayed_single_run() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(reps)]</span>
<span id="cb70-10"><a href="#cb70-10" tabindex="-1"></a>sims_result <span class="op">=</span> client.gather(client.compute(sims))</span>
<span id="cb70-11"><a href="#cb70-11" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" tabindex="-1"></a>sims_df <span class="op">=</span> pd.concat(sims_result).reset_index().rename(columns<span class="op">=</span>{<span class="st">&#39;index&#39;</span>:<span class="st">&#39;term&#39;</span>})</span></code></pre></div>
<p>We can finally calculate power for our parameter of interest <span class="math inline">\(\beta_1\)</span> denoted in the model output table as the term <span class="math inline">\(genre_{i}\)</span> by filtering to keep only that term and the calculating the proportion of times the <span class="math inline">\(p\)</span>-value is below the alpha (0.05) threshold.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>genre_i_sims <span class="op">=</span> sims_df[sims_df[<span class="st">&#39;term&#39;</span>] <span class="op">==</span> <span class="st">&#39;genre_i&#39;</span>]</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>mean_estimate <span class="op">=</span> genre_i_sims[<span class="st">&#39;Coef.&#39;</span>].astype(<span class="bu">float</span>).mean()</span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a>mean_se <span class="op">=</span> genre_i_sims[<span class="st">&#39;Std.Err.&#39;</span>].astype(<span class="bu">float</span>).mean()</span>
<span id="cb71-4"><a href="#cb71-4" tabindex="-1"></a>power <span class="op">=</span> (genre_i_sims[<span class="st">&#39;p_value&#39;</span>].astype(<span class="bu">float</span>) <span class="op">&lt;</span> alpha).mean()</span>
<span id="cb71-5"><a href="#cb71-5" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Mean estimate: </span><span class="sc">{</span>mean_estimate<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean estimate: 4.964333333333332</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Mean standard error: </span><span class="sc">{</span>mean_se<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean standard error: 1.5052333333333332</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Power: </span><span class="sc">{</span>power<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>## Power: 0.9333333333333333</code></pre>
<div id="check-false-positive-rate-1" class="section level3 hasAnchor" number="5.5.1">
<h3 class="hasAnchor"><span class="header-section-number">5.5.1</span> Check false positive rate<a href="#check-false-positive-rate-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can do a sanity check to see if our simulation is performing as expected by checking the false positive rate (Type I error rate). We set the effect of genre_ij (beta_1) to 0 to calculate the false positive rate, which is the probability of concluding there is an effect when there is no actual effect in the population.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a>sims_fp <span class="op">=</span> [delayed_single_run(beta_1<span class="op">=</span><span class="dv">0</span>) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(reps)]</span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>sims_fp_result <span class="op">=</span> client.gather(client.compute(sims_fp))</span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a>sims_fp_df <span class="op">=</span> pd.concat(sims_fp_result).reset_index().rename(columns<span class="op">=</span>{<span class="st">&#39;index&#39;</span>:<span class="st">&#39;term&#39;</span>})</span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a><span class="bu">print</span>((sims_fp_df[sims_fp_df[<span class="st">&#39;term&#39;</span>] <span class="op">==</span> <span class="st">&#39;genre_i&#39;</span>][<span class="st">&#39;p_value&#39;</span>].astype(<span class="bu">float</span>) <span class="op">&lt;</span> alpha).mean())</span></code></pre></div>
<pre><code>## 0.0</code></pre>
<p>Ideally, the false positive rate will be equal to alpha, which we set at 0.05.</p>
</div>
</div>
<div id="power-for-different-effect-sizes-1" class="section level2 hasAnchor" number="5.6">
<h2 class="hasAnchor"><span class="header-section-number">5.6</span> Power for different effect sizes<a href="#power-for-different-effect-sizes-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In real life, we will not know the effect size of our quantity of interest and so we will need to repeatedly perform the power analysis over a range of different plausible effect sizes. Perhaps we might also want to calculate power as we vary other data-generating parameters, such as the number of pop and rock songs sampled and the number of subjects sampled. We can create a table that combines all combinations of the parameters we want to vary in a grid.</p>
<p>Note: There are two differences between Python and the R:</p>
<ol style="list-style-type: decimal">
<li>Python uses the “product” function to permutate and combine parameters and then uses “loop” and “dask.compute” to perform parallel computing;</li>
<li>Python couldn’t repeatedly use parameter_search() and instead uses two layers of the loop to realize multiple simulations of each permutation and combination of parameters.</li>
</ol>
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a> <span class="co"># grid of parameter values of interest</span></span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb80-3"><a href="#cb80-3" tabindex="-1"></a>    <span class="st">&#39;n_subj&#39;</span>: [<span class="dv">10</span>, <span class="dv">50</span>],</span>
<span id="cb80-4"><a href="#cb80-4" tabindex="-1"></a>    <span class="st">&#39;n_pop&#39;</span>: [<span class="dv">10</span>, <span class="dv">40</span>],</span>
<span id="cb80-5"><a href="#cb80-5" tabindex="-1"></a>    <span class="st">&#39;n_rock&#39;</span>: [<span class="dv">10</span>, <span class="dv">40</span>],</span>
<span id="cb80-6"><a href="#cb80-6" tabindex="-1"></a>    <span class="st">&#39;beta_1&#39;</span>: [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>]</span>
<span id="cb80-7"><a href="#cb80-7" tabindex="-1"></a>}</span></code></pre></div>
<p>We can now wrap delayed_single_run() function within a more general function parameter_search() that takes the grid of parameter values as input and uses the for a statement to iterate over each row of parameter values in pgrid and feed them into delayed_single_run().</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="co"># fit the models over the parameters</span></span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a><span class="kw">def</span> parameter_search(params):</span>
<span id="cb81-3"><a href="#cb81-3" tabindex="-1"></a>    sims <span class="op">=</span> []</span>
<span id="cb81-4"><a href="#cb81-4" tabindex="-1"></a>    pgrid <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(product(<span class="op">*</span>params.values())), columns<span class="op">=</span>params.keys())</span>
<span id="cb81-5"><a href="#cb81-5" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" tabindex="-1"></a>    <span class="co"># iterate over the grid of parameter values</span></span>
<span id="cb81-7"><a href="#cb81-7" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> pgrid.iterrows():</span>
<span id="cb81-8"><a href="#cb81-8" tabindex="-1"></a>        sims.append(delayed_single_run(</span>
<span id="cb81-9"><a href="#cb81-9" tabindex="-1"></a>            n_subj<span class="op">=</span>row[<span class="st">&#39;n_subj&#39;</span>], <span class="co"># plug each row of parameter values into single_run()</span></span>
<span id="cb81-10"><a href="#cb81-10" tabindex="-1"></a>            n_pop<span class="op">=</span>row[<span class="st">&#39;n_pop&#39;</span>],</span>
<span id="cb81-11"><a href="#cb81-11" tabindex="-1"></a>            n_rock<span class="op">=</span>row[<span class="st">&#39;n_rock&#39;</span>],</span>
<span id="cb81-12"><a href="#cb81-12" tabindex="-1"></a>            beta_1<span class="op">=</span>row[<span class="st">&#39;beta_1&#39;</span>]</span>
<span id="cb81-13"><a href="#cb81-13" tabindex="-1"></a>        ))</span>
<span id="cb81-14"><a href="#cb81-14" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(client.gather(client.compute(sims))).reset_index().rename(columns<span class="op">=</span>{<span class="st">&#39;index&#39;</span>:<span class="st">&#39;term&#39;</span>})</span></code></pre></div>
<p>If we call parameter_search(), it will return a single replication of simulations for each combination of parameter values in pgrid.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a><span class="bu">print</span>(parameter_search(params))</span></code></pre></div>
<pre><code>##             term    Coef. Std.Err.       p_value  n_subj  n_pop  n_rock  beta_1
## 0      Intercept   57.106    3.631  9.647402e-56      10     10      10       1
## 1        genre_i    0.757    1.940  6.964514e-01      10     10      10       1
## 2    genre_i Var   12.208    2.044  4.799640e-01      10     10      10       1
## 3    song_id Var    5.574    0.396  9.570569e-02      10     10      10       1
## 4    subj_id Var  119.101   10.909  1.965629e-01      10     10      10       1
## ..           ...      ...      ...           ...     ...    ...     ...     ...
## 115    Intercept   60.531    1.263  0.000000e+00      50     40      40       5
## 116      genre_i    6.863    1.012  1.172492e-11      50     40      40       5
## 117  genre_i Var   15.101    0.501  1.229941e-04      50     40      40       5
## 118  song_id Var   13.197    0.665  1.142963e-02      50     40      40       5
## 119  subj_id Var   61.752    1.665  2.278029e-06      50     40      40       5
## 
## [120 rows x 8 columns]</code></pre>
<p>To run multiple replications of simulations for each combination of parameter values in pgrid, we can use the for a statement to iterate over each row of parameter values in pgrid for the number of times specified by reps. Fair warning: this will take some time if you have set a high number of replications!</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a>sims_params <span class="op">=</span> []</span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a>pgrid <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(product(<span class="op">*</span>params.values())), columns<span class="op">=</span>params.keys())</span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(reps):</span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> pgrid.iterrows():</span>
<span id="cb84-6"><a href="#cb84-6" tabindex="-1"></a>        sims_params.append(delayed_single_run(</span>
<span id="cb84-7"><a href="#cb84-7" tabindex="-1"></a>            n_subj<span class="op">=</span>row[<span class="st">&#39;n_subj&#39;</span>],</span>
<span id="cb84-8"><a href="#cb84-8" tabindex="-1"></a>            n_pop<span class="op">=</span>row[<span class="st">&#39;n_pop&#39;</span>],</span>
<span id="cb84-9"><a href="#cb84-9" tabindex="-1"></a>            n_rock<span class="op">=</span>row[<span class="st">&#39;n_rock&#39;</span>],</span>
<span id="cb84-10"><a href="#cb84-10" tabindex="-1"></a>            beta_1<span class="op">=</span>row[<span class="st">&#39;beta_1&#39;</span>]</span>
<span id="cb84-11"><a href="#cb84-11" tabindex="-1"></a>        ))</span>
<span id="cb84-12"><a href="#cb84-12" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" tabindex="-1"></a>sims_params_result <span class="op">=</span> client.gather(client.compute(sims_params))</span>
<span id="cb84-14"><a href="#cb84-14" tabindex="-1"></a></span>
<span id="cb84-15"><a href="#cb84-15" tabindex="-1"></a>sims_params_df <span class="op">=</span> pd.concat(sims_params_result).reset_index().rename(columns<span class="op">=</span>{<span class="st">&#39;index&#39;</span>:<span class="st">&#39;term&#39;</span>})</span>
<span id="cb84-16"><a href="#cb84-16" tabindex="-1"></a>client.close()</span>
<span id="cb84-17"><a href="#cb84-17" tabindex="-1"></a><span class="bu">print</span>(sims_params_df)</span></code></pre></div>
<pre><code>##              term   Coef. Std.Err.        p_value  n_subj  n_pop  n_rock  beta_1
## 0       Intercept  63.117    2.060  3.021081e-206      10     10      10       1
## 1         genre_i   1.195    2.225   5.911703e-01      10     10      10       1
## 2     genre_i Var  33.604    3.001   1.776420e-01      10     10      10       1
## 3     song_id Var   1.062    0.317   6.864873e-01      10     10      10       1
## 4     subj_id Var  34.457    2.413   8.561448e-02      10     10      10       1
## ...           ...     ...      ...            ...     ...    ...     ...     ...
## 3595    Intercept  59.894    1.177   0.000000e+00      50     40      40       5
## 3596      genre_i   5.417    0.985   3.777745e-08      50     40      40       5
## 3597  genre_i Var  16.871    0.510   3.344605e-05      50     40      40       5
## 3598  song_id Var  11.375    0.257   2.675493e-08      50     40      40       5
## 3599  subj_id Var  53.483    1.403   1.700990e-06      50     40      40       5
## 
## [3600 rows x 8 columns]</code></pre>
<p>Now, as before, we can calculate power. But this time, we’ll group by all of the parameters we manipulated in pgrid, so we can get power estimates for all combinations of parameter values.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a>sims_table <span class="op">=</span> sims_params_df.query(<span class="st">&quot;term == &#39;genre_i&#39;&quot;</span>).groupby([<span class="st">&#39;term&#39;</span>, <span class="st">&#39;n_subj&#39;</span>, <span class="st">&#39;n_pop&#39;</span>, <span class="st">&#39;n_rock&#39;</span>, <span class="st">&#39;beta_1&#39;</span>]).agg(</span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a>    mean_estimate<span class="op">=</span>pd.NamedAgg(column<span class="op">=</span><span class="st">&#39;Coef.&#39;</span>, aggfunc<span class="op">=</span><span class="kw">lambda</span> x: x.astype(<span class="bu">float</span>).mean()),</span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a>    mean_se<span class="op">=</span>pd.NamedAgg(column<span class="op">=</span><span class="st">&#39;Std.Err.&#39;</span>, aggfunc<span class="op">=</span><span class="kw">lambda</span> x: x.astype(<span class="bu">float</span>).mean()),</span>
<span id="cb86-4"><a href="#cb86-4" tabindex="-1"></a>    power<span class="op">=</span>pd.NamedAgg(column<span class="op">=</span><span class="st">&#39;p_value&#39;</span>, aggfunc<span class="op">=</span><span class="kw">lambda</span> x: (x.astype(<span class="bu">float</span>) <span class="op">&lt;</span> alpha).mean())</span>
<span id="cb86-5"><a href="#cb86-5" tabindex="-1"></a>).reset_index()</span></code></pre></div>
<p>Here’s a formatted table that summarizes the output from the power simulation.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="bu">print</span>(sims_table)</span></code></pre></div>
<pre><code>##        term  n_subj  n_pop  n_rock  beta_1  mean_estimate   mean_se     power
## 0   genre_i      10     10      10       1       1.860233  2.304167  0.166667
## 1   genre_i      10     10      10       3       3.383000  2.432767  0.300000
## 2   genre_i      10     10      10       5       4.579733  2.228967  0.466667
## 3   genre_i      10     10      40       1       0.680567  2.163200  0.000000
## 4   genre_i      10     10      40       3       3.212333  2.110667  0.266667
## 5   genre_i      10     10      40       5       5.592100  2.128300  0.700000
## 6   genre_i      10     40      10       1       1.128000  2.343100  0.033333
## 7   genre_i      10     40      10       3       2.836500  2.169833  0.200000
## 8   genre_i      10     40      10       5       4.934800  2.084233  0.733333
## 9   genre_i      10     40      40       1       0.510267  1.935767  0.000000
## 10  genre_i      10     40      40       3       2.840867  2.012100  0.266667
## 11  genre_i      10     40      40       5       4.764300  2.111433  0.600000
## 12  genre_i      50     10      10       1       0.602800  1.575633  0.066667
## 13  genre_i      50     10      10       3       2.496633  1.609067  0.400000
## 14  genre_i      50     10      10       5       5.187467  1.557300  0.900000
## 15  genre_i      50     10      40       1       0.443700  1.420800  0.033333
## 16  genre_i      50     10      40       3       2.930000  1.382433  0.566667
## 17  genre_i      50     10      40       5       5.353533  1.340100  0.966667
## 18  genre_i      50     40      10       1       0.953367  1.361667  0.066667
## 19  genre_i      50     40      10       3       3.229233  1.425400  0.633333
## 20  genre_i      50     40      10       5       5.421800  1.373667  1.000000
## 21  genre_i      50     40      40       1       1.010533  0.995900  0.166667
## 22  genre_i      50     40      40       3       3.082200  0.990033  0.866667
## 23  genre_i      50     40      40       5       4.902833  0.998700  1.000000</code></pre>
<p>Here’s a graph that visualizes the output of the power simulation.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="co"># transform data type and create labels</span></span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>sims_table[<span class="st">&#39;n_subj&#39;</span>] <span class="op">=</span> sims_table[<span class="st">&#39;n_subj&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a>sims_table[<span class="st">&#39;n_pop&#39;</span>] <span class="op">=</span> <span class="st">&#39;n_pop: &#39;</span> <span class="op">+</span> sims_table[<span class="st">&#39;n_pop&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb89-4"><a href="#cb89-4" tabindex="-1"></a>sims_table[<span class="st">&#39;n_rock&#39;</span>] <span class="op">=</span> <span class="st">&#39;n_rock: &#39;</span> <span class="op">+</span> sims_table[<span class="st">&#39;n_rock&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb89-5"><a href="#cb89-5" tabindex="-1"></a></span>
<span id="cb89-6"><a href="#cb89-6" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb89-7"><a href="#cb89-7" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="bu">len</span>(sims_table[<span class="st">&#39;n_pop&#39;</span>].unique()), <span class="bu">len</span>(sims_table[<span class="st">&#39;n_rock&#39;</span>].unique()), figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-8"><a href="#cb89-8" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb89-9"><a href="#cb89-9" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb89-11"><a href="#cb89-11" tabindex="-1"></a><span class="cf">for</span> i, (pop, rock) <span class="kw">in</span> <span class="bu">enumerate</span>(sims_table.groupby([<span class="st">&#39;n_pop&#39;</span>, <span class="st">&#39;n_rock&#39;</span>])):</span>
<span id="cb89-12"><a href="#cb89-12" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb89-13"><a href="#cb89-13" tabindex="-1"></a>    sns.lineplot(data<span class="op">=</span>rock, x<span class="op">=</span><span class="st">&#39;mean_estimate&#39;</span>, y<span class="op">=</span><span class="st">&#39;power&#39;</span>, hue<span class="op">=</span><span class="st">&#39;n_subj&#39;</span>, style<span class="op">=</span><span class="st">&#39;n_subj&#39;</span>, markers<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb89-14"><a href="#cb89-14" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="fl">0.8</span>, linestyle<span class="op">=</span><span class="st">&#39;dashed&#39;</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb89-15"><a href="#cb89-15" tabindex="-1"></a>    <span class="co"># ax.set_title(f&#39;{pop} x {rock}&#39;)</span></span>
<span id="cb89-16"><a href="#cb89-16" tabindex="-1"></a>    ax.set_xlabel(<span class="st">&#39;Effect size (rock genre - pop genre)&#39;</span>)</span>
<span id="cb89-17"><a href="#cb89-17" tabindex="-1"></a>    ax.set_ylabel(<span class="st">&#39;Power&#39;</span>)</span>
<span id="cb89-18"><a href="#cb89-18" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb89-19"><a href="#cb89-19" tabindex="-1"></a>    ax.legend(title<span class="op">=</span><span class="st">&#39;Sample size&#39;</span>)</span></code></pre></div>
<pre><code>## &lt;Axes: xlabel=&#39;mean_estimate&#39;, ylabel=&#39;power&#39;&gt;
## &lt;matplotlib.lines.Line2D object at 0x000002061718C210&gt;
## Text(0.5, 0, &#39;Effect size (rock genre - pop genre)&#39;)
## Text(0, 0.5, &#39;Power&#39;)
## (0.0, 1.0)
## &lt;matplotlib.legend.Legend object at 0x00000206174536D0&gt;
## &lt;Axes: xlabel=&#39;mean_estimate&#39;, ylabel=&#39;power&#39;&gt;
## &lt;matplotlib.lines.Line2D object at 0x0000020617E1B950&gt;
## Text(0.5, 0, &#39;Effect size (rock genre - pop genre)&#39;)
## Text(0, 0.5, &#39;Power&#39;)
## (0.0, 1.0)
## &lt;matplotlib.legend.Legend object at 0x0000020616B8C150&gt;
## &lt;Axes: xlabel=&#39;mean_estimate&#39;, ylabel=&#39;power&#39;&gt;
## &lt;matplotlib.lines.Line2D object at 0x0000020616FCC150&gt;
## Text(0.5, 0, &#39;Effect size (rock genre - pop genre)&#39;)
## Text(0, 0.5, &#39;Power&#39;)
## (0.0, 1.0)
## &lt;matplotlib.legend.Legend object at 0x0000020616BFB190&gt;
## &lt;Axes: xlabel=&#39;mean_estimate&#39;, ylabel=&#39;power&#39;&gt;
## &lt;matplotlib.lines.Line2D object at 0x0000020616B8CB50&gt;
## Text(0.5, 0, &#39;Effect size (rock genre - pop genre)&#39;)
## Text(0, 0.5, &#39;Power&#39;)
## (0.0, 1.0)
## &lt;matplotlib.legend.Legend object at 0x0000020616FCBA90&gt;</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a><span class="co"># layout adjustmentS</span></span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb91-3"><a href="#cb91-3" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" tabindex="-1"></a><span class="co"># show the plot</span></span>
<span id="cb91-5"><a href="#cb91-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="figures/unnamed-chunk-30-3.png" width="1152" /></p>
<!--chapter:end:05_Python.Rmd-->
</div>
</div>
<div id="stata" class="section level1 hasAnchor" number="6">
<h1 class="hasAnchor"><span class="header-section-number">6</span> Stata<a href="#stata" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="setup-2" class="section level2 hasAnchor" number="6.1">
<h2 class="hasAnchor"><span class="header-section-number">6.1</span> Setup<a href="#setup-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will need several Stata packages to draw a violin plot. We can use “ssc install [package_name]” to install them.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a><span class="co">// ssc install violinplot, replace     // module to draw violin plots</span></span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a><span class="co">// ssc install dstat, replace          // violinplot&#39;s dependency, module to compute summary statistics</span></span>
<span id="cb92-3"><a href="#cb92-3" tabindex="-1"></a><span class="co">// ssc install moremata, replace       // violinplot&#39;s dependency, module (Mata) to provide various functions</span></span>
<span id="cb92-4"><a href="#cb92-4" tabindex="-1"></a><span class="co">// ssc install palettes, replace       // violinplot&#39;s dependency, module to provide color palettes</span></span>
<span id="cb92-5"><a href="#cb92-5" tabindex="-1"></a><span class="co">// ssc install colrspace, replace      // violinplot&#39;s dependency, module providing a class-based color management system in Mata</span></span></code></pre></div>
<p>We will also set the pseudo-random number generator seed to <code>02138</code> to make the stochastic components of our simulations reproducible (this is similar to the process in R and Python).</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a><span class="kw">clear</span> <span class="ot">all</span></span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a><span class="kw">set</span> <span class="dv">seed</span> 02138</span></code></pre></div>
</div>
<div id="data-simulation-step-by-step-2" class="section level2 hasAnchor" number="6.2">
<h2 class="hasAnchor"><span class="header-section-number">6.2</span> Data simulation step by step<a href="#data-simulation-step-by-step-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To give an overview of the power simulation task, we will simulate data from a design with crossed random factors of subjects and songs (see <a href="./power-of-what.html">Power of What?</a> for design details), fit a model to the simulated data, recover from the model output the parameter values we put in, calculate power, and finally automate the whole process so that we can calculate power for different effect sizes. ### Establish the simulation parameters</p>
<p>Before we start, let’s set some global parameters for our power simulations.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a><span class="co">// number of simulation replications for power calculation</span></span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a><span class="kw">global</span> reps = 30</span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a><span class="co">// specified alpha for power calculation</span></span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a><span class="kw">global</span> <span class="kw">alpha</span> = 0.05</span></code></pre></div>
<div id="establish-the-data-generating-parameters-2" class="section level3 hasAnchor" number="6.2.1">
<h3 class="hasAnchor"><span class="header-section-number">6.2.1</span> Establish the data-generating parameters<a href="#establish-the-data-generating-parameters-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first thing to do is to set up the parameters that govern the process we assume gave rise to the data - the <em>data-generating process</em>, or DGP. We previously decided upon the data-generating parameters (see <a href="./power-of-what.html">Power of What?</a>), so we just need to code them here.</p>
<p>Note: There is a difference between Stata and R and Python: We decrease the data-generating parameters to simplify our model, and we delete some parameters: by-song random intercept <code>omega_0</code>, by-subject random slope sd <code>tau_1</code>, and the correlation between intercept and slope <code>rho</code>.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="co">// set all data-generating parameters</span></span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a><span class="kw">global</span> beta_0 = 60   <span class="co">// intercept; i.e., the grand mean</span></span>
<span id="cb95-3"><a href="#cb95-3" tabindex="-1"></a><span class="kw">global</span> beta_1 = 5    <span class="co">// slope; i.e., effect of category</span></span>
<span id="cb95-4"><a href="#cb95-4" tabindex="-1"></a><span class="kw">global</span> tau_0 = 7     <span class="co">// by-subject random intercept sd</span></span>
<span id="cb95-5"><a href="#cb95-5" tabindex="-1"></a><span class="kw">global</span> sigma = 8     <span class="co">// residual (error) sd</span></span></code></pre></div>
</div>
<div id="simulate-the-sampling-process-2" class="section level3 hasAnchor" number="6.2.2">
<h3 class="hasAnchor"><span class="header-section-number">6.2.2</span> Simulate the sampling process<a href="#simulate-the-sampling-process-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we will simulate the sampling process for the data. First, let’s define parameters related to the number of observations.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a><span class="co">// Set number of subjects and songs</span></span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a><span class="kw">global</span> n_subj = 25   <span class="co">// number of subjects</span></span>
<span id="cb96-3"><a href="#cb96-3" tabindex="-1"></a><span class="kw">global</span> n_pop = 15    <span class="co">// number of songs in pop category</span></span>
<span id="cb96-4"><a href="#cb96-4" tabindex="-1"></a><span class="kw">global</span> n_rock = 15   <span class="co">// number of songs in rock category</span></span>
<span id="cb96-5"><a href="#cb96-5" tabindex="-1"></a><span class="kw">global</span> n_all = <span class="ot">$n_pop</span> + <span class="ot">$n_rock</span></span></code></pre></div>
<div id="simulate-the-sampling-of-songs-2" class="section level4 hasAnchor" number="6.2.2.1">
<h4 class="hasAnchor"><span class="header-section-number">6.2.2.1</span> Simulate the sampling of songs<a href="#simulate-the-sampling-of-songs-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We need to create a table listing each song <span class="math inline">\(i\)</span>, which category it is in (<code>rock</code> or <code>pop</code>).</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a><span class="co">// simulate a sample of songs</span></span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb97-3"><a href="#cb97-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb97-4"><a href="#cb97-4" tabindex="-1"></a>  <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">$n_all</span></span>
<span id="cb97-5"><a href="#cb97-5" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" tabindex="-1"></a>  <span class="co">// Generate a sequence of song ids</span></span>
<span id="cb97-7"><a href="#cb97-7" tabindex="-1"></a>  <span class="kw">gen</span> song_id = <span class="dt">_n</span></span>
<span id="cb97-8"><a href="#cb97-8" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" tabindex="-1"></a>  <span class="co">// Generate the category variable</span></span>
<span id="cb97-10"><a href="#cb97-10" tabindex="-1"></a>  <span class="kw">gen</span> category = <span class="st">&quot;pop&quot;</span></span>
<span id="cb97-11"><a href="#cb97-11" tabindex="-1"></a>  <span class="kw">replace</span> category = <span class="st">&quot;rock&quot;</span> <span class="kw">if</span> song_id &gt; <span class="ot">$n_pop</span></span>
<span id="cb97-12"><a href="#cb97-12" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" tabindex="-1"></a>  <span class="co">// Generate the genre variable</span></span>
<span id="cb97-14"><a href="#cb97-14" tabindex="-1"></a>  <span class="kw">gen</span> genre_i = 0</span>
<span id="cb97-15"><a href="#cb97-15" tabindex="-1"></a>  <span class="kw">replace</span> genre_i = 1 <span class="kw">if</span> song_id &gt; <span class="ot">$n_pop</span></span>
<span id="cb97-16"><a href="#cb97-16" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" tabindex="-1"></a>  <span class="kw">gen</span> key = 1</span>
<span id="cb97-18"><a href="#cb97-18" tabindex="-1"></a></span>
<span id="cb97-19"><a href="#cb97-19" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/songs.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb97-20"><a href="#cb97-20" tabindex="-1"></a>}</span>
<span id="cb97-21"><a href="#cb97-21" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1/10</span></code></pre></div>
<pre><code>     | song_id   category   genre_i   key |
     |------------------------------------|
  1. |       1        pop         0     1 |
  2. |       2        pop         0     1 |
  3. |       3        pop         0     1 |
  4. |       4        pop         0     1 |
  5. |       5        pop         0     1 |
     |------------------------------------|
  6. |       6        pop         0     1 |
  7. |       7        pop         0     1 |
  8. |       8        pop         0     1 |
  9. |       9        pop         0     1 |
 10. |      10        pop         0     1 |
     +------------------------------------+</code></pre>
</div>
<div id="simulate-the-sampling-of-subjects-2" class="section level4 hasAnchor" number="6.2.2.2">
<h4 class="hasAnchor"><span class="header-section-number">6.2.2.2</span> Simulate the sampling of subjects<a href="#simulate-the-sampling-of-subjects-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now, we simulate the sampling of participants, which results in a table listing each individual and their random effect (a random intercept). To do this, we must sample <span class="math inline">\(t_0\)</span> from a normal distribution.</p>
<p>We will use the function <code>rnormal</code>, which generates a simulated value from a univariate normal distribution with a mean of 0 and a standard deviations of <code>tau_0</code> of each variable.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a><span class="co">// simulate a sample of subjects</span></span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb99-4"><a href="#cb99-4" tabindex="-1"></a>  <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">$n_subj</span></span>
<span id="cb99-5"><a href="#cb99-5" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" tabindex="-1"></a>  <span class="co">// Generate the by-subject random intercept</span></span>
<span id="cb99-7"><a href="#cb99-7" tabindex="-1"></a>  <span class="kw">gen</span> t0 = rnormal(0, <span class="ot">$tau_0</span>)</span>
<span id="cb99-8"><a href="#cb99-8" tabindex="-1"></a></span>
<span id="cb99-9"><a href="#cb99-9" tabindex="-1"></a>  <span class="co">// Generate a sequence of subject ids</span></span>
<span id="cb99-10"><a href="#cb99-10" tabindex="-1"></a>  <span class="kw">gen</span> subj_id = <span class="dt">_n</span></span>
<span id="cb99-11"><a href="#cb99-11" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" tabindex="-1"></a>  <span class="kw">gen</span> key = 1</span>
<span id="cb99-13"><a href="#cb99-13" tabindex="-1"></a></span>
<span id="cb99-14"><a href="#cb99-14" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/subjects.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb99-15"><a href="#cb99-15" tabindex="-1"></a>}</span>
<span id="cb99-16"><a href="#cb99-16" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1 / 10</span></code></pre></div>
<pre><code>     |        t0   subj_id   key |
     |---------------------------|
  1. |  4.356949         1     1 |
  2. |  .0887434         2     1 |
  3. |  .1867903         3     1 |
  4. |  11.24607         4     1 |
  5. | -1.842066         5     1 |
     |---------------------------|
  6. |  1.966723         6     1 |
  7. |  2.544997         7     1 |
  8. | -9.950144         8     1 |
  9. | -8.176116         9     1 |
 10. | -4.609569        10     1 |
     +---------------------------+</code></pre>
</div>
<div id="check-the-simulated-values-2" class="section level4 hasAnchor" number="6.2.2.3">
<h4 class="hasAnchor"><span class="header-section-number">6.2.2.3</span> Check the simulated values<a href="#check-the-simulated-values-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s do a quick sanity check by comparing our simulated values to the parameters we used as inputs. Because the sampling process is stochastic, we shouldn’t expect that these will exactly match for any given run of the simulation.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb101-2"><a href="#cb101-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/subjects.dta&quot;</span></span>
<span id="cb101-3"><a href="#cb101-3" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" tabindex="-1"></a>  <span class="kw">qui</span> <span class="kw">summarize</span> t0</span>
<span id="cb101-5"><a href="#cb101-5" tabindex="-1"></a>  <span class="kw">egen</span> tau_0_s = <span class="fu">sd</span>(t0)</span>
<span id="cb101-6"><a href="#cb101-6" tabindex="-1"></a>}</span>
<span id="cb101-7"><a href="#cb101-7" tabindex="-1"></a><span class="kw">display</span> <span class="st">&quot;tau_0, &quot;</span> <span class="ot">$tau_0</span> <span class="st">&quot;, &quot;</span> tau_0_s</span></code></pre></div>
<pre><code>tau_0, 7, 7.4337502</code></pre>
</div>
<div id="simulate-trials-2" class="section level4 hasAnchor" number="6.2.2.4">
<h4 class="hasAnchor"><span class="header-section-number">6.2.2.4</span> Simulate trials<a href="#simulate-trials-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Since all subjects rate all songs (i.e., the design is fully crossed), we can set up a table of trials by including every possible combination of the rows in the <code>subjects</code> and <code>songs</code> tables. Each test has a random error associated with it, reflecting fluctuations in trial-by-trial ratings due to unknown factors. We simulate this by sampling values from a univariate normal distribution with a mean of 0 and a standard deviation of <code>sigma</code>.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a><span class="co">// cross subject and song IDs; add an error term</span></span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb103-3"><a href="#cb103-3" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/subjects.dta&quot;</span></span>
<span id="cb103-4"><a href="#cb103-4" tabindex="-1"></a>  <span class="kw">cross</span> <span class="kw">using</span> <span class="st">&quot;./data/songs.dta&quot;</span></span>
<span id="cb103-5"><a href="#cb103-5" tabindex="-1"></a>  <span class="kw">drop</span> key</span>
<span id="cb103-6"><a href="#cb103-6" tabindex="-1"></a>  <span class="kw">sort</span> subj_id song_id</span>
<span id="cb103-7"><a href="#cb103-7" tabindex="-1"></a></span>
<span id="cb103-8"><a href="#cb103-8" tabindex="-1"></a>  <span class="kw">gen</span> e_ij = rnormal(0, <span class="ot">$sigma</span>)</span>
<span id="cb103-9"><a href="#cb103-9" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/data_sim_tmp.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb103-11"><a href="#cb103-11" tabindex="-1"></a>}</span>
<span id="cb103-12"><a href="#cb103-12" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1 / 10</span></code></pre></div>
<pre><code>     |       t0   subj_id   song_id   category   genre_i        e_ij |
     |---------------------------------------------------------------|
  1. | 4.356949         1         1        pop         0    4.979371 |
  2. | 4.356949         1         2        pop         0    .1014211 |
  3. | 4.356949         1         3        pop         0    .2134746 |
  4. | 4.356949         1         4        pop         0    12.85266 |
  5. | 4.356949         1         5        pop         0   -2.105218 |
     |---------------------------------------------------------------|
  6. | 4.356949         1         6        pop         0    2.247684 |
  7. | 4.356949         1         7        pop         0    2.908567 |
  8. | 4.356949         1         8        pop         0   -11.37159 |
  9. | 4.356949         1         9        pop         0   -9.344132 |
 10. | 4.356949         1        10        pop         0   -5.268079 |
     +---------------------------------------------------------------+</code></pre>
</div>
<div id="calculate-response-values-2" class="section level4 hasAnchor" number="6.2.2.5">
<h4 class="hasAnchor"><span class="header-section-number">6.2.2.5</span> Calculate response values<a href="#calculate-response-values-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>With this resulting <code>trials</code> table, in combination with the constants <code>beta_0</code> and <code>beta_1</code>, we have the full set of values that we need to compute the response variable <code>liking_ij</code> according to the linear model we defined previously (see <a href="./power-of-what.html">Power of What?</a>).</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/data_sim_tmp.dta&quot;</span></span>
<span id="cb105-3"><a href="#cb105-3" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" tabindex="-1"></a>  <span class="kw">gen</span> liking_ij = <span class="ot">$beta_0</span> + t0 +  <span class="ot">$beta_1</span>  * genre_i + e_ij</span>
<span id="cb105-5"><a href="#cb105-5" tabindex="-1"></a>  <span class="kw">keep</span> subj_id song_id category genre_i liking_ij</span>
<span id="cb105-6"><a href="#cb105-6" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/data_sim.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb105-8"><a href="#cb105-8" tabindex="-1"></a>}</span>
<span id="cb105-9"><a href="#cb105-9" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1 / 10</span></code></pre></div>
<pre><code>     | subj_id   song_id   category   genre_i   liking~j |
     |---------------------------------------------------|
  1. |       1         1        pop         0   69.33632 |
  2. |       1         2        pop         0   64.45837 |
  3. |       1         3        pop         0   64.57043 |
  4. |       1         4        pop         0    77.2096 |
  5. |       1         5        pop         0   62.25173 |
     |---------------------------------------------------|
  6. |       1         6        pop         0   66.60463 |
  7. |       1         7        pop         0   67.26552 |
  8. |       1         8        pop         0   52.98536 |
  9. |       1         9        pop         0   55.01282 |
 10. |       1        10        pop         0   59.08887 |
     +---------------------------------------------------+</code></pre>
</div>
<div id="plot-the-data-2" class="section level4 hasAnchor" number="6.2.2.6">
<h4 class="hasAnchor"><span class="header-section-number">6.2.2.6</span> Plot the data<a href="#plot-the-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s visualize the distribution of the response variable for each of the two song genres and superimpose the simulated parameter estimates for the means of these two groups.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/data_sim.dta&quot;</span></span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" tabindex="-1"></a>  <span class="co">// Set the palette colors</span></span>
<span id="cb107-5"><a href="#cb107-5" tabindex="-1"></a>  <span class="kw">local</span> <span class="kw">palette</span> <span class="st">&quot;orange dodgerblue&quot;</span></span>
<span id="cb107-6"><a href="#cb107-6" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" tabindex="-1"></a>  <span class="co">// Create a violin plot for actual data</span></span>
<span id="cb107-8"><a href="#cb107-8" tabindex="-1"></a>  violinplot liking_ij, <span class="bn">over</span>(category) colors(<span class="ot">`palette&#39;</span>) vertical <span class="kw">mean</span>(<span class="dv">type</span>(<span class="kw">line</span>) lp(<span class="kw">dash</span>) stat(<span class="kw">mean</span>)) <span class="bn">title</span>(<span class="st">&quot;Predicted versus simulated values&quot;</span>)</span>
<span id="cb107-9"><a href="#cb107-9" tabindex="-1"></a>  <span class="kw">graph</span> <span class="kw">export</span> <span class="st">&quot;./figures/violin.png&quot;</span>, <span class="kw">replace</span></span>
<span id="cb107-10"><a href="#cb107-10" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="figures/violin.png" /></p>
</div>
</div>
<div id="analyze-the-simulated-data-2" class="section level3 hasAnchor" number="6.2.3">
<h3 class="hasAnchor"><span class="header-section-number">6.2.3</span> Analyze the simulated data<a href="#analyze-the-simulated-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we can analyze our simulated data in a linear mixed effects model using the function <code>mixed</code>. The model formula in <code>mixed</code> maps how we calculated our <code>liking_ij</code> outcome variable above.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb108-1"><a href="#cb108-1" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">use</span> <span class="st">&quot;./data/data_sim_tmp.dta&quot;</span></span>
<span id="cb108-2"><a href="#cb108-2" tabindex="-1"></a>mixed liking_ij genre_i || subj_id:</span>
<span id="cb108-3"><a href="#cb108-3" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">estimates</span> <span class="kw">save</span> <span class="st">&quot;./data/data_sim_estimates.ster&quot;</span>, <span class="kw">replace</span></span></code></pre></div>
<pre><code>variable liking_ij not found
r(111);

end of do-file
r(111);</code></pre>
<p>The terms in the formula are as follows:</p>
<ul>
<li><code>liking_ij</code> is the response.</li>
<li><code>genre_i</code> is the dummy coded variable identifying whether song <span class="math inline">\(i\)</span> belongs to the pop or rock genre.</li>
<li><code>|| subj_id</code> specified a subject-specific random intercept (<code>t0</code>)</li>
</ul>
<p>Now we can estimate the model.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb110-1"><a href="#cb110-1" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">estimates</span> <span class="kw">use</span> <span class="st">&quot;./data/data_sim_estimates.ster&quot;</span></span>
<span id="cb110-2"><a href="#cb110-2" tabindex="-1"></a><span class="kw">quietly</span> <span class="fu">matrix</span> b = <span class="fu">e</span>(b)</span>
<span id="cb110-3"><a href="#cb110-3" tabindex="-1"></a><span class="fu">matrix</span> <span class="ot">list</span> b</span></code></pre></div>
<pre><code>b[1,4]
     liking_ij:  liking_ij:   lns1_1_1:    lnsig_e:
       genre_i       _cons       _cons       _cons
y1   5.1710617   60.229571   2.0205456   2.0902013</code></pre>
</div>
</div>
<div id="data-simulation-automated-2" class="section level2 hasAnchor" number="6.3">
<h2 class="hasAnchor"><span class="header-section-number">6.3</span> Data simulation automated<a href="#data-simulation-automated-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we’ve tested the data-generating code, we can put it into a function so that it’s easy to run it repeatedly.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb112-1"><a href="#cb112-1" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> sim_data</span>
<span id="cb112-2"><a href="#cb112-2" tabindex="-1"></a><span class="kw">program</span> <span class="kw">define</span> sim_data</span>
<span id="cb112-3"><a href="#cb112-3" tabindex="-1"></a>    <span class="kw">args</span> n_subj n_pop n_rock beta_0 beta_1 tau_0 sigma</span>
<span id="cb112-4"><a href="#cb112-4" tabindex="-1"></a></span>
<span id="cb112-5"><a href="#cb112-5" tabindex="-1"></a>  <span class="co">// simulate a sample of songs</span></span>
<span id="cb112-6"><a href="#cb112-6" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb112-7"><a href="#cb112-7" tabindex="-1"></a>    <span class="kw">local</span> n_all = <span class="ot">`n_pop&#39;</span> + <span class="ot">`n_rock&#39;</span></span>
<span id="cb112-8"><a href="#cb112-8" tabindex="-1"></a>    <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">`n_all&#39;</span></span>
<span id="cb112-9"><a href="#cb112-9" tabindex="-1"></a>    <span class="kw">gen</span> song_id = <span class="dt">_n</span></span>
<span id="cb112-10"><a href="#cb112-10" tabindex="-1"></a>    <span class="kw">gen</span> category = <span class="st">&quot;pop&quot;</span></span>
<span id="cb112-11"><a href="#cb112-11" tabindex="-1"></a>    <span class="kw">replace</span> category = <span class="st">&quot;rock&quot;</span> <span class="kw">if</span> song_id &gt; <span class="ot">`n_pop&#39;</span></span>
<span id="cb112-12"><a href="#cb112-12" tabindex="-1"></a>    <span class="kw">gen</span> genre_i = 0</span>
<span id="cb112-13"><a href="#cb112-13" tabindex="-1"></a>    <span class="kw">replace</span> genre_i = 1 <span class="kw">if</span> song_id &gt; <span class="ot">`n_pop&#39;</span></span>
<span id="cb112-14"><a href="#cb112-14" tabindex="-1"></a>    <span class="kw">gen</span> key = 1</span>
<span id="cb112-15"><a href="#cb112-15" tabindex="-1"></a>    <span class="kw">save</span> <span class="st">&quot;./data/songs.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb112-16"><a href="#cb112-16" tabindex="-1"></a></span>
<span id="cb112-17"><a href="#cb112-17" tabindex="-1"></a>  <span class="co">// simulate a sample of subjects</span></span>
<span id="cb112-18"><a href="#cb112-18" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb112-19"><a href="#cb112-19" tabindex="-1"></a>    <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">`n_subj&#39;</span></span>
<span id="cb112-20"><a href="#cb112-20" tabindex="-1"></a></span>
<span id="cb112-21"><a href="#cb112-21" tabindex="-1"></a>    <span class="kw">gen</span> t0 = rnormal(0, <span class="ot">`tau_0&#39;</span>)</span>
<span id="cb112-22"><a href="#cb112-22" tabindex="-1"></a>    <span class="kw">gen</span> subj_id = <span class="dt">_n</span></span>
<span id="cb112-23"><a href="#cb112-23" tabindex="-1"></a>    <span class="kw">gen</span> key = 1</span>
<span id="cb112-24"><a href="#cb112-24" tabindex="-1"></a>    <span class="kw">save</span> <span class="st">&quot;./data/subjects.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb112-25"><a href="#cb112-25" tabindex="-1"></a></span>
<span id="cb112-26"><a href="#cb112-26" tabindex="-1"></a>  <span class="co">// cross subject and song IDs</span></span>
<span id="cb112-27"><a href="#cb112-27" tabindex="-1"></a>    <span class="kw">use</span> <span class="st">&quot;./data/subjects.dta&quot;</span></span>
<span id="cb112-28"><a href="#cb112-28" tabindex="-1"></a>    <span class="kw">cross</span> <span class="kw">using</span> <span class="st">&quot;./data/songs.dta&quot;</span></span>
<span id="cb112-29"><a href="#cb112-29" tabindex="-1"></a>    <span class="kw">drop</span> key</span>
<span id="cb112-30"><a href="#cb112-30" tabindex="-1"></a>    <span class="kw">sort</span> subj_id song_id</span>
<span id="cb112-31"><a href="#cb112-31" tabindex="-1"></a>    <span class="kw">gen</span> e_ij = rnormal(0, <span class="ot">`sigma&#39;</span>)</span>
<span id="cb112-32"><a href="#cb112-32" tabindex="-1"></a></span>
<span id="cb112-33"><a href="#cb112-33" tabindex="-1"></a>    <span class="kw">gen</span> liking_ij = <span class="ot">`beta_0&#39;</span> + t0 + <span class="ot">`beta_1&#39;</span> * genre_i + e_ij</span>
<span id="cb112-34"><a href="#cb112-34" tabindex="-1"></a>    <span class="kw">keep</span> subj_id song_id category genre_i liking_ij</span>
<span id="cb112-35"><a href="#cb112-35" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<div id="power-calculation-single-run-2" class="section level2 hasAnchor" number="6.4">
<h2 class="hasAnchor"><span class="header-section-number">6.4</span> Power calculation single run<a href="#power-calculation-single-run-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can wrap the data-generating function and modeling code in a new function <code>single_run()</code> that returns the analysis results for a single simulation run. We’ll suppress warnings and messages from the modeling fitting process, as these sometimes occur with simulation runs that generate extremely realized values for parameters.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb113-1"><a href="#cb113-1" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> single_run</span>
<span id="cb113-2"><a href="#cb113-2" tabindex="-1"></a><span class="kw">program</span> <span class="kw">define</span> single_run, rclass</span>
<span id="cb113-3"><a href="#cb113-3" tabindex="-1"></a>    <span class="kw">args</span> n_subj n_pop n_rock beta_0 beta_1 tau_0 sigma</span>
<span id="cb113-4"><a href="#cb113-4" tabindex="-1"></a></span>
<span id="cb113-5"><a href="#cb113-5" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb113-6"><a href="#cb113-6" tabindex="-1"></a>    sim_data <span class="ot">`n_subj&#39;</span> <span class="ot">`n_pop&#39;</span> <span class="ot">`n_rock&#39;</span> <span class="ot">`beta_0&#39;</span> <span class="ot">`beta_1&#39;</span> <span class="ot">`tau_0&#39;</span> <span class="ot">`sigma&#39;</span></span>
<span id="cb113-7"><a href="#cb113-7" tabindex="-1"></a>    mixed liking_ij genre_i || subj_id:, <span class="kw">noretable</span> <span class="kw">nofetable</span> <span class="kw">noheader</span> <span class="kw">nogroup</span></span>
<span id="cb113-8"><a href="#cb113-8" tabindex="-1"></a></span>
<span id="cb113-9"><a href="#cb113-9" tabindex="-1"></a>  <span class="kw">estimates</span> <span class="kw">clear</span></span>
<span id="cb113-10"><a href="#cb113-10" tabindex="-1"></a>    <span class="kw">estimates</span> <span class="kw">store</span> model_results</span>
<span id="cb113-11"><a href="#cb113-11" tabindex="-1"></a></span>
<span id="cb113-12"><a href="#cb113-12" tabindex="-1"></a>  <span class="co">// calculate analysis results</span></span>
<span id="cb113-13"><a href="#cb113-13" tabindex="-1"></a>    <span class="fu">matrix</span> coefficients = <span class="fu">e</span>(b)</span>
<span id="cb113-14"><a href="#cb113-14" tabindex="-1"></a>    <span class="fu">matrix</span> std_errors = <span class="fu">e</span>(<span class="kw">V</span>)</span>
<span id="cb113-15"><a href="#cb113-15" tabindex="-1"></a>    <span class="fu">matrix</span> p_values = <span class="fu">e</span>(<span class="kw">p</span>)</span>
<span id="cb113-16"><a href="#cb113-16" tabindex="-1"></a></span>
<span id="cb113-17"><a href="#cb113-17" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">scalar</span> coef = coefficients[1, 1]</span>
<span id="cb113-18"><a href="#cb113-18" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">scalar</span> std_err = std_errors[1, 1]</span>
<span id="cb113-19"><a href="#cb113-19" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">scalar</span> p_value = p_values[1, 1]</span>
<span id="cb113-20"><a href="#cb113-20" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<pre><code>  4.         mixed liking_ij genre_i || subj_id:, noretable nofetable noheader 
&gt; nogroup
  5. </code></pre>
<p>Let’s test that our new <code>single_run()</code> function performs as expected.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb115-1"><a href="#cb115-1" tabindex="-1"></a><span class="co">// run one model with default parameters</span></span>
<span id="cb115-2"><a href="#cb115-2" tabindex="-1"></a><span class="kw">quietly</span> single_run 25 15 15 60 5 7 8</span>
<span id="cb115-3"><a href="#cb115-3" tabindex="-1"></a><span class="fu">return</span> <span class="ot">list</span></span></code></pre></div>
<pre><code>scalars:
            r(p_value) =  6.15504528650e-25
            r(std_err) =  .3467247369073205
               r(coef) =  6.072637593587212</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb117-1"><a href="#cb117-1" tabindex="-1"></a><span class="co">// run one model with new parameters</span></span>
<span id="cb117-2"><a href="#cb117-2" tabindex="-1"></a><span class="kw">quietly</span> single_run 25 10 50 60 2 7 8</span>
<span id="cb117-3"><a href="#cb117-3" tabindex="-1"></a><span class="fu">return</span> <span class="ot">list</span></span></code></pre></div>
<pre><code>scalars:
            r(p_value) =  .000521305877981
            r(std_err) =  .318005651218237
               r(coef) =  1.956555587768456</code></pre>
</div>
<div id="power-calculation-automated-2" class="section level2 hasAnchor" number="6.5">
<h2 class="hasAnchor"><span class="header-section-number">6.5</span> Power calculation automated<a href="#power-calculation-automated-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To get an accurate estimation of power, we need to run the simulation many times. Here, we use a matrix <code>results</code> to store the analysis results of each run.</p>
<p>We can finally calculate power for our parameter of interest <code>beta_1</code> by filtering to keep only that term and calculating the proportion of times the <span class="math inline">\(p\)</span>-value is below the <code>alpha</code> threshold.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb119-1"><a href="#cb119-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb119-2"><a href="#cb119-2" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb119-3"><a href="#cb119-3" tabindex="-1"></a>  <span class="fu">matrix</span> results = <span class="fu">J</span>(<span class="ot">$reps</span>, 3, .)</span>
<span id="cb119-4"><a href="#cb119-4" tabindex="-1"></a>  forval i = 1/<span class="ot">$reps</span> {</span>
<span id="cb119-5"><a href="#cb119-5" tabindex="-1"></a>    <span class="kw">quietly</span> single_run 25 15 15 60 5 7 8</span>
<span id="cb119-6"><a href="#cb119-6" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 1] = <span class="fu">r</span>(coef)</span>
<span id="cb119-7"><a href="#cb119-7" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 2] = <span class="fu">r</span>(std_err)</span>
<span id="cb119-8"><a href="#cb119-8" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 3] = <span class="fu">r</span>(p_value)</span>
<span id="cb119-9"><a href="#cb119-9" tabindex="-1"></a>  }</span>
<span id="cb119-10"><a href="#cb119-10" tabindex="-1"></a></span>
<span id="cb119-11"><a href="#cb119-11" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb119-12"><a href="#cb119-12" tabindex="-1"></a>  <span class="kw">svmat</span> results, names(x)</span>
<span id="cb119-13"><a href="#cb119-13" tabindex="-1"></a></span>
<span id="cb119-14"><a href="#cb119-14" tabindex="-1"></a>  <span class="co">// calculate mean estimates and power for specified alpha</span></span>
<span id="cb119-15"><a href="#cb119-15" tabindex="-1"></a>  <span class="kw">gen</span> power = 0</span>
<span id="cb119-16"><a href="#cb119-16" tabindex="-1"></a>  <span class="kw">replace</span> power = 1 <span class="kw">if</span> x3 &lt; <span class="ot">$alpha</span></span>
<span id="cb119-17"><a href="#cb119-17" tabindex="-1"></a></span>
<span id="cb119-18"><a href="#cb119-18" tabindex="-1"></a>  <span class="kw">egen</span> coef_mean = <span class="kw">mean</span>(x1)</span>
<span id="cb119-19"><a href="#cb119-19" tabindex="-1"></a>  <span class="kw">egen</span> std_err_mean = <span class="kw">mean</span>(<span class="kw">x2</span>)</span>
<span id="cb119-20"><a href="#cb119-20" tabindex="-1"></a>  <span class="kw">egen</span> power_mean = <span class="kw">mean</span>(power)</span>
<span id="cb119-21"><a href="#cb119-21" tabindex="-1"></a>}</span>
<span id="cb119-22"><a href="#cb119-22" tabindex="-1"></a></span>
<span id="cb119-23"><a href="#cb119-23" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Coef. Mean: &quot;</span> coef_mean</span>
<span id="cb119-24"><a href="#cb119-24" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Std.Err. Mean: &quot;</span> std_err_mean</span>
<span id="cb119-25"><a href="#cb119-25" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Power Mean: &quot;</span> power_mean</span></code></pre></div>
<pre><code>Coef. Mean: 5.1327767

Std.Err. Mean: .34294486

Power Mean: 1</code></pre>
<div id="check-false-positive-rate-2" class="section level3 hasAnchor" number="6.5.1">
<h3 class="hasAnchor"><span class="header-section-number">6.5.1</span> Check false positive rate<a href="#check-false-positive-rate-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can do a sanity check to see if our simulation is performing as expected by checking the false positive rate (Type I error rate). We set the effect of <code>genre_ij</code> (<code>beta_1</code>) to 0 to calculate the false positive rate, which is the probability of concluding there is an effect when there is no actual effect in the population.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb121-1"><a href="#cb121-1" tabindex="-1"></a><span class="co">// run simulations and calculate the false positive rate</span></span>
<span id="cb121-2"><a href="#cb121-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb121-3"><a href="#cb121-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb121-4"><a href="#cb121-4" tabindex="-1"></a>  <span class="fu">matrix</span> results = <span class="fu">J</span>(<span class="ot">$reps</span>, 3, .)</span>
<span id="cb121-5"><a href="#cb121-5" tabindex="-1"></a>  forval i = 1/<span class="ot">$reps</span> {</span>
<span id="cb121-6"><a href="#cb121-6" tabindex="-1"></a>    <span class="kw">quietly</span> single_run 25 15 15 60 0 7 8</span>
<span id="cb121-7"><a href="#cb121-7" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 1] = <span class="fu">r</span>(coef)</span>
<span id="cb121-8"><a href="#cb121-8" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 2] = <span class="fu">r</span>(std_err)</span>
<span id="cb121-9"><a href="#cb121-9" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 3] = <span class="fu">r</span>(p_value)</span>
<span id="cb121-10"><a href="#cb121-10" tabindex="-1"></a>  }</span>
<span id="cb121-11"><a href="#cb121-11" tabindex="-1"></a></span>
<span id="cb121-12"><a href="#cb121-12" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb121-13"><a href="#cb121-13" tabindex="-1"></a>  <span class="kw">svmat</span> results, names(x)</span>
<span id="cb121-14"><a href="#cb121-14" tabindex="-1"></a></span>
<span id="cb121-15"><a href="#cb121-15" tabindex="-1"></a>  <span class="co">// calculate power for specified alpha</span></span>
<span id="cb121-16"><a href="#cb121-16" tabindex="-1"></a>  <span class="kw">gen</span> power = 0</span>
<span id="cb121-17"><a href="#cb121-17" tabindex="-1"></a>  <span class="kw">replace</span> power = 1 <span class="kw">if</span> x3 &lt; <span class="ot">$alpha</span></span>
<span id="cb121-18"><a href="#cb121-18" tabindex="-1"></a></span>
<span id="cb121-19"><a href="#cb121-19" tabindex="-1"></a>  <span class="kw">egen</span> power_mean = <span class="kw">mean</span>(power)</span>
<span id="cb121-20"><a href="#cb121-20" tabindex="-1"></a>}</span>
<span id="cb121-21"><a href="#cb121-21" tabindex="-1"></a></span>
<span id="cb121-22"><a href="#cb121-22" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Power Mean: &quot;</span> power_mean</span></code></pre></div>
<pre><code>Power Mean: .03333334</code></pre>
<p>Ideally, the false positive rate will be equal to <code>alpha</code>, which we set at 0.05.</p>
</div>
</div>
<div id="power-for-different-effect-sizes-2" class="section level2 hasAnchor" number="6.6">
<h2 class="hasAnchor"><span class="header-section-number">6.6</span> Power for different effect sizes<a href="#power-for-different-effect-sizes-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In real life, we will not know the effect size of our quantity of interest, and so we will need to repeatedly perform the power analysis over a range of different plausible effect sizes. Perhaps we might also want to calculate power as we vary other data-generating parameters, such as the number of pop and rock songs sampled and the number of subjects sampled. We can create a table that combines all combinations of the parameters we want to vary in a grid.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb123-1"><a href="#cb123-1" tabindex="-1"></a><span class="co">// grid of parameter values of interest</span></span>
<span id="cb123-2"><a href="#cb123-2" tabindex="-1"></a><span class="kw">quietly</span> <span class="fu">matrix</span> <span class="kw">define</span> params = (10, 10, 10, 1 \ 10, 10, 10, 2 \ 10, 10, 10, 3 \ 10, 10, 10, 4 \ 10, 10, 10, 5 <span class="co">///</span></span>
<span id="cb123-3"><a href="#cb123-3" tabindex="-1"></a>\ 10, 10, 40, 1 \ 10, 10, 40, 2 \ 10, 10, 40, 3 \ 10, 10, 40, 4 \ 10, 10, 40, 5 <span class="co">///</span></span>
<span id="cb123-4"><a href="#cb123-4" tabindex="-1"></a>\ 10, 40, 10, 1 \ 10, 40, 10, 2 \ 10, 40, 10, 3 \ 10, 40, 10, 4 \ 10, 40, 10, 5 <span class="co">///</span></span>
<span id="cb123-5"><a href="#cb123-5" tabindex="-1"></a>\ 10, 40, 40, 1 \ 10, 40, 40, 2 \ 10, 40, 40, 3 \ 10, 40, 40, 4 \ 10, 40, 40, 5 <span class="co">///</span></span>
<span id="cb123-6"><a href="#cb123-6" tabindex="-1"></a>\ 25, 10, 10, 1 \ 25, 10, 10, 2 \ 25, 10, 10, 3 \ 25, 10, 10, 4 \ 25, 10, 10, 5 <span class="co">///</span></span>
<span id="cb123-7"><a href="#cb123-7" tabindex="-1"></a>\ 25, 10, 40, 1 \ 25, 10, 40, 2 \ 25, 10, 40, 3 \ 25, 10, 40, 4 \ 25, 10, 40, 5 <span class="co">///</span></span>
<span id="cb123-8"><a href="#cb123-8" tabindex="-1"></a>\ 25, 40, 10, 1 \ 25, 40, 10, 2 \ 25, 40, 10, 3 \ 25, 40, 10, 4 \ 25, 40, 10, 5 <span class="co">///</span></span>
<span id="cb123-9"><a href="#cb123-9" tabindex="-1"></a>\ 25, 40, 40, 1 \ 25, 40, 40, 2 \ 25, 40, 40, 3 \ 25, 40, 40, 4 \ 25, 40, 40, 5 <span class="co">///</span></span>
<span id="cb123-10"><a href="#cb123-10" tabindex="-1"></a>\ 50, 10, 10, 1 \ 50, 10, 10, 2 \ 50, 10, 10, 3 \ 50, 10, 10, 4 \ 50, 10, 10, 5 <span class="co">///</span></span>
<span id="cb123-11"><a href="#cb123-11" tabindex="-1"></a>\ 50, 10, 40, 1 \ 50, 10, 40, 2 \ 50, 10, 40, 3 \ 50, 10, 40, 4 \ 50, 10, 40, 5 <span class="co">///</span></span>
<span id="cb123-12"><a href="#cb123-12" tabindex="-1"></a>\ 50, 40, 10, 1 \ 50, 40, 10, 2 \ 50, 40, 10, 3 \ 50, 40, 10, 4 \ 50, 40, 10, 5 <span class="co">///</span></span>
<span id="cb123-13"><a href="#cb123-13" tabindex="-1"></a>\ 50, 40, 40, 1 \ 50, 40, 40, 2 \ 50, 40, 40, 3 \ 50, 40, 40, 4 \ 50, 40, 40, 5)</span></code></pre></div>
<p>We can now wrap our <code>single_run()</code> function within a more general function <code>parameter_search()</code> that takes the grid of parameter values as input and uses a matrix <code>results</code> to store the analysis results of each <code>single_run()</code>.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb124-1"><a href="#cb124-1" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> parameter_search</span>
<span id="cb124-2"><a href="#cb124-2" tabindex="-1"></a><span class="kw">program</span> <span class="kw">define</span> parameter_search, rclass</span>
<span id="cb124-3"><a href="#cb124-3" tabindex="-1"></a>    <span class="kw">args</span> params</span>
<span id="cb124-4"><a href="#cb124-4" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" tabindex="-1"></a>    <span class="kw">local</span> <span class="bn">rows</span> = <span class="fu">rowsof</span>(params)</span>
<span id="cb124-6"><a href="#cb124-6" tabindex="-1"></a>    <span class="fu">matrix</span> results = <span class="fu">J</span>(<span class="ot">`rows&#39;</span>, 7, .)</span>
<span id="cb124-7"><a href="#cb124-7" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" tabindex="-1"></a>    forval i = 1/<span class="ot">`rows&#39;</span> {</span>
<span id="cb124-9"><a href="#cb124-9" tabindex="-1"></a>        <span class="kw">local</span> n_subj = params[<span class="ot">`i&#39;</span>, 1]</span>
<span id="cb124-10"><a href="#cb124-10" tabindex="-1"></a>        <span class="kw">local</span> n_pop = params[<span class="ot">`i&#39;</span>, 2]</span>
<span id="cb124-11"><a href="#cb124-11" tabindex="-1"></a>        <span class="kw">local</span> n_rock = params[<span class="ot">`i&#39;</span>, 3]</span>
<span id="cb124-12"><a href="#cb124-12" tabindex="-1"></a>        <span class="kw">local</span> beta_1 = params[<span class="ot">`i&#39;</span>, 4]</span>
<span id="cb124-13"><a href="#cb124-13" tabindex="-1"></a></span>
<span id="cb124-14"><a href="#cb124-14" tabindex="-1"></a>        single_run <span class="ot">`n_subj&#39;</span> <span class="ot">`n_pop&#39;</span> <span class="ot">`n_rock&#39;</span> 60 <span class="ot">`beta_1&#39;</span> 7 8</span>
<span id="cb124-15"><a href="#cb124-15" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 1] = <span class="ot">`n_subj&#39;</span></span>
<span id="cb124-16"><a href="#cb124-16" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 2] = <span class="ot">`n_pop&#39;</span></span>
<span id="cb124-17"><a href="#cb124-17" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 3] = <span class="ot">`n_rock&#39;</span></span>
<span id="cb124-18"><a href="#cb124-18" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 4] = <span class="ot">`beta_1&#39;</span></span>
<span id="cb124-19"><a href="#cb124-19" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 5] = <span class="fu">r</span>(coef)</span>
<span id="cb124-20"><a href="#cb124-20" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 6] = <span class="fu">r</span>(std_err)</span>
<span id="cb124-21"><a href="#cb124-21" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 7] = <span class="fu">r</span>(p_value)</span>
<span id="cb124-22"><a href="#cb124-22" tabindex="-1"></a>    }</span>
<span id="cb124-23"><a href="#cb124-23" tabindex="-1"></a></span>
<span id="cb124-24"><a href="#cb124-24" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">matrix</span> RE results</span>
<span id="cb124-25"><a href="#cb124-25" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>If we call <code>parameter_search()</code> it will return a single replication of simulations for each combination of parameter values in <code>params</code>.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb125-1"><a href="#cb125-1" tabindex="-1"></a><span class="kw">quietly</span> parameter_search params</span>
<span id="cb125-2"><a href="#cb125-2" tabindex="-1"></a><span class="fu">return</span> <span class="ot">list</span></span>
<span id="cb125-3"><a href="#cb125-3" tabindex="-1"></a><span class="fu">matrix</span> <span class="ot">list</span> <span class="fu">r</span>(RE)</span></code></pre></div>
<pre><code>matrices:
                 r(RE) :  60 x 7


r(RE)[60,7]
            c1         c2         c3         c4         c5         c6
 r1         10         10         10          1  2.0767703  1.3290591
 r2         10         10         10          2  .62064529  1.1411167
 r3         10         10         10          3  3.2051462  1.3930413
 r4         10         10         10          4  2.5571848  1.3892114
 r5         10         10         10          5  6.6856051  1.4763299
 r6         10         10         40          1  1.5987428  .83724974
 r7         10         10         40          2  2.6229231  .79420778
 r8         10         10         40          3  3.1869321   .7857458
 r9         10         10         40          4  3.6704681  .74732381
r10         10         10         40          5  5.4704365  .77949362
r11         10         40         10          1  2.2633134  .89868119
r12         10         40         10          2  2.6807894  .84989613
r13         10         40         10          3  4.5684848  .78929499
r14         10         40         10          4  4.0980586  .82437518
r15         10         40         10          5  4.7150011  .74640408
r16         10         40         40          1  .81983679  .35818376
r17         10         40         40          2  1.5840674  .32607948
r18         10         40         40          3  3.1854328  .32937222
r19         10         40         40          4   4.519555  .30852233
r20         10         40         40          5   5.364586  .33542361
r21         25         10         10          1  1.3821919  .50011368
r22         25         10         10          2  .90685745  .48654647
r23         25         10         10          3  2.2015396  .54055836
r24         25         10         10          4  4.0424014  .51098122
r25         25         10         10          5  4.7957371  .50273713
r26         25         10         40          1  1.2478584  .33050679
r27         25         10         40          2  2.0108924  .30820396
r28         25         10         40          3  2.6370676  .31890292
r29         25         10         40          4  4.8110402   .3149082
r30         25         10         40          5  4.8646795  .32617716
r31         25         40         10          1  .62202797  .30721533
r32         25         40         10          2  2.4312455  .33297658
r33         25         40         10          3  3.0815587  .31753019
r34         25         40         10          4   4.358412  .32801022
r35         25         40         10          5  4.7545508  .31512113
r36         25         40         40          1  1.1845128  .12694719
r37         25         40         40          2  1.9192859  .12666322
r38         25         40         40          3  3.1466376  .12789099
r39         25         40         40          4   4.011289  .12794187
r40         25         40         40          5  4.6528025  .13191323
r41         50         10         10          1  1.0968133  .25114203
r42         50         10         10          2  1.8459916  .24536956
r43         50         10         10          3  2.5134481  .27698685
r44         50         10         10          4  3.9934688  .26265935
r45         50         10         10          5   5.550354  .27162128
r46         50         10         40          1   .8059052  .15170351
r47         50         10         40          2  2.1912051  .16397648
r48         50         10         40          3  2.8441802  .15442357
r49         50         10         40          4  3.7818822  .15977438
r50         50         10         40          5  5.0424808  .15956679
r51         50         40         10          1    -.06306  .15992571
r52         50         40         10          2  2.0112829  .15796861
r53         50         40         10          3  3.1048406  .16241303
r54         50         40         10          4  4.4309891  .15874512
r55         50         40         10          5   4.697969  .16744383
r56         50         40         40          1  1.0014537  .06765406
r57         50         40         40          2  2.0857039  .06470816
r58         50         40         40          3  2.6670335  .06178508
r59         50         40         40          4  3.8384164  .06603957
r60         50         40         40          5  4.8219271  .06276692

            c7
 r1  .07163583
 r2  .56123837
 r3  .00661557
 r4  .03003782
 r5  3.747e-08
 r6  .08059674
 r7  .00324848
 r8  .00032405
 r9  .00002177
r10  5.789e-10
r11  .01696379
r12  .00363862
r13  2.715e-07
r14  6.376e-06
r15  4.828e-08
r16   .1707323
r17  .00553657
r18  2.850e-08
r19  4.059e-16
r20  1.993e-20
r21  .05064301
r22  .19356659
r23  .00275014
r24  1.558e-08
r25  1.345e-11
r26   .0299632
r27  .00029213
r28  3.016e-06
r29  1.006e-17
r30  1.626e-17
r31  .26175742
r32  .00002517
r33  4.535e-08
r34  2.741e-14
r35  2.459e-17
r36  .00088573
r37  6.937e-08
r38  1.382e-18
r39  3.464e-29
r40  1.430e-37
r41   .0286235
r42  .00019404
r43  1.791e-06
r44  6.591e-15
r45  1.749e-26
r46  .03853462
r47  6.261e-08
r48  4.564e-13
r49  3.039e-21
r50  1.571e-36
r51  .87470376
r52  4.183e-07
r53  1.316e-14
r54  9.897e-29
r55  1.646e-30
r56  .00011802
r57  2.419e-16
r58  7.385e-27
r59  1.906e-50
r60  1.506e-82</code></pre>
<p>Then we just repeatedly call <code>parameter_search()</code> for the number of times specified by <code>reps</code> and store the result in a matrix <code>final_results</code>. Fair warning: this will take some time if you have set a high number of replications!</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb127-1"><a href="#cb127-1" tabindex="-1"></a><span class="co">// replicate the parameter search many times</span></span>
<span id="cb127-2"><a href="#cb127-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb127-3"><a href="#cb127-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb127-4"><a href="#cb127-4" tabindex="-1"></a>  <span class="fu">matrix</span> final_results = <span class="fu">J</span>(1, 7, .)</span>
<span id="cb127-5"><a href="#cb127-5" tabindex="-1"></a>  forval i = 1/<span class="ot">$reps</span> {</span>
<span id="cb127-6"><a href="#cb127-6" tabindex="-1"></a>    <span class="kw">quietly</span> parameter_search params</span>
<span id="cb127-7"><a href="#cb127-7" tabindex="-1"></a></span>
<span id="cb127-8"><a href="#cb127-8" tabindex="-1"></a>    <span class="fu">matrix</span> final_results = final_results \ <span class="fu">r</span>(RE)</span>
<span id="cb127-9"><a href="#cb127-9" tabindex="-1"></a>  }</span>
<span id="cb127-10"><a href="#cb127-10" tabindex="-1"></a></span>
<span id="cb127-11"><a href="#cb127-11" tabindex="-1"></a>  <span class="co">// rename the columns</span></span>
<span id="cb127-12"><a href="#cb127-12" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb127-13"><a href="#cb127-13" tabindex="-1"></a>  <span class="kw">svmat</span> final_results, names(final_results)</span>
<span id="cb127-14"><a href="#cb127-14" tabindex="-1"></a>  <span class="kw">rename</span> final_results1 n_subj</span>
<span id="cb127-15"><a href="#cb127-15" tabindex="-1"></a>  <span class="kw">rename</span> final_results2 n_pop</span>
<span id="cb127-16"><a href="#cb127-16" tabindex="-1"></a>  <span class="kw">rename</span> final_results3 n_rock</span>
<span id="cb127-17"><a href="#cb127-17" tabindex="-1"></a>  <span class="kw">rename</span> final_results4 beta_1</span>
<span id="cb127-18"><a href="#cb127-18" tabindex="-1"></a>  <span class="kw">rename</span> final_results5 mean_estimate</span>
<span id="cb127-19"><a href="#cb127-19" tabindex="-1"></a>  <span class="kw">rename</span> final_results6 mean_se</span>
<span id="cb127-20"><a href="#cb127-20" tabindex="-1"></a>  <span class="kw">rename</span> final_results7 p_value</span>
<span id="cb127-21"><a href="#cb127-21" tabindex="-1"></a>  <span class="kw">drop</span> <span class="kw">in</span> 1</span>
<span id="cb127-22"><a href="#cb127-22" tabindex="-1"></a></span>
<span id="cb127-23"><a href="#cb127-23" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/final_results.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb127-24"><a href="#cb127-24" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, as before, we can calculate power. But this time, we’ll group by all of the parameters we manipulated in <code>pgrid</code>, so that we can get power estimates for all combinations of parameter values.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb128-1"><a href="#cb128-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb128-2"><a href="#cb128-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/final_results.dta&quot;</span></span>
<span id="cb128-3"><a href="#cb128-3" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" tabindex="-1"></a>  <span class="kw">gen</span> power = 0</span>
<span id="cb128-5"><a href="#cb128-5" tabindex="-1"></a>  <span class="kw">replace</span> power = 1 <span class="kw">if</span> p_value &lt; <span class="ot">$alpha</span></span>
<span id="cb128-6"><a href="#cb128-6" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" tabindex="-1"></a>  <span class="kw">drop</span> p_value</span>
<span id="cb128-8"><a href="#cb128-8" tabindex="-1"></a></span>
<span id="cb128-9"><a href="#cb128-9" tabindex="-1"></a>  <span class="kw">collapse</span> (<span class="kw">mean</span>) mean_estimate mean_se power, <span class="kw">by</span>(n_subj n_pop n_rock beta_1)</span>
<span id="cb128-10"><a href="#cb128-10" tabindex="-1"></a></span>
<span id="cb128-11"><a href="#cb128-11" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/sims_table.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb128-12"><a href="#cb128-12" tabindex="-1"></a>}</span>
<span id="cb128-13"><a href="#cb128-13" tabindex="-1"></a><span class="ot">list</span></span></code></pre></div>
<pre><code>     | n_subj   n_pop   n_rock   beta_1   mean_e~e    mean_se      power |
     |-------------------------------------------------------------------|
  1. |     10      10       10        1   1.268973   1.238123   .2333333 |
  2. |     10      10       10        2   1.889742   1.235582         .4 |
  3. |     10      10       10        3   2.683959   1.239035   .6333333 |
  4. |     10      10       10        4   4.400897   1.289458          1 |
  5. |     10      10       10        5   5.275087   1.243694          1 |
     |-------------------------------------------------------------------|
  6. |     10      10       40        1   1.014274   .7960495   .1666667 |
  7. |     10      10       40        2   1.988628   .8059257         .6 |
  8. |     10      10       40        3    2.97399   .8001856          1 |
  9. |     10      10       40        4   3.996796   .7847906          1 |
 10. |     10      10       40        5   4.943249   .8100024          1 |
     |-------------------------------------------------------------------|
 11. |     10      40       10        1   1.049238   .7958079         .2 |
 12. |     10      40       10        2   1.768396   .8269665   .5333334 |
 13. |     10      40       10        3   3.041028   .7862483   .8666667 |
 14. |     10      40       10        4   4.262085   .8037483          1 |
 15. |     10      40       10        5   5.404449   .7965609          1 |
     |-------------------------------------------------------------------|
 16. |     10      40       40        1   .9648004   .3186095         .4 |
 17. |     10      40       40        2   2.164498     .31894          1 |
 18. |     10      40       40        3   2.994144   .3153042          1 |
 19. |     10      40       40        4   4.117634   .3245635          1 |
 20. |     10      40       40        5   4.947803   .3222156          1 |
     |-------------------------------------------------------------------|
 21. |     25      10       10        1   1.009122   .5089009   .2666667 |
 22. |     25      10       10        2    2.01162   .5161048   .7666667 |
 23. |     25      10       10        3   2.849991   .5214418          1 |
 24. |     25      10       10        4   4.013868    .510223          1 |
 25. |     25      10       10        5   5.058398   .5018378          1 |
     |-------------------------------------------------------------------|
 26. |     25      10       40        1   1.091378   .3221848   .5333334 |
 27. |     25      10       40        2   1.758242   .3150428   .8333333 |
 28. |     25      10       40        3   2.941761   .3189749          1 |
 29. |     25      10       40        4   4.100368   .3209341          1 |
 30. |     25      10       40        5   4.905522   .3202905          1 |
     |-------------------------------------------------------------------|
 31. |     25      40       10        1   .9354665   .3251629   .3333333 |
 32. |     25      40       10        2   2.089087   .3190893   .9666666 |
 33. |     25      40       10        3   3.008885   .3194447          1 |
 34. |     25      40       10        4   4.040331   .3203337          1 |
 35. |     25      40       10        5   4.991682   .3226803          1 |
     |-------------------------------------------------------------------|
 36. |     25      40       40        1   1.077446   .1273965   .8666667 |
 37. |     25      40       40        2    1.97645   .1276043          1 |
 38. |     25      40       40        3   2.928479   .1292938          1 |
 39. |     25      40       40        4   4.038676   .1287591          1 |
 40. |     25      40       40        5   5.002239   .1278136          1 |
     |-------------------------------------------------------------------|
 41. |     50      10       10        1   .9126882   .2530858         .5 |
 42. |     50      10       10        2    2.00245   .2595248          1 |
 43. |     50      10       10        3    3.04136    .258838          1 |
 44. |     50      10       10        4   3.974287   .2553087          1 |
 45. |     50      10       10        5   5.205029   .2573906          1 |
     |-------------------------------------------------------------------|
 46. |     50      10       40        1   1.030129   .1595967   .7666667 |
 47. |     50      10       40        2   1.991586   .1598501          1 |
 48. |     50      10       40        3   3.040545   .1619374          1 |
 49. |     50      10       40        4   3.960105    .159726          1 |
 50. |     50      10       40        5   4.958652    .159858          1 |
     |-------------------------------------------------------------------|
 51. |     50      40       10        1   .9377397   .1599206   .6666667 |
 52. |     50      40       10        2   2.048419   .1587613          1 |
 53. |     50      40       10        3   2.945178   .1593941          1 |
 54. |     50      40       10        4    4.02575     .15889          1 |
 55. |     50      40       10        5   4.963776   .1594315          1 |
     |-------------------------------------------------------------------|
 56. |     50      40       40        1    1.04931    .064062   .9666666 |
 57. |     50      40       40        2   2.004742   .0637963          1 |
 58. |     50      40       40        3   2.927157   .0643362          1 |
 59. |     50      40       40        4    3.90757   .0640075          1 |
 60. |     50      40       40        5   5.028903   .0638838          1 |
     +-------------------------------------------------------------------+</code></pre>
<p>Here’s a graph that visualizes the output of the power simulation.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb130-1"><a href="#cb130-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb130-2"><a href="#cb130-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/sims_table.dta&quot;</span></span>
<span id="cb130-3"><a href="#cb130-3" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" tabindex="-1"></a>  <span class="kw">twoway</span> (connected power beta_1 <span class="kw">if</span> n_subj == 10, <span class="kw">sort</span>) (connected power beta_1 <span class="kw">if</span> n_subj == 25, <span class="kw">sort</span>) (connected power beta_1 <span class="kw">if</span> n_subj == 50, <span class="kw">sort</span>), <span class="dv">scheme</span>(s2color) <span class="kw">by</span>(n_pop n_rock) <span class="bn">legend</span>(lab(1 <span class="st">&quot;sample_size = 10&quot;</span>) lab(2 <span class="st">&quot;sample_size = 25&quot;</span>) lab(3 <span class="st">&quot;sample_size = 50&quot;</span>))</span>
<span id="cb130-5"><a href="#cb130-5" tabindex="-1"></a></span>
<span id="cb130-6"><a href="#cb130-6" tabindex="-1"></a>  <span class="kw">graph</span> <span class="kw">export</span> <span class="st">&quot;./figures/twoway.png&quot;</span>, <span class="kw">replace</span></span>
<span id="cb130-7"><a href="#cb130-7" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="figures/twoway.png" /></p>
<!--chapter:end:06_Stata.Rmd-->
</div>
</div>
<div id="part-appendix" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">(PART) Appendix<a href="#part-appendix" class="anchor-section" aria-label="Anchor link to header"></a></h1>
</div>
<div id="software-comparison" class="section level1 hasAnchor" number="7">
<h1 class="hasAnchor"><span class="header-section-number">7</span> Software Comparison<a href="#software-comparison" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<!--chapter:end:07_software_comparison.Rmd-->
</div>
<div id="resources" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">Resources<a href="#resources" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We would like to acknowledge some excellent online and peer-reviewed material about power simulation and mixed effects models, which we have borrowed from liberally in the tutorial. These resouces represent an excellent next step in your exploration of simulation-based power analysis.</p>
<div id="r-1" class="section level3 unnumbered hasAnchor">
<h3 class="unnumbered hasAnchor">R<a href="#r-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p>DeBruine &amp; Barr (2021) paper on using simulation to understand mixed effects models: <a href="https://journals.sagepub.com/doi/epdf/10.1177/2515245920965119" class="uri">https://journals.sagepub.com/doi/epdf/10.1177/2515245920965119</a></p></li>
<li><p>Kumle et al. (2021) paper on estimating power in GLMMs:
<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8613146/" class="uri">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8613146/</a></p></li>
</ul>
<p>Julian Quandt’s 4-part blog series on power analysis via simulation:</p>
<ol style="list-style-type: decimal">
<li><a href="https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-i/" class="uri">https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-i/</a></li>
<li><a href="https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-ii/" class="uri">https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-ii/</a></li>
<li><a href="https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iii/" class="uri">https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iii/</a></li>
<li><a href="https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iv/" class="uri">https://julianquandt.com/post/power-analysis-by-data-simulation-in-r-part-iv/</a></li>
</ol>
</div>
<div id="stata-1" class="section level3 unnumbered hasAnchor">
<h3 class="unnumbered hasAnchor">Stata<a href="#stata-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Chuck Huber’s 4-part blog series on power analysis via simulation:</p>
<ol style="list-style-type: decimal">
<li><a href="https://blog.stata.com/2019/01/10/calculating-power-using-monte-carlo-simulations-part-1-the-basics/" class="uri">https://blog.stata.com/2019/01/10/calculating-power-using-monte-carlo-simulations-part-1-the-basics/</a></li>
<li><a href="https://blog.stata.com/2019/01/29/calculating-power-using-monte-carlo-simulations-part-2-running-your-simulation-using-power/" class="uri">https://blog.stata.com/2019/01/29/calculating-power-using-monte-carlo-simulations-part-2-running-your-simulation-using-power/</a></li>
<li><a href="https://blog.stata.com/2019/08/13/calculating-power-using-monte-carlo-simulations-part-3-linear-and-logistic-regression/" class="uri">https://blog.stata.com/2019/08/13/calculating-power-using-monte-carlo-simulations-part-3-linear-and-logistic-regression/</a></li>
<li><a href="https://blog.stata.com/2019/08/20/calculating-power-using-monte-carlo-simulations-part-4-multilevel-longitudinal-models/" class="uri">https://blog.stata.com/2019/08/20/calculating-power-using-monte-carlo-simulations-part-4-multilevel-longitudinal-models/</a></li>
</ol>
<!--chapter:end:08_resources.Rmd-->
</div>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
