<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Stata | dss-powersim</title>
  <meta name="description" content="This is a tutorial for power simulation" />
  <meta name="generator" content="bookdown 0.35 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Stata | dss-powersim" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a tutorial for power simulation" />
  <meta name="github-repo" content="hlmshtj-dan/Simulation-Power" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Stata | dss-powersim" />
  
  <meta name="twitter:description" content="This is a tutorial for power simulation" />
  

<meta name="author" content="" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="python.html"/>
<link rel="next" href="software-comparison.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Power Simulation</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Simulation-Based Power Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#table-of-contents"><i class="fa fa-check"></i>Table of Contents</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributors"><i class="fa fa-check"></i>Contributors</a></li>
</ul></li>
<li class="part"><span><b>I Concepts</b></span></li>
<li class="chapter" data-level="1" data-path="power-analysis.html"><a href="power-analysis.html"><i class="fa fa-check"></i><b>1</b> Power Analysis</a>
<ul>
<li class="chapter" data-level="1.1" data-path="power-analysis.html"><a href="power-analysis.html#canned-routines"><i class="fa fa-check"></i><b>1.1</b> Canned routines</a></li>
<li class="chapter" data-level="1.2" data-path="power-analysis.html"><a href="power-analysis.html#step-by-step"><i class="fa fa-check"></i><b>1.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>2</b> Simulation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="simulation.html"><a href="simulation.html#customization"><i class="fa fa-check"></i><b>2.1</b> Customization</a></li>
<li class="chapter" data-level="2.2" data-path="simulation.html"><a href="simulation.html#step-by-step-1"><i class="fa fa-check"></i><b>2.2</b> Step by step</a></li>
</ul></li>
<li class="part"><span><b>II Preparation</b></span></li>
<li class="chapter" data-level="3" data-path="power-of-what.html"><a href="power-of-what.html"><i class="fa fa-check"></i><b>3</b> Power of What?</a>
<ul>
<li class="chapter" data-level="3.1" data-path="power-of-what.html"><a href="power-of-what.html#study-design"><i class="fa fa-check"></i><b>3.1</b> Study design</a></li>
<li class="chapter" data-level="3.2" data-path="power-of-what.html"><a href="power-of-what.html#mixed-effects-model"><i class="fa fa-check"></i><b>3.2</b> Mixed effects model</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="power-of-what.html"><a href="power-of-what.html#step-1-model-specification"><i class="fa fa-check"></i><b>3.2.1</b> Step 1: model specification</a></li>
<li class="chapter" data-level="3.2.2" data-path="power-of-what.html"><a href="power-of-what.html#step-2-variable-composition"><i class="fa fa-check"></i><b>3.2.2</b> Step 2: Variable composition</a></li>
<li class="chapter" data-level="3.2.3" data-path="power-of-what.html"><a href="power-of-what.html#step-3-parameter-composition"><i class="fa fa-check"></i><b>3.2.3</b> Step 3: Parameter composition</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Implementation</b></span></li>
<li class="chapter" data-level="4" data-path="r.html"><a href="r.html"><i class="fa fa-check"></i><b>4</b> R</a>
<ul>
<li class="chapter" data-level="4.1" data-path="r.html"><a href="r.html#setup"><i class="fa fa-check"></i><b>4.1</b> Setup</a></li>
<li class="chapter" data-level="4.2" data-path="r.html"><a href="r.html#data-simulation-step-by-step"><i class="fa fa-check"></i><b>4.2</b> Data simulation step by step</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="r.html"><a href="r.html#establish-the-simulation-parameters"><i class="fa fa-check"></i><b>4.2.1</b> Establish the simulation parameters</a></li>
<li class="chapter" data-level="4.2.2" data-path="r.html"><a href="r.html#establish-the-data-generating-parameters"><i class="fa fa-check"></i><b>4.2.2</b> Establish the data-generating parameters</a></li>
<li class="chapter" data-level="4.2.3" data-path="r.html"><a href="r.html#simulate-the-sampling-process"><i class="fa fa-check"></i><b>4.2.3</b> Simulate the sampling process</a></li>
<li class="chapter" data-level="4.2.4" data-path="r.html"><a href="r.html#analyze-the-simulated-data"><i class="fa fa-check"></i><b>4.2.4</b> Analyze the simulated data</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="r.html"><a href="r.html#data-simulation-automated"><i class="fa fa-check"></i><b>4.3</b> Data simulation automated</a></li>
<li class="chapter" data-level="4.4" data-path="r.html"><a href="r.html#power-calculation-single-run"><i class="fa fa-check"></i><b>4.4</b> Power calculation single run</a></li>
<li class="chapter" data-level="4.5" data-path="r.html"><a href="r.html#power-calculation-automated"><i class="fa fa-check"></i><b>4.5</b> Power calculation automated</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="r.html"><a href="r.html#check-false-positive-rate"><i class="fa fa-check"></i><b>4.5.1</b> Check false positive rate</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="r.html"><a href="r.html#power-for-different-effect-sizes"><i class="fa fa-check"></i><b>4.6</b> Power for different effect sizes</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="python.html"><a href="python.html"><i class="fa fa-check"></i><b>5</b> Python</a>
<ul>
<li class="chapter" data-level="5.1" data-path="python.html"><a href="python.html#setup-1"><i class="fa fa-check"></i><b>5.1</b> Setup</a></li>
<li class="chapter" data-level="5.2" data-path="python.html"><a href="python.html#data-simulation-step-by-step-1"><i class="fa fa-check"></i><b>5.2</b> Data simulation step by step</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="python.html"><a href="python.html#establish-the-simulation-parameters-1"><i class="fa fa-check"></i><b>5.2.1</b> Establish the simulation parameters</a></li>
<li class="chapter" data-level="5.2.2" data-path="python.html"><a href="python.html#establish-the-data-generating-parameters-1"><i class="fa fa-check"></i><b>5.2.2</b> Establish the data-generating parameters</a></li>
<li class="chapter" data-level="5.2.3" data-path="python.html"><a href="python.html#simulate-the-sampling-process-1"><i class="fa fa-check"></i><b>5.2.3</b> Simulate the sampling process</a></li>
<li class="chapter" data-level="5.2.4" data-path="python.html"><a href="python.html#analyze-the-simulated-data-1"><i class="fa fa-check"></i><b>5.2.4</b> Analyze the simulated data</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="python.html"><a href="python.html#data-simulation-automated-1"><i class="fa fa-check"></i><b>5.3</b> Data simulation automated</a></li>
<li class="chapter" data-level="5.4" data-path="python.html"><a href="python.html#power-calculation-single-run-1"><i class="fa fa-check"></i><b>5.4</b> Power calculation single run</a></li>
<li class="chapter" data-level="5.5" data-path="python.html"><a href="python.html#power-calculation-automated-1"><i class="fa fa-check"></i><b>5.5</b> Power calculation automated</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="python.html"><a href="python.html#check-false-positive-rate-1"><i class="fa fa-check"></i><b>5.5.1</b> Check false positive rate</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="python.html"><a href="python.html#power-for-different-effect-sizes-1"><i class="fa fa-check"></i><b>5.6</b> Power for different effect sizes</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="stata.html"><a href="stata.html"><i class="fa fa-check"></i><b>6</b> Stata</a>
<ul>
<li class="chapter" data-level="6.1" data-path="stata.html"><a href="stata.html#setup-2"><i class="fa fa-check"></i><b>6.1</b> Setup</a></li>
<li class="chapter" data-level="6.2" data-path="stata.html"><a href="stata.html#data-simulation-step-by-step-2"><i class="fa fa-check"></i><b>6.2</b> Data simulation step by step</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="stata.html"><a href="stata.html#establish-the-data-generating-parameters-2"><i class="fa fa-check"></i><b>6.2.1</b> Establish the data-generating parameters</a></li>
<li class="chapter" data-level="6.2.2" data-path="stata.html"><a href="stata.html#simulate-the-sampling-process-2"><i class="fa fa-check"></i><b>6.2.2</b> Simulate the sampling process</a></li>
<li class="chapter" data-level="6.2.3" data-path="stata.html"><a href="stata.html#analyze-the-simulated-data-2"><i class="fa fa-check"></i><b>6.2.3</b> Analyze the simulated data</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="stata.html"><a href="stata.html#data-simulation-automated-2"><i class="fa fa-check"></i><b>6.3</b> Data simulation automated</a></li>
<li class="chapter" data-level="6.4" data-path="stata.html"><a href="stata.html#power-calculation-single-run-2"><i class="fa fa-check"></i><b>6.4</b> Power calculation single run</a></li>
<li class="chapter" data-level="6.5" data-path="stata.html"><a href="stata.html#power-calculation-automated-2"><i class="fa fa-check"></i><b>6.5</b> Power calculation automated</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="stata.html"><a href="stata.html#check-false-positive-rate-2"><i class="fa fa-check"></i><b>6.5.1</b> Check false positive rate</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="stata.html"><a href="stata.html#power-for-different-effect-sizes-2"><i class="fa fa-check"></i><b>6.6</b> Power for different effect sizes</a></li>
</ul></li>
<li class="part"><span><b>IV Appendix</b></span></li>
<li class="chapter" data-level="7" data-path="software-comparison.html"><a href="software-comparison.html"><i class="fa fa-check"></i><b>7</b> Software Comparison</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a>
<ul>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html#r-1"><i class="fa fa-check"></i>R</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html#stata-1"><i class="fa fa-check"></i>Stata</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="stata" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">6</span> Stata<a href="stata.html#stata" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="setup-2" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Setup<a href="stata.html#setup-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will need several Stata packages to draw a violin plot. We can use “ssc install [package_name]” to install them.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb92-1"><a href="stata.html#cb92-1" tabindex="-1"></a><span class="co">// ssc install violinplot, replace     // module to draw violin plots</span></span>
<span id="cb92-2"><a href="stata.html#cb92-2" tabindex="-1"></a><span class="co">// ssc install dstat, replace          // violinplot&#39;s dependency, module to compute summary statistics</span></span>
<span id="cb92-3"><a href="stata.html#cb92-3" tabindex="-1"></a><span class="co">// ssc install moremata, replace       // violinplot&#39;s dependency, module (Mata) to provide various functions</span></span>
<span id="cb92-4"><a href="stata.html#cb92-4" tabindex="-1"></a><span class="co">// ssc install palettes, replace       // violinplot&#39;s dependency, module to provide color palettes</span></span>
<span id="cb92-5"><a href="stata.html#cb92-5" tabindex="-1"></a><span class="co">// ssc install colrspace, replace      // violinplot&#39;s dependency, module providing a class-based color management system in Mata</span></span></code></pre></div>
<p>We will also set the pseudo-random number generator seed to <code>02138</code> to make the stochastic components of our simulations reproducible (this is similar to the process in R and Python).</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb93-1"><a href="stata.html#cb93-1" tabindex="-1"></a><span class="kw">clear</span> <span class="ot">all</span></span>
<span id="cb93-2"><a href="stata.html#cb93-2" tabindex="-1"></a><span class="kw">set</span> <span class="dv">seed</span> 02138</span></code></pre></div>
</div>
<div id="data-simulation-step-by-step-2" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Data simulation step by step<a href="stata.html#data-simulation-step-by-step-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To give an overview of the power simulation task, we will simulate data from a design with crossed random factors of subjects and songs (see <a href="./power-of-what.html">Power of What?</a> for design details), fit a model to the simulated data, recover from the model output the parameter values we put in, calculate power, and finally automate the whole process so that we can calculate power for different effect sizes. ### Establish the simulation parameters</p>
<p>Before we start, let’s set some global parameters for our power simulations.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb94-1"><a href="stata.html#cb94-1" tabindex="-1"></a><span class="co">// number of simulation replications for power calculation</span></span>
<span id="cb94-2"><a href="stata.html#cb94-2" tabindex="-1"></a><span class="kw">global</span> reps = 30</span>
<span id="cb94-3"><a href="stata.html#cb94-3" tabindex="-1"></a></span>
<span id="cb94-4"><a href="stata.html#cb94-4" tabindex="-1"></a><span class="co">// specified alpha for power calculation</span></span>
<span id="cb94-5"><a href="stata.html#cb94-5" tabindex="-1"></a><span class="kw">global</span> <span class="kw">alpha</span> = 0.05</span></code></pre></div>
<div id="establish-the-data-generating-parameters-2" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Establish the data-generating parameters<a href="stata.html#establish-the-data-generating-parameters-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first thing to do is to set up the parameters that govern the process we assume gave rise to the data - the <em>data-generating process</em>, or DGP. We previously decided upon the data-generating parameters (see <a href="./power-of-what.html">Power of What?</a>), so we just need to code them here.</p>
<p>Note: There is a difference between Stata and R and Python: We decrease the data-generating parameters to simplify our model, and we delete some parameters: by-song random intercept <code>omega_0</code>, by-subject random slope sd <code>tau_1</code>, and the correlation between intercept and slope <code>rho</code>.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb95-1"><a href="stata.html#cb95-1" tabindex="-1"></a><span class="co">// set all data-generating parameters</span></span>
<span id="cb95-2"><a href="stata.html#cb95-2" tabindex="-1"></a><span class="kw">global</span> beta_0 = 60   <span class="co">// intercept; i.e., the grand mean</span></span>
<span id="cb95-3"><a href="stata.html#cb95-3" tabindex="-1"></a><span class="kw">global</span> beta_1 = 5    <span class="co">// slope; i.e., effect of category</span></span>
<span id="cb95-4"><a href="stata.html#cb95-4" tabindex="-1"></a><span class="kw">global</span> tau_0 = 7     <span class="co">// by-subject random intercept sd</span></span>
<span id="cb95-5"><a href="stata.html#cb95-5" tabindex="-1"></a><span class="kw">global</span> sigma = 8     <span class="co">// residual (error) sd</span></span></code></pre></div>
</div>
<div id="simulate-the-sampling-process-2" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Simulate the sampling process<a href="stata.html#simulate-the-sampling-process-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we will simulate the sampling process for the data. First, let’s define parameters related to the number of observations.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb96-1"><a href="stata.html#cb96-1" tabindex="-1"></a><span class="co">// Set number of subjects and songs</span></span>
<span id="cb96-2"><a href="stata.html#cb96-2" tabindex="-1"></a><span class="kw">global</span> n_subj = 25   <span class="co">// number of subjects</span></span>
<span id="cb96-3"><a href="stata.html#cb96-3" tabindex="-1"></a><span class="kw">global</span> n_pop = 15    <span class="co">// number of songs in pop category</span></span>
<span id="cb96-4"><a href="stata.html#cb96-4" tabindex="-1"></a><span class="kw">global</span> n_rock = 15   <span class="co">// number of songs in rock category</span></span>
<span id="cb96-5"><a href="stata.html#cb96-5" tabindex="-1"></a><span class="kw">global</span> n_all = <span class="ot">$n_pop</span> + <span class="ot">$n_rock</span></span></code></pre></div>
<div id="simulate-the-sampling-of-songs-2" class="section level4 hasAnchor" number="6.2.2.1">
<h4><span class="header-section-number">6.2.2.1</span> Simulate the sampling of songs<a href="stata.html#simulate-the-sampling-of-songs-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We need to create a table listing each song <span class="math inline">\(i\)</span>, which category it is in (<code>rock</code> or <code>pop</code>).</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb97-1"><a href="stata.html#cb97-1" tabindex="-1"></a><span class="co">// simulate a sample of songs</span></span>
<span id="cb97-2"><a href="stata.html#cb97-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb97-3"><a href="stata.html#cb97-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb97-4"><a href="stata.html#cb97-4" tabindex="-1"></a>  <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">$n_all</span></span>
<span id="cb97-5"><a href="stata.html#cb97-5" tabindex="-1"></a></span>
<span id="cb97-6"><a href="stata.html#cb97-6" tabindex="-1"></a>  <span class="co">// Generate a sequence of song ids</span></span>
<span id="cb97-7"><a href="stata.html#cb97-7" tabindex="-1"></a>  <span class="kw">gen</span> song_id = <span class="dt">_n</span></span>
<span id="cb97-8"><a href="stata.html#cb97-8" tabindex="-1"></a></span>
<span id="cb97-9"><a href="stata.html#cb97-9" tabindex="-1"></a>  <span class="co">// Generate the category variable</span></span>
<span id="cb97-10"><a href="stata.html#cb97-10" tabindex="-1"></a>  <span class="kw">gen</span> category = <span class="st">&quot;pop&quot;</span></span>
<span id="cb97-11"><a href="stata.html#cb97-11" tabindex="-1"></a>  <span class="kw">replace</span> category = <span class="st">&quot;rock&quot;</span> <span class="kw">if</span> song_id &gt; <span class="ot">$n_pop</span></span>
<span id="cb97-12"><a href="stata.html#cb97-12" tabindex="-1"></a></span>
<span id="cb97-13"><a href="stata.html#cb97-13" tabindex="-1"></a>  <span class="co">// Generate the genre variable</span></span>
<span id="cb97-14"><a href="stata.html#cb97-14" tabindex="-1"></a>  <span class="kw">gen</span> genre_i = 0</span>
<span id="cb97-15"><a href="stata.html#cb97-15" tabindex="-1"></a>  <span class="kw">replace</span> genre_i = 1 <span class="kw">if</span> song_id &gt; <span class="ot">$n_pop</span></span>
<span id="cb97-16"><a href="stata.html#cb97-16" tabindex="-1"></a></span>
<span id="cb97-17"><a href="stata.html#cb97-17" tabindex="-1"></a>  <span class="kw">gen</span> key = 1</span>
<span id="cb97-18"><a href="stata.html#cb97-18" tabindex="-1"></a></span>
<span id="cb97-19"><a href="stata.html#cb97-19" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/songs.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb97-20"><a href="stata.html#cb97-20" tabindex="-1"></a>}</span>
<span id="cb97-21"><a href="stata.html#cb97-21" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1/10</span></code></pre></div>
<pre><code>     | song_id   category   genre_i   key |
     |------------------------------------|
  1. |       1        pop         0     1 |
  2. |       2        pop         0     1 |
  3. |       3        pop         0     1 |
  4. |       4        pop         0     1 |
  5. |       5        pop         0     1 |
     |------------------------------------|
  6. |       6        pop         0     1 |
  7. |       7        pop         0     1 |
  8. |       8        pop         0     1 |
  9. |       9        pop         0     1 |
 10. |      10        pop         0     1 |
     +------------------------------------+</code></pre>
</div>
<div id="simulate-the-sampling-of-subjects-2" class="section level4 hasAnchor" number="6.2.2.2">
<h4><span class="header-section-number">6.2.2.2</span> Simulate the sampling of subjects<a href="stata.html#simulate-the-sampling-of-subjects-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now, we simulate the sampling of participants, which results in a table listing each individual and their random effect (a random intercept). To do this, we must sample <span class="math inline">\(t_0\)</span> from a normal distribution.</p>
<p>We will use the function <code>rnormal</code>, which generates a simulated value from a univariate normal distribution with a mean of 0 and a standard deviations of <code>tau_0</code> of each variable.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb99-1"><a href="stata.html#cb99-1" tabindex="-1"></a><span class="co">// simulate a sample of subjects</span></span>
<span id="cb99-2"><a href="stata.html#cb99-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb99-3"><a href="stata.html#cb99-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb99-4"><a href="stata.html#cb99-4" tabindex="-1"></a>  <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">$n_subj</span></span>
<span id="cb99-5"><a href="stata.html#cb99-5" tabindex="-1"></a></span>
<span id="cb99-6"><a href="stata.html#cb99-6" tabindex="-1"></a>  <span class="co">// Generate the by-subject random intercept</span></span>
<span id="cb99-7"><a href="stata.html#cb99-7" tabindex="-1"></a>  <span class="kw">gen</span> t0 = rnormal(0, <span class="ot">$tau_0</span>)</span>
<span id="cb99-8"><a href="stata.html#cb99-8" tabindex="-1"></a></span>
<span id="cb99-9"><a href="stata.html#cb99-9" tabindex="-1"></a>  <span class="co">// Generate a sequence of subject ids</span></span>
<span id="cb99-10"><a href="stata.html#cb99-10" tabindex="-1"></a>  <span class="kw">gen</span> subj_id = <span class="dt">_n</span></span>
<span id="cb99-11"><a href="stata.html#cb99-11" tabindex="-1"></a></span>
<span id="cb99-12"><a href="stata.html#cb99-12" tabindex="-1"></a>  <span class="kw">gen</span> key = 1</span>
<span id="cb99-13"><a href="stata.html#cb99-13" tabindex="-1"></a></span>
<span id="cb99-14"><a href="stata.html#cb99-14" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/subjects.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb99-15"><a href="stata.html#cb99-15" tabindex="-1"></a>}</span>
<span id="cb99-16"><a href="stata.html#cb99-16" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1 / 10</span></code></pre></div>
<pre><code>     |        t0   subj_id   key |
     |---------------------------|
  1. |  4.356949         1     1 |
  2. |  .0887434         2     1 |
  3. |  .1867903         3     1 |
  4. |  11.24607         4     1 |
  5. | -1.842066         5     1 |
     |---------------------------|
  6. |  1.966723         6     1 |
  7. |  2.544997         7     1 |
  8. | -9.950144         8     1 |
  9. | -8.176116         9     1 |
 10. | -4.609569        10     1 |
     +---------------------------+</code></pre>
</div>
<div id="check-the-simulated-values-2" class="section level4 hasAnchor" number="6.2.2.3">
<h4><span class="header-section-number">6.2.2.3</span> Check the simulated values<a href="stata.html#check-the-simulated-values-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s do a quick sanity check by comparing our simulated values to the parameters we used as inputs. Because the sampling process is stochastic, we shouldn’t expect that these will exactly match for any given run of the simulation.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb101-1"><a href="stata.html#cb101-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb101-2"><a href="stata.html#cb101-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/subjects.dta&quot;</span></span>
<span id="cb101-3"><a href="stata.html#cb101-3" tabindex="-1"></a></span>
<span id="cb101-4"><a href="stata.html#cb101-4" tabindex="-1"></a>  <span class="kw">qui</span> <span class="kw">summarize</span> t0</span>
<span id="cb101-5"><a href="stata.html#cb101-5" tabindex="-1"></a>  <span class="kw">egen</span> tau_0_s = <span class="fu">sd</span>(t0)</span>
<span id="cb101-6"><a href="stata.html#cb101-6" tabindex="-1"></a>}</span>
<span id="cb101-7"><a href="stata.html#cb101-7" tabindex="-1"></a><span class="kw">display</span> <span class="st">&quot;tau_0, &quot;</span> <span class="ot">$tau_0</span> <span class="st">&quot;, &quot;</span> tau_0_s</span></code></pre></div>
<pre><code>tau_0, 7, 7.4337502</code></pre>
</div>
<div id="simulate-trials-2" class="section level4 hasAnchor" number="6.2.2.4">
<h4><span class="header-section-number">6.2.2.4</span> Simulate trials<a href="stata.html#simulate-trials-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Since all subjects rate all songs (i.e., the design is fully crossed), we can set up a table of trials by including every possible combination of the rows in the <code>subjects</code> and <code>songs</code> tables. Each test has a random error associated with it, reflecting fluctuations in trial-by-trial ratings due to unknown factors. We simulate this by sampling values from a univariate normal distribution with a mean of 0 and a standard deviation of <code>sigma</code>.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb103-1"><a href="stata.html#cb103-1" tabindex="-1"></a><span class="co">// cross subject and song IDs; add an error term</span></span>
<span id="cb103-2"><a href="stata.html#cb103-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb103-3"><a href="stata.html#cb103-3" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/subjects.dta&quot;</span></span>
<span id="cb103-4"><a href="stata.html#cb103-4" tabindex="-1"></a>  <span class="kw">cross</span> <span class="kw">using</span> <span class="st">&quot;./data/songs.dta&quot;</span></span>
<span id="cb103-5"><a href="stata.html#cb103-5" tabindex="-1"></a>  <span class="kw">drop</span> key</span>
<span id="cb103-6"><a href="stata.html#cb103-6" tabindex="-1"></a>  <span class="kw">sort</span> subj_id song_id</span>
<span id="cb103-7"><a href="stata.html#cb103-7" tabindex="-1"></a></span>
<span id="cb103-8"><a href="stata.html#cb103-8" tabindex="-1"></a>  <span class="kw">gen</span> e_ij = rnormal(0, <span class="ot">$sigma</span>)</span>
<span id="cb103-9"><a href="stata.html#cb103-9" tabindex="-1"></a></span>
<span id="cb103-10"><a href="stata.html#cb103-10" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/data_sim_tmp.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb103-11"><a href="stata.html#cb103-11" tabindex="-1"></a>}</span>
<span id="cb103-12"><a href="stata.html#cb103-12" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1 / 10</span></code></pre></div>
<pre><code>     |       t0   subj_id   song_id   category   genre_i        e_ij |
     |---------------------------------------------------------------|
  1. | 4.356949         1         1        pop         0    4.979371 |
  2. | 4.356949         1         2        pop         0    .1014211 |
  3. | 4.356949         1         3        pop         0    .2134746 |
  4. | 4.356949         1         4        pop         0    12.85266 |
  5. | 4.356949         1         5        pop         0   -2.105218 |
     |---------------------------------------------------------------|
  6. | 4.356949         1         6        pop         0    2.247684 |
  7. | 4.356949         1         7        pop         0    2.908567 |
  8. | 4.356949         1         8        pop         0   -11.37159 |
  9. | 4.356949         1         9        pop         0   -9.344132 |
 10. | 4.356949         1        10        pop         0   -5.268079 |
     +---------------------------------------------------------------+</code></pre>
</div>
<div id="calculate-response-values-2" class="section level4 hasAnchor" number="6.2.2.5">
<h4><span class="header-section-number">6.2.2.5</span> Calculate response values<a href="stata.html#calculate-response-values-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>With this resulting <code>trials</code> table, in combination with the constants <code>beta_0</code> and <code>beta_1</code>, we have the full set of values that we need to compute the response variable <code>liking_ij</code> according to the linear model we defined previously (see <a href="./power-of-what.html">Power of What?</a>).</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb105-1"><a href="stata.html#cb105-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb105-2"><a href="stata.html#cb105-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/data_sim_tmp.dta&quot;</span></span>
<span id="cb105-3"><a href="stata.html#cb105-3" tabindex="-1"></a></span>
<span id="cb105-4"><a href="stata.html#cb105-4" tabindex="-1"></a>  <span class="kw">gen</span> liking_ij = <span class="ot">$beta_0</span> + t0 +  <span class="ot">$beta_1</span>  * genre_i + e_ij</span>
<span id="cb105-5"><a href="stata.html#cb105-5" tabindex="-1"></a>  <span class="kw">keep</span> subj_id song_id category genre_i liking_ij</span>
<span id="cb105-6"><a href="stata.html#cb105-6" tabindex="-1"></a></span>
<span id="cb105-7"><a href="stata.html#cb105-7" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/data_sim.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb105-8"><a href="stata.html#cb105-8" tabindex="-1"></a>}</span>
<span id="cb105-9"><a href="stata.html#cb105-9" tabindex="-1"></a><span class="ot">list</span> <span class="kw">in</span> 1 / 10</span></code></pre></div>
<pre><code>     | subj_id   song_id   category   genre_i   liking~j |
     |---------------------------------------------------|
  1. |       1         1        pop         0   69.33632 |
  2. |       1         2        pop         0   64.45837 |
  3. |       1         3        pop         0   64.57043 |
  4. |       1         4        pop         0    77.2096 |
  5. |       1         5        pop         0   62.25173 |
     |---------------------------------------------------|
  6. |       1         6        pop         0   66.60463 |
  7. |       1         7        pop         0   67.26552 |
  8. |       1         8        pop         0   52.98536 |
  9. |       1         9        pop         0   55.01282 |
 10. |       1        10        pop         0   59.08887 |
     +---------------------------------------------------+</code></pre>
</div>
<div id="plot-the-data-2" class="section level4 hasAnchor" number="6.2.2.6">
<h4><span class="header-section-number">6.2.2.6</span> Plot the data<a href="stata.html#plot-the-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s visualize the distribution of the response variable for each of the two song genres and superimpose the simulated parameter estimates for the means of these two groups.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb107-1"><a href="stata.html#cb107-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb107-2"><a href="stata.html#cb107-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/data_sim.dta&quot;</span></span>
<span id="cb107-3"><a href="stata.html#cb107-3" tabindex="-1"></a></span>
<span id="cb107-4"><a href="stata.html#cb107-4" tabindex="-1"></a>  <span class="co">// Set the palette colors</span></span>
<span id="cb107-5"><a href="stata.html#cb107-5" tabindex="-1"></a>  <span class="kw">local</span> <span class="kw">palette</span> <span class="st">&quot;orange dodgerblue&quot;</span></span>
<span id="cb107-6"><a href="stata.html#cb107-6" tabindex="-1"></a></span>
<span id="cb107-7"><a href="stata.html#cb107-7" tabindex="-1"></a>  <span class="co">// Create a violin plot for actual data</span></span>
<span id="cb107-8"><a href="stata.html#cb107-8" tabindex="-1"></a>  violinplot liking_ij, <span class="bn">over</span>(category) colors(<span class="ot">`palette&#39;</span>) vertical <span class="kw">mean</span>(<span class="dv">type</span>(<span class="kw">line</span>) lp(<span class="kw">dash</span>) stat(<span class="kw">mean</span>)) <span class="bn">title</span>(<span class="st">&quot;Predicted versus simulated values&quot;</span>)</span>
<span id="cb107-9"><a href="stata.html#cb107-9" tabindex="-1"></a>  <span class="kw">graph</span> <span class="kw">export</span> <span class="st">&quot;./figures/violin.png&quot;</span>, <span class="kw">replace</span></span>
<span id="cb107-10"><a href="stata.html#cb107-10" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="figures/violin.png" /></p>
</div>
</div>
<div id="analyze-the-simulated-data-2" class="section level3 hasAnchor" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Analyze the simulated data<a href="stata.html#analyze-the-simulated-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now we can analyze our simulated data in a linear mixed effects model using the function <code>mixed</code>. The model formula in <code>mixed</code> maps how we calculated our <code>liking_ij</code> outcome variable above.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb108-1"><a href="stata.html#cb108-1" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">use</span> <span class="st">&quot;./data/data_sim_tmp.dta&quot;</span></span>
<span id="cb108-2"><a href="stata.html#cb108-2" tabindex="-1"></a>mixed liking_ij genre_i || subj_id:</span>
<span id="cb108-3"><a href="stata.html#cb108-3" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">estimates</span> <span class="kw">save</span> <span class="st">&quot;./data/data_sim_estimates.ster&quot;</span>, <span class="kw">replace</span></span></code></pre></div>
<pre><code>variable liking_ij not found
r(111);

end of do-file
r(111);</code></pre>
<p>The terms in the formula are as follows:</p>
<ul>
<li><code>liking_ij</code> is the response.</li>
<li><code>genre_i</code> is the dummy coded variable identifying whether song <span class="math inline">\(i\)</span> belongs to the pop or rock genre.</li>
<li><code>|| subj_id</code> specified a subject-specific random intercept (<code>t0</code>)</li>
</ul>
<p>Now we can estimate the model.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb110-1"><a href="stata.html#cb110-1" tabindex="-1"></a><span class="kw">quietly</span> <span class="kw">estimates</span> <span class="kw">use</span> <span class="st">&quot;./data/data_sim_estimates.ster&quot;</span></span>
<span id="cb110-2"><a href="stata.html#cb110-2" tabindex="-1"></a><span class="kw">quietly</span> <span class="fu">matrix</span> b = <span class="fu">e</span>(b)</span>
<span id="cb110-3"><a href="stata.html#cb110-3" tabindex="-1"></a><span class="fu">matrix</span> <span class="ot">list</span> b</span></code></pre></div>
<pre><code>b[1,4]
     liking_ij:  liking_ij:   lns1_1_1:    lnsig_e:
       genre_i       _cons       _cons       _cons
y1   5.1710617   60.229571   2.0205456   2.0902013</code></pre>
</div>
</div>
<div id="data-simulation-automated-2" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Data simulation automated<a href="stata.html#data-simulation-automated-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we’ve tested the data-generating code, we can put it into a function so that it’s easy to run it repeatedly.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb112-1"><a href="stata.html#cb112-1" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> sim_data</span>
<span id="cb112-2"><a href="stata.html#cb112-2" tabindex="-1"></a><span class="kw">program</span> <span class="kw">define</span> sim_data</span>
<span id="cb112-3"><a href="stata.html#cb112-3" tabindex="-1"></a>    <span class="kw">args</span> n_subj n_pop n_rock beta_0 beta_1 tau_0 sigma</span>
<span id="cb112-4"><a href="stata.html#cb112-4" tabindex="-1"></a></span>
<span id="cb112-5"><a href="stata.html#cb112-5" tabindex="-1"></a>  <span class="co">// simulate a sample of songs</span></span>
<span id="cb112-6"><a href="stata.html#cb112-6" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb112-7"><a href="stata.html#cb112-7" tabindex="-1"></a>    <span class="kw">local</span> n_all = <span class="ot">`n_pop&#39;</span> + <span class="ot">`n_rock&#39;</span></span>
<span id="cb112-8"><a href="stata.html#cb112-8" tabindex="-1"></a>    <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">`n_all&#39;</span></span>
<span id="cb112-9"><a href="stata.html#cb112-9" tabindex="-1"></a>    <span class="kw">gen</span> song_id = <span class="dt">_n</span></span>
<span id="cb112-10"><a href="stata.html#cb112-10" tabindex="-1"></a>    <span class="kw">gen</span> category = <span class="st">&quot;pop&quot;</span></span>
<span id="cb112-11"><a href="stata.html#cb112-11" tabindex="-1"></a>    <span class="kw">replace</span> category = <span class="st">&quot;rock&quot;</span> <span class="kw">if</span> song_id &gt; <span class="ot">`n_pop&#39;</span></span>
<span id="cb112-12"><a href="stata.html#cb112-12" tabindex="-1"></a>    <span class="kw">gen</span> genre_i = 0</span>
<span id="cb112-13"><a href="stata.html#cb112-13" tabindex="-1"></a>    <span class="kw">replace</span> genre_i = 1 <span class="kw">if</span> song_id &gt; <span class="ot">`n_pop&#39;</span></span>
<span id="cb112-14"><a href="stata.html#cb112-14" tabindex="-1"></a>    <span class="kw">gen</span> key = 1</span>
<span id="cb112-15"><a href="stata.html#cb112-15" tabindex="-1"></a>    <span class="kw">save</span> <span class="st">&quot;./data/songs.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb112-16"><a href="stata.html#cb112-16" tabindex="-1"></a></span>
<span id="cb112-17"><a href="stata.html#cb112-17" tabindex="-1"></a>  <span class="co">// simulate a sample of subjects</span></span>
<span id="cb112-18"><a href="stata.html#cb112-18" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb112-19"><a href="stata.html#cb112-19" tabindex="-1"></a>    <span class="kw">set</span> <span class="kw">obs</span> <span class="ot">`n_subj&#39;</span></span>
<span id="cb112-20"><a href="stata.html#cb112-20" tabindex="-1"></a></span>
<span id="cb112-21"><a href="stata.html#cb112-21" tabindex="-1"></a>    <span class="kw">gen</span> t0 = rnormal(0, <span class="ot">`tau_0&#39;</span>)</span>
<span id="cb112-22"><a href="stata.html#cb112-22" tabindex="-1"></a>    <span class="kw">gen</span> subj_id = <span class="dt">_n</span></span>
<span id="cb112-23"><a href="stata.html#cb112-23" tabindex="-1"></a>    <span class="kw">gen</span> key = 1</span>
<span id="cb112-24"><a href="stata.html#cb112-24" tabindex="-1"></a>    <span class="kw">save</span> <span class="st">&quot;./data/subjects.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb112-25"><a href="stata.html#cb112-25" tabindex="-1"></a></span>
<span id="cb112-26"><a href="stata.html#cb112-26" tabindex="-1"></a>  <span class="co">// cross subject and song IDs</span></span>
<span id="cb112-27"><a href="stata.html#cb112-27" tabindex="-1"></a>    <span class="kw">use</span> <span class="st">&quot;./data/subjects.dta&quot;</span></span>
<span id="cb112-28"><a href="stata.html#cb112-28" tabindex="-1"></a>    <span class="kw">cross</span> <span class="kw">using</span> <span class="st">&quot;./data/songs.dta&quot;</span></span>
<span id="cb112-29"><a href="stata.html#cb112-29" tabindex="-1"></a>    <span class="kw">drop</span> key</span>
<span id="cb112-30"><a href="stata.html#cb112-30" tabindex="-1"></a>    <span class="kw">sort</span> subj_id song_id</span>
<span id="cb112-31"><a href="stata.html#cb112-31" tabindex="-1"></a>    <span class="kw">gen</span> e_ij = rnormal(0, <span class="ot">`sigma&#39;</span>)</span>
<span id="cb112-32"><a href="stata.html#cb112-32" tabindex="-1"></a></span>
<span id="cb112-33"><a href="stata.html#cb112-33" tabindex="-1"></a>    <span class="kw">gen</span> liking_ij = <span class="ot">`beta_0&#39;</span> + t0 + <span class="ot">`beta_1&#39;</span> * genre_i + e_ij</span>
<span id="cb112-34"><a href="stata.html#cb112-34" tabindex="-1"></a>    <span class="kw">keep</span> subj_id song_id category genre_i liking_ij</span>
<span id="cb112-35"><a href="stata.html#cb112-35" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<div id="power-calculation-single-run-2" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Power calculation single run<a href="stata.html#power-calculation-single-run-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can wrap the data-generating function and modeling code in a new function <code>single_run()</code> that returns the analysis results for a single simulation run. We’ll suppress warnings and messages from the modeling fitting process, as these sometimes occur with simulation runs that generate extremely realized values for parameters.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb113-1"><a href="stata.html#cb113-1" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> single_run</span>
<span id="cb113-2"><a href="stata.html#cb113-2" tabindex="-1"></a><span class="kw">program</span> <span class="kw">define</span> single_run, rclass</span>
<span id="cb113-3"><a href="stata.html#cb113-3" tabindex="-1"></a>    <span class="kw">args</span> n_subj n_pop n_rock beta_0 beta_1 tau_0 sigma</span>
<span id="cb113-4"><a href="stata.html#cb113-4" tabindex="-1"></a></span>
<span id="cb113-5"><a href="stata.html#cb113-5" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb113-6"><a href="stata.html#cb113-6" tabindex="-1"></a>    sim_data <span class="ot">`n_subj&#39;</span> <span class="ot">`n_pop&#39;</span> <span class="ot">`n_rock&#39;</span> <span class="ot">`beta_0&#39;</span> <span class="ot">`beta_1&#39;</span> <span class="ot">`tau_0&#39;</span> <span class="ot">`sigma&#39;</span></span>
<span id="cb113-7"><a href="stata.html#cb113-7" tabindex="-1"></a>    mixed liking_ij genre_i || subj_id:, <span class="kw">noretable</span> <span class="kw">nofetable</span> <span class="kw">noheader</span> <span class="kw">nogroup</span></span>
<span id="cb113-8"><a href="stata.html#cb113-8" tabindex="-1"></a></span>
<span id="cb113-9"><a href="stata.html#cb113-9" tabindex="-1"></a>  <span class="kw">estimates</span> <span class="kw">clear</span></span>
<span id="cb113-10"><a href="stata.html#cb113-10" tabindex="-1"></a>    <span class="kw">estimates</span> <span class="kw">store</span> model_results</span>
<span id="cb113-11"><a href="stata.html#cb113-11" tabindex="-1"></a></span>
<span id="cb113-12"><a href="stata.html#cb113-12" tabindex="-1"></a>  <span class="co">// calculate analysis results</span></span>
<span id="cb113-13"><a href="stata.html#cb113-13" tabindex="-1"></a>    <span class="fu">matrix</span> coefficients = <span class="fu">e</span>(b)</span>
<span id="cb113-14"><a href="stata.html#cb113-14" tabindex="-1"></a>    <span class="fu">matrix</span> std_errors = <span class="fu">e</span>(<span class="kw">V</span>)</span>
<span id="cb113-15"><a href="stata.html#cb113-15" tabindex="-1"></a>    <span class="fu">matrix</span> p_values = <span class="fu">e</span>(<span class="kw">p</span>)</span>
<span id="cb113-16"><a href="stata.html#cb113-16" tabindex="-1"></a></span>
<span id="cb113-17"><a href="stata.html#cb113-17" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">scalar</span> coef = coefficients[1, 1]</span>
<span id="cb113-18"><a href="stata.html#cb113-18" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">scalar</span> std_err = std_errors[1, 1]</span>
<span id="cb113-19"><a href="stata.html#cb113-19" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">scalar</span> p_value = p_values[1, 1]</span>
<span id="cb113-20"><a href="stata.html#cb113-20" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<pre><code>  4.         mixed liking_ij genre_i || subj_id:, noretable nofetable noheader 
&gt; nogroup
  5. </code></pre>
<p>Let’s test that our new <code>single_run()</code> function performs as expected.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb115-1"><a href="stata.html#cb115-1" tabindex="-1"></a><span class="co">// run one model with default parameters</span></span>
<span id="cb115-2"><a href="stata.html#cb115-2" tabindex="-1"></a><span class="kw">quietly</span> single_run 25 15 15 60 5 7 8</span>
<span id="cb115-3"><a href="stata.html#cb115-3" tabindex="-1"></a><span class="fu">return</span> <span class="ot">list</span></span></code></pre></div>
<pre><code>scalars:
            r(p_value) =  6.15504528650e-25
            r(std_err) =  .3467247369073205
               r(coef) =  6.072637593587212</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb117-1"><a href="stata.html#cb117-1" tabindex="-1"></a><span class="co">// run one model with new parameters</span></span>
<span id="cb117-2"><a href="stata.html#cb117-2" tabindex="-1"></a><span class="kw">quietly</span> single_run 25 10 50 60 2 7 8</span>
<span id="cb117-3"><a href="stata.html#cb117-3" tabindex="-1"></a><span class="fu">return</span> <span class="ot">list</span></span></code></pre></div>
<pre><code>scalars:
            r(p_value) =  .000521305877981
            r(std_err) =  .318005651218237
               r(coef) =  1.956555587768456</code></pre>
</div>
<div id="power-calculation-automated-2" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Power calculation automated<a href="stata.html#power-calculation-automated-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To get an accurate estimation of power, we need to run the simulation many times. Here, we use a matrix <code>results</code> to store the analysis results of each run.</p>
<p>We can finally calculate power for our parameter of interest <code>beta_1</code> by filtering to keep only that term and calculating the proportion of times the <span class="math inline">\(p\)</span>-value is below the <code>alpha</code> threshold.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb119-1"><a href="stata.html#cb119-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb119-2"><a href="stata.html#cb119-2" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb119-3"><a href="stata.html#cb119-3" tabindex="-1"></a>  <span class="fu">matrix</span> results = <span class="fu">J</span>(<span class="ot">$reps</span>, 3, .)</span>
<span id="cb119-4"><a href="stata.html#cb119-4" tabindex="-1"></a>  forval i = 1/<span class="ot">$reps</span> {</span>
<span id="cb119-5"><a href="stata.html#cb119-5" tabindex="-1"></a>    <span class="kw">quietly</span> single_run 25 15 15 60 5 7 8</span>
<span id="cb119-6"><a href="stata.html#cb119-6" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 1] = <span class="fu">r</span>(coef)</span>
<span id="cb119-7"><a href="stata.html#cb119-7" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 2] = <span class="fu">r</span>(std_err)</span>
<span id="cb119-8"><a href="stata.html#cb119-8" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 3] = <span class="fu">r</span>(p_value)</span>
<span id="cb119-9"><a href="stata.html#cb119-9" tabindex="-1"></a>  }</span>
<span id="cb119-10"><a href="stata.html#cb119-10" tabindex="-1"></a></span>
<span id="cb119-11"><a href="stata.html#cb119-11" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb119-12"><a href="stata.html#cb119-12" tabindex="-1"></a>  <span class="kw">svmat</span> results, names(x)</span>
<span id="cb119-13"><a href="stata.html#cb119-13" tabindex="-1"></a></span>
<span id="cb119-14"><a href="stata.html#cb119-14" tabindex="-1"></a>  <span class="co">// calculate mean estimates and power for specified alpha</span></span>
<span id="cb119-15"><a href="stata.html#cb119-15" tabindex="-1"></a>  <span class="kw">gen</span> power = 0</span>
<span id="cb119-16"><a href="stata.html#cb119-16" tabindex="-1"></a>  <span class="kw">replace</span> power = 1 <span class="kw">if</span> x3 &lt; <span class="ot">$alpha</span></span>
<span id="cb119-17"><a href="stata.html#cb119-17" tabindex="-1"></a></span>
<span id="cb119-18"><a href="stata.html#cb119-18" tabindex="-1"></a>  <span class="kw">egen</span> coef_mean = <span class="kw">mean</span>(x1)</span>
<span id="cb119-19"><a href="stata.html#cb119-19" tabindex="-1"></a>  <span class="kw">egen</span> std_err_mean = <span class="kw">mean</span>(<span class="kw">x2</span>)</span>
<span id="cb119-20"><a href="stata.html#cb119-20" tabindex="-1"></a>  <span class="kw">egen</span> power_mean = <span class="kw">mean</span>(power)</span>
<span id="cb119-21"><a href="stata.html#cb119-21" tabindex="-1"></a>}</span>
<span id="cb119-22"><a href="stata.html#cb119-22" tabindex="-1"></a></span>
<span id="cb119-23"><a href="stata.html#cb119-23" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Coef. Mean: &quot;</span> coef_mean</span>
<span id="cb119-24"><a href="stata.html#cb119-24" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Std.Err. Mean: &quot;</span> std_err_mean</span>
<span id="cb119-25"><a href="stata.html#cb119-25" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Power Mean: &quot;</span> power_mean</span></code></pre></div>
<pre><code>Coef. Mean: 5.1327767

Std.Err. Mean: .34294486

Power Mean: 1</code></pre>
<div id="check-false-positive-rate-2" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> Check false positive rate<a href="stata.html#check-false-positive-rate-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can do a sanity check to see if our simulation is performing as expected by checking the false positive rate (Type I error rate). We set the effect of <code>genre_ij</code> (<code>beta_1</code>) to 0 to calculate the false positive rate, which is the probability of concluding there is an effect when there is no actual effect in the population.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb121-1"><a href="stata.html#cb121-1" tabindex="-1"></a><span class="co">// run simulations and calculate the false positive rate</span></span>
<span id="cb121-2"><a href="stata.html#cb121-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb121-3"><a href="stata.html#cb121-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb121-4"><a href="stata.html#cb121-4" tabindex="-1"></a>  <span class="fu">matrix</span> results = <span class="fu">J</span>(<span class="ot">$reps</span>, 3, .)</span>
<span id="cb121-5"><a href="stata.html#cb121-5" tabindex="-1"></a>  forval i = 1/<span class="ot">$reps</span> {</span>
<span id="cb121-6"><a href="stata.html#cb121-6" tabindex="-1"></a>    <span class="kw">quietly</span> single_run 25 15 15 60 0 7 8</span>
<span id="cb121-7"><a href="stata.html#cb121-7" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 1] = <span class="fu">r</span>(coef)</span>
<span id="cb121-8"><a href="stata.html#cb121-8" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 2] = <span class="fu">r</span>(std_err)</span>
<span id="cb121-9"><a href="stata.html#cb121-9" tabindex="-1"></a>    <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 3] = <span class="fu">r</span>(p_value)</span>
<span id="cb121-10"><a href="stata.html#cb121-10" tabindex="-1"></a>  }</span>
<span id="cb121-11"><a href="stata.html#cb121-11" tabindex="-1"></a></span>
<span id="cb121-12"><a href="stata.html#cb121-12" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb121-13"><a href="stata.html#cb121-13" tabindex="-1"></a>  <span class="kw">svmat</span> results, names(x)</span>
<span id="cb121-14"><a href="stata.html#cb121-14" tabindex="-1"></a></span>
<span id="cb121-15"><a href="stata.html#cb121-15" tabindex="-1"></a>  <span class="co">// calculate power for specified alpha</span></span>
<span id="cb121-16"><a href="stata.html#cb121-16" tabindex="-1"></a>  <span class="kw">gen</span> power = 0</span>
<span id="cb121-17"><a href="stata.html#cb121-17" tabindex="-1"></a>  <span class="kw">replace</span> power = 1 <span class="kw">if</span> x3 &lt; <span class="ot">$alpha</span></span>
<span id="cb121-18"><a href="stata.html#cb121-18" tabindex="-1"></a></span>
<span id="cb121-19"><a href="stata.html#cb121-19" tabindex="-1"></a>  <span class="kw">egen</span> power_mean = <span class="kw">mean</span>(power)</span>
<span id="cb121-20"><a href="stata.html#cb121-20" tabindex="-1"></a>}</span>
<span id="cb121-21"><a href="stata.html#cb121-21" tabindex="-1"></a></span>
<span id="cb121-22"><a href="stata.html#cb121-22" tabindex="-1"></a><span class="kw">di</span> <span class="st">&quot;Power Mean: &quot;</span> power_mean</span></code></pre></div>
<pre><code>Power Mean: .03333334</code></pre>
<p>Ideally, the false positive rate will be equal to <code>alpha</code>, which we set at 0.05.</p>
</div>
</div>
<div id="power-for-different-effect-sizes-2" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Power for different effect sizes<a href="stata.html#power-for-different-effect-sizes-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In real life, we will not know the effect size of our quantity of interest, and so we will need to repeatedly perform the power analysis over a range of different plausible effect sizes. Perhaps we might also want to calculate power as we vary other data-generating parameters, such as the number of pop and rock songs sampled and the number of subjects sampled. We can create a table that combines all combinations of the parameters we want to vary in a grid.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb123-1"><a href="stata.html#cb123-1" tabindex="-1"></a><span class="co">// grid of parameter values of interest</span></span>
<span id="cb123-2"><a href="stata.html#cb123-2" tabindex="-1"></a><span class="kw">quietly</span> <span class="fu">matrix</span> <span class="kw">define</span> params = (10, 10, 10, 1 \ 10, 10, 10, 2 \ 10, 10, 10, 3 \ 10, 10, 10, 4 \ 10, 10, 10, 5 <span class="co">///</span></span>
<span id="cb123-3"><a href="stata.html#cb123-3" tabindex="-1"></a>\ 10, 10, 40, 1 \ 10, 10, 40, 2 \ 10, 10, 40, 3 \ 10, 10, 40, 4 \ 10, 10, 40, 5 <span class="co">///</span></span>
<span id="cb123-4"><a href="stata.html#cb123-4" tabindex="-1"></a>\ 10, 40, 10, 1 \ 10, 40, 10, 2 \ 10, 40, 10, 3 \ 10, 40, 10, 4 \ 10, 40, 10, 5 <span class="co">///</span></span>
<span id="cb123-5"><a href="stata.html#cb123-5" tabindex="-1"></a>\ 10, 40, 40, 1 \ 10, 40, 40, 2 \ 10, 40, 40, 3 \ 10, 40, 40, 4 \ 10, 40, 40, 5 <span class="co">///</span></span>
<span id="cb123-6"><a href="stata.html#cb123-6" tabindex="-1"></a>\ 25, 10, 10, 1 \ 25, 10, 10, 2 \ 25, 10, 10, 3 \ 25, 10, 10, 4 \ 25, 10, 10, 5 <span class="co">///</span></span>
<span id="cb123-7"><a href="stata.html#cb123-7" tabindex="-1"></a>\ 25, 10, 40, 1 \ 25, 10, 40, 2 \ 25, 10, 40, 3 \ 25, 10, 40, 4 \ 25, 10, 40, 5 <span class="co">///</span></span>
<span id="cb123-8"><a href="stata.html#cb123-8" tabindex="-1"></a>\ 25, 40, 10, 1 \ 25, 40, 10, 2 \ 25, 40, 10, 3 \ 25, 40, 10, 4 \ 25, 40, 10, 5 <span class="co">///</span></span>
<span id="cb123-9"><a href="stata.html#cb123-9" tabindex="-1"></a>\ 25, 40, 40, 1 \ 25, 40, 40, 2 \ 25, 40, 40, 3 \ 25, 40, 40, 4 \ 25, 40, 40, 5 <span class="co">///</span></span>
<span id="cb123-10"><a href="stata.html#cb123-10" tabindex="-1"></a>\ 50, 10, 10, 1 \ 50, 10, 10, 2 \ 50, 10, 10, 3 \ 50, 10, 10, 4 \ 50, 10, 10, 5 <span class="co">///</span></span>
<span id="cb123-11"><a href="stata.html#cb123-11" tabindex="-1"></a>\ 50, 10, 40, 1 \ 50, 10, 40, 2 \ 50, 10, 40, 3 \ 50, 10, 40, 4 \ 50, 10, 40, 5 <span class="co">///</span></span>
<span id="cb123-12"><a href="stata.html#cb123-12" tabindex="-1"></a>\ 50, 40, 10, 1 \ 50, 40, 10, 2 \ 50, 40, 10, 3 \ 50, 40, 10, 4 \ 50, 40, 10, 5 <span class="co">///</span></span>
<span id="cb123-13"><a href="stata.html#cb123-13" tabindex="-1"></a>\ 50, 40, 40, 1 \ 50, 40, 40, 2 \ 50, 40, 40, 3 \ 50, 40, 40, 4 \ 50, 40, 40, 5)</span></code></pre></div>
<p>We can now wrap our <code>single_run()</code> function within a more general function <code>parameter_search()</code> that takes the grid of parameter values as input and uses a matrix <code>results</code> to store the analysis results of each <code>single_run()</code>.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb124-1"><a href="stata.html#cb124-1" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> parameter_search</span>
<span id="cb124-2"><a href="stata.html#cb124-2" tabindex="-1"></a><span class="kw">program</span> <span class="kw">define</span> parameter_search, rclass</span>
<span id="cb124-3"><a href="stata.html#cb124-3" tabindex="-1"></a>    <span class="kw">args</span> params</span>
<span id="cb124-4"><a href="stata.html#cb124-4" tabindex="-1"></a></span>
<span id="cb124-5"><a href="stata.html#cb124-5" tabindex="-1"></a>    <span class="kw">local</span> <span class="bn">rows</span> = <span class="fu">rowsof</span>(params)</span>
<span id="cb124-6"><a href="stata.html#cb124-6" tabindex="-1"></a>    <span class="fu">matrix</span> results = <span class="fu">J</span>(<span class="ot">`rows&#39;</span>, 7, .)</span>
<span id="cb124-7"><a href="stata.html#cb124-7" tabindex="-1"></a></span>
<span id="cb124-8"><a href="stata.html#cb124-8" tabindex="-1"></a>    forval i = 1/<span class="ot">`rows&#39;</span> {</span>
<span id="cb124-9"><a href="stata.html#cb124-9" tabindex="-1"></a>        <span class="kw">local</span> n_subj = params[<span class="ot">`i&#39;</span>, 1]</span>
<span id="cb124-10"><a href="stata.html#cb124-10" tabindex="-1"></a>        <span class="kw">local</span> n_pop = params[<span class="ot">`i&#39;</span>, 2]</span>
<span id="cb124-11"><a href="stata.html#cb124-11" tabindex="-1"></a>        <span class="kw">local</span> n_rock = params[<span class="ot">`i&#39;</span>, 3]</span>
<span id="cb124-12"><a href="stata.html#cb124-12" tabindex="-1"></a>        <span class="kw">local</span> beta_1 = params[<span class="ot">`i&#39;</span>, 4]</span>
<span id="cb124-13"><a href="stata.html#cb124-13" tabindex="-1"></a></span>
<span id="cb124-14"><a href="stata.html#cb124-14" tabindex="-1"></a>        single_run <span class="ot">`n_subj&#39;</span> <span class="ot">`n_pop&#39;</span> <span class="ot">`n_rock&#39;</span> 60 <span class="ot">`beta_1&#39;</span> 7 8</span>
<span id="cb124-15"><a href="stata.html#cb124-15" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 1] = <span class="ot">`n_subj&#39;</span></span>
<span id="cb124-16"><a href="stata.html#cb124-16" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 2] = <span class="ot">`n_pop&#39;</span></span>
<span id="cb124-17"><a href="stata.html#cb124-17" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 3] = <span class="ot">`n_rock&#39;</span></span>
<span id="cb124-18"><a href="stata.html#cb124-18" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 4] = <span class="ot">`beta_1&#39;</span></span>
<span id="cb124-19"><a href="stata.html#cb124-19" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 5] = <span class="fu">r</span>(coef)</span>
<span id="cb124-20"><a href="stata.html#cb124-20" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 6] = <span class="fu">r</span>(std_err)</span>
<span id="cb124-21"><a href="stata.html#cb124-21" tabindex="-1"></a>        <span class="fu">matrix</span> results[<span class="ot">`i&#39;</span>, 7] = <span class="fu">r</span>(p_value)</span>
<span id="cb124-22"><a href="stata.html#cb124-22" tabindex="-1"></a>    }</span>
<span id="cb124-23"><a href="stata.html#cb124-23" tabindex="-1"></a></span>
<span id="cb124-24"><a href="stata.html#cb124-24" tabindex="-1"></a>    <span class="fu">return</span> <span class="fu">matrix</span> RE results</span>
<span id="cb124-25"><a href="stata.html#cb124-25" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>If we call <code>parameter_search()</code> it will return a single replication of simulations for each combination of parameter values in <code>params</code>.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb125-1"><a href="stata.html#cb125-1" tabindex="-1"></a><span class="kw">quietly</span> parameter_search params</span>
<span id="cb125-2"><a href="stata.html#cb125-2" tabindex="-1"></a><span class="fu">return</span> <span class="ot">list</span></span>
<span id="cb125-3"><a href="stata.html#cb125-3" tabindex="-1"></a><span class="fu">matrix</span> <span class="ot">list</span> <span class="fu">r</span>(RE)</span></code></pre></div>
<pre><code>matrices:
                 r(RE) :  60 x 7


r(RE)[60,7]
            c1         c2         c3         c4         c5         c6
 r1         10         10         10          1  2.0767703  1.3290591
 r2         10         10         10          2  .62064529  1.1411167
 r3         10         10         10          3  3.2051462  1.3930413
 r4         10         10         10          4  2.5571848  1.3892114
 r5         10         10         10          5  6.6856051  1.4763299
 r6         10         10         40          1  1.5987428  .83724974
 r7         10         10         40          2  2.6229231  .79420778
 r8         10         10         40          3  3.1869321   .7857458
 r9         10         10         40          4  3.6704681  .74732381
r10         10         10         40          5  5.4704365  .77949362
r11         10         40         10          1  2.2633134  .89868119
r12         10         40         10          2  2.6807894  .84989613
r13         10         40         10          3  4.5684848  .78929499
r14         10         40         10          4  4.0980586  .82437518
r15         10         40         10          5  4.7150011  .74640408
r16         10         40         40          1  .81983679  .35818376
r17         10         40         40          2  1.5840674  .32607948
r18         10         40         40          3  3.1854328  .32937222
r19         10         40         40          4   4.519555  .30852233
r20         10         40         40          5   5.364586  .33542361
r21         25         10         10          1  1.3821919  .50011368
r22         25         10         10          2  .90685745  .48654647
r23         25         10         10          3  2.2015396  .54055836
r24         25         10         10          4  4.0424014  .51098122
r25         25         10         10          5  4.7957371  .50273713
r26         25         10         40          1  1.2478584  .33050679
r27         25         10         40          2  2.0108924  .30820396
r28         25         10         40          3  2.6370676  .31890292
r29         25         10         40          4  4.8110402   .3149082
r30         25         10         40          5  4.8646795  .32617716
r31         25         40         10          1  .62202797  .30721533
r32         25         40         10          2  2.4312455  .33297658
r33         25         40         10          3  3.0815587  .31753019
r34         25         40         10          4   4.358412  .32801022
r35         25         40         10          5  4.7545508  .31512113
r36         25         40         40          1  1.1845128  .12694719
r37         25         40         40          2  1.9192859  .12666322
r38         25         40         40          3  3.1466376  .12789099
r39         25         40         40          4   4.011289  .12794187
r40         25         40         40          5  4.6528025  .13191323
r41         50         10         10          1  1.0968133  .25114203
r42         50         10         10          2  1.8459916  .24536956
r43         50         10         10          3  2.5134481  .27698685
r44         50         10         10          4  3.9934688  .26265935
r45         50         10         10          5   5.550354  .27162128
r46         50         10         40          1   .8059052  .15170351
r47         50         10         40          2  2.1912051  .16397648
r48         50         10         40          3  2.8441802  .15442357
r49         50         10         40          4  3.7818822  .15977438
r50         50         10         40          5  5.0424808  .15956679
r51         50         40         10          1    -.06306  .15992571
r52         50         40         10          2  2.0112829  .15796861
r53         50         40         10          3  3.1048406  .16241303
r54         50         40         10          4  4.4309891  .15874512
r55         50         40         10          5   4.697969  .16744383
r56         50         40         40          1  1.0014537  .06765406
r57         50         40         40          2  2.0857039  .06470816
r58         50         40         40          3  2.6670335  .06178508
r59         50         40         40          4  3.8384164  .06603957
r60         50         40         40          5  4.8219271  .06276692

            c7
 r1  .07163583
 r2  .56123837
 r3  .00661557
 r4  .03003782
 r5  3.747e-08
 r6  .08059674
 r7  .00324848
 r8  .00032405
 r9  .00002177
r10  5.789e-10
r11  .01696379
r12  .00363862
r13  2.715e-07
r14  6.376e-06
r15  4.828e-08
r16   .1707323
r17  .00553657
r18  2.850e-08
r19  4.059e-16
r20  1.993e-20
r21  .05064301
r22  .19356659
r23  .00275014
r24  1.558e-08
r25  1.345e-11
r26   .0299632
r27  .00029213
r28  3.016e-06
r29  1.006e-17
r30  1.626e-17
r31  .26175742
r32  .00002517
r33  4.535e-08
r34  2.741e-14
r35  2.459e-17
r36  .00088573
r37  6.937e-08
r38  1.382e-18
r39  3.464e-29
r40  1.430e-37
r41   .0286235
r42  .00019404
r43  1.791e-06
r44  6.591e-15
r45  1.749e-26
r46  .03853462
r47  6.261e-08
r48  4.564e-13
r49  3.039e-21
r50  1.571e-36
r51  .87470376
r52  4.183e-07
r53  1.316e-14
r54  9.897e-29
r55  1.646e-30
r56  .00011802
r57  2.419e-16
r58  7.385e-27
r59  1.906e-50
r60  1.506e-82</code></pre>
<p>Then we just repeatedly call <code>parameter_search()</code> for the number of times specified by <code>reps</code> and store the result in a matrix <code>final_results</code>. Fair warning: this will take some time if you have set a high number of replications!</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb127-1"><a href="stata.html#cb127-1" tabindex="-1"></a><span class="co">// replicate the parameter search many times</span></span>
<span id="cb127-2"><a href="stata.html#cb127-2" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb127-3"><a href="stata.html#cb127-3" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb127-4"><a href="stata.html#cb127-4" tabindex="-1"></a>  <span class="fu">matrix</span> final_results = <span class="fu">J</span>(1, 7, .)</span>
<span id="cb127-5"><a href="stata.html#cb127-5" tabindex="-1"></a>  forval i = 1/<span class="ot">$reps</span> {</span>
<span id="cb127-6"><a href="stata.html#cb127-6" tabindex="-1"></a>    <span class="kw">quietly</span> parameter_search params</span>
<span id="cb127-7"><a href="stata.html#cb127-7" tabindex="-1"></a></span>
<span id="cb127-8"><a href="stata.html#cb127-8" tabindex="-1"></a>    <span class="fu">matrix</span> final_results = final_results \ <span class="fu">r</span>(RE)</span>
<span id="cb127-9"><a href="stata.html#cb127-9" tabindex="-1"></a>  }</span>
<span id="cb127-10"><a href="stata.html#cb127-10" tabindex="-1"></a></span>
<span id="cb127-11"><a href="stata.html#cb127-11" tabindex="-1"></a>  <span class="co">// rename the columns</span></span>
<span id="cb127-12"><a href="stata.html#cb127-12" tabindex="-1"></a>  <span class="kw">clear</span></span>
<span id="cb127-13"><a href="stata.html#cb127-13" tabindex="-1"></a>  <span class="kw">svmat</span> final_results, names(final_results)</span>
<span id="cb127-14"><a href="stata.html#cb127-14" tabindex="-1"></a>  <span class="kw">rename</span> final_results1 n_subj</span>
<span id="cb127-15"><a href="stata.html#cb127-15" tabindex="-1"></a>  <span class="kw">rename</span> final_results2 n_pop</span>
<span id="cb127-16"><a href="stata.html#cb127-16" tabindex="-1"></a>  <span class="kw">rename</span> final_results3 n_rock</span>
<span id="cb127-17"><a href="stata.html#cb127-17" tabindex="-1"></a>  <span class="kw">rename</span> final_results4 beta_1</span>
<span id="cb127-18"><a href="stata.html#cb127-18" tabindex="-1"></a>  <span class="kw">rename</span> final_results5 mean_estimate</span>
<span id="cb127-19"><a href="stata.html#cb127-19" tabindex="-1"></a>  <span class="kw">rename</span> final_results6 mean_se</span>
<span id="cb127-20"><a href="stata.html#cb127-20" tabindex="-1"></a>  <span class="kw">rename</span> final_results7 p_value</span>
<span id="cb127-21"><a href="stata.html#cb127-21" tabindex="-1"></a>  <span class="kw">drop</span> <span class="kw">in</span> 1</span>
<span id="cb127-22"><a href="stata.html#cb127-22" tabindex="-1"></a></span>
<span id="cb127-23"><a href="stata.html#cb127-23" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/final_results.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb127-24"><a href="stata.html#cb127-24" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, as before, we can calculate power. But this time, we’ll group by all of the parameters we manipulated in <code>pgrid</code>, so that we can get power estimates for all combinations of parameter values.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb128-1"><a href="stata.html#cb128-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb128-2"><a href="stata.html#cb128-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/final_results.dta&quot;</span></span>
<span id="cb128-3"><a href="stata.html#cb128-3" tabindex="-1"></a></span>
<span id="cb128-4"><a href="stata.html#cb128-4" tabindex="-1"></a>  <span class="kw">gen</span> power = 0</span>
<span id="cb128-5"><a href="stata.html#cb128-5" tabindex="-1"></a>  <span class="kw">replace</span> power = 1 <span class="kw">if</span> p_value &lt; <span class="ot">$alpha</span></span>
<span id="cb128-6"><a href="stata.html#cb128-6" tabindex="-1"></a></span>
<span id="cb128-7"><a href="stata.html#cb128-7" tabindex="-1"></a>  <span class="kw">drop</span> p_value</span>
<span id="cb128-8"><a href="stata.html#cb128-8" tabindex="-1"></a></span>
<span id="cb128-9"><a href="stata.html#cb128-9" tabindex="-1"></a>  <span class="kw">collapse</span> (<span class="kw">mean</span>) mean_estimate mean_se power, <span class="kw">by</span>(n_subj n_pop n_rock beta_1)</span>
<span id="cb128-10"><a href="stata.html#cb128-10" tabindex="-1"></a></span>
<span id="cb128-11"><a href="stata.html#cb128-11" tabindex="-1"></a>  <span class="kw">save</span> <span class="st">&quot;./data/sims_table.dta&quot;</span>, <span class="kw">replace</span></span>
<span id="cb128-12"><a href="stata.html#cb128-12" tabindex="-1"></a>}</span>
<span id="cb128-13"><a href="stata.html#cb128-13" tabindex="-1"></a><span class="ot">list</span></span></code></pre></div>
<pre><code>     | n_subj   n_pop   n_rock   beta_1   mean_e~e    mean_se      power |
     |-------------------------------------------------------------------|
  1. |     10      10       10        1   1.268973   1.238123   .2333333 |
  2. |     10      10       10        2   1.889742   1.235582         .4 |
  3. |     10      10       10        3   2.683959   1.239035   .6333333 |
  4. |     10      10       10        4   4.400897   1.289458          1 |
  5. |     10      10       10        5   5.275087   1.243694          1 |
     |-------------------------------------------------------------------|
  6. |     10      10       40        1   1.014274   .7960495   .1666667 |
  7. |     10      10       40        2   1.988628   .8059257         .6 |
  8. |     10      10       40        3    2.97399   .8001856          1 |
  9. |     10      10       40        4   3.996796   .7847906          1 |
 10. |     10      10       40        5   4.943249   .8100024          1 |
     |-------------------------------------------------------------------|
 11. |     10      40       10        1   1.049238   .7958079         .2 |
 12. |     10      40       10        2   1.768396   .8269665   .5333334 |
 13. |     10      40       10        3   3.041028   .7862483   .8666667 |
 14. |     10      40       10        4   4.262085   .8037483          1 |
 15. |     10      40       10        5   5.404449   .7965609          1 |
     |-------------------------------------------------------------------|
 16. |     10      40       40        1   .9648004   .3186095         .4 |
 17. |     10      40       40        2   2.164498     .31894          1 |
 18. |     10      40       40        3   2.994144   .3153042          1 |
 19. |     10      40       40        4   4.117634   .3245635          1 |
 20. |     10      40       40        5   4.947803   .3222156          1 |
     |-------------------------------------------------------------------|
 21. |     25      10       10        1   1.009122   .5089009   .2666667 |
 22. |     25      10       10        2    2.01162   .5161048   .7666667 |
 23. |     25      10       10        3   2.849991   .5214418          1 |
 24. |     25      10       10        4   4.013868    .510223          1 |
 25. |     25      10       10        5   5.058398   .5018378          1 |
     |-------------------------------------------------------------------|
 26. |     25      10       40        1   1.091378   .3221848   .5333334 |
 27. |     25      10       40        2   1.758242   .3150428   .8333333 |
 28. |     25      10       40        3   2.941761   .3189749          1 |
 29. |     25      10       40        4   4.100368   .3209341          1 |
 30. |     25      10       40        5   4.905522   .3202905          1 |
     |-------------------------------------------------------------------|
 31. |     25      40       10        1   .9354665   .3251629   .3333333 |
 32. |     25      40       10        2   2.089087   .3190893   .9666666 |
 33. |     25      40       10        3   3.008885   .3194447          1 |
 34. |     25      40       10        4   4.040331   .3203337          1 |
 35. |     25      40       10        5   4.991682   .3226803          1 |
     |-------------------------------------------------------------------|
 36. |     25      40       40        1   1.077446   .1273965   .8666667 |
 37. |     25      40       40        2    1.97645   .1276043          1 |
 38. |     25      40       40        3   2.928479   .1292938          1 |
 39. |     25      40       40        4   4.038676   .1287591          1 |
 40. |     25      40       40        5   5.002239   .1278136          1 |
     |-------------------------------------------------------------------|
 41. |     50      10       10        1   .9126882   .2530858         .5 |
 42. |     50      10       10        2    2.00245   .2595248          1 |
 43. |     50      10       10        3    3.04136    .258838          1 |
 44. |     50      10       10        4   3.974287   .2553087          1 |
 45. |     50      10       10        5   5.205029   .2573906          1 |
     |-------------------------------------------------------------------|
 46. |     50      10       40        1   1.030129   .1595967   .7666667 |
 47. |     50      10       40        2   1.991586   .1598501          1 |
 48. |     50      10       40        3   3.040545   .1619374          1 |
 49. |     50      10       40        4   3.960105    .159726          1 |
 50. |     50      10       40        5   4.958652    .159858          1 |
     |-------------------------------------------------------------------|
 51. |     50      40       10        1   .9377397   .1599206   .6666667 |
 52. |     50      40       10        2   2.048419   .1587613          1 |
 53. |     50      40       10        3   2.945178   .1593941          1 |
 54. |     50      40       10        4    4.02575     .15889          1 |
 55. |     50      40       10        5   4.963776   .1594315          1 |
     |-------------------------------------------------------------------|
 56. |     50      40       40        1    1.04931    .064062   .9666666 |
 57. |     50      40       40        2   2.004742   .0637963          1 |
 58. |     50      40       40        3   2.927157   .0643362          1 |
 59. |     50      40       40        4    3.90757   .0640075          1 |
 60. |     50      40       40        5   5.028903   .0638838          1 |
     +-------------------------------------------------------------------+</code></pre>
<p>Here’s a graph that visualizes the output of the power simulation.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb130-1"><a href="stata.html#cb130-1" tabindex="-1"></a><span class="kw">quietly</span> {</span>
<span id="cb130-2"><a href="stata.html#cb130-2" tabindex="-1"></a>  <span class="kw">use</span> <span class="st">&quot;./data/sims_table.dta&quot;</span></span>
<span id="cb130-3"><a href="stata.html#cb130-3" tabindex="-1"></a></span>
<span id="cb130-4"><a href="stata.html#cb130-4" tabindex="-1"></a>  <span class="kw">twoway</span> (connected power beta_1 <span class="kw">if</span> n_subj == 10, <span class="kw">sort</span>) (connected power beta_1 <span class="kw">if</span> n_subj == 25, <span class="kw">sort</span>) (connected power beta_1 <span class="kw">if</span> n_subj == 50, <span class="kw">sort</span>), <span class="dv">scheme</span>(s2color) <span class="kw">by</span>(n_pop n_rock) <span class="bn">legend</span>(lab(1 <span class="st">&quot;sample_size = 10&quot;</span>) lab(2 <span class="st">&quot;sample_size = 25&quot;</span>) lab(3 <span class="st">&quot;sample_size = 50&quot;</span>))</span>
<span id="cb130-5"><a href="stata.html#cb130-5" tabindex="-1"></a></span>
<span id="cb130-6"><a href="stata.html#cb130-6" tabindex="-1"></a>  <span class="kw">graph</span> <span class="kw">export</span> <span class="st">&quot;./figures/twoway.png&quot;</span>, <span class="kw">replace</span></span>
<span id="cb130-7"><a href="stata.html#cb130-7" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="figures/twoway.png" /></p>

</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="python.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="software-comparison.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/hlmshtj-dan/Simulation-Power/edit/main/06_Stata.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["dss-powersim.pdf", "dss-powersim.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
